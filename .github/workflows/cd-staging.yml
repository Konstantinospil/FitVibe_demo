name: CD Staging

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  push:
    branches: ["stage"]

permissions:
  contents: read
  id-token: write

jobs:
  get-artifacts:
    name: Get CI Artifacts
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/stage') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.head_branch == 'stage' &&
       github.event.workflow_run.event == 'push')
    outputs:
      workflow_run_id: ${{ steps.find.outputs.run_id || github.event.workflow_run.id }}
    permissions:
      contents: read
      actions: read
    steps:
      - name: Find CI workflow run ID
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            // For workflow_run events, use the existing workflow run ID
            if (context.eventName === 'workflow_run') {
              const workflowRunId = context.payload.workflow_run.id;
              core.setOutput('run_id', workflowRunId);
              return;
            }

            // For push events, find the latest successful CI run on stage branch
            const { data: stageRuns } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: 'stage',
              status: 'success',
              per_page: 1
            });

            if (stageRuns.workflow_runs.length > 0) {
              core.setOutput('run_id', stageRuns.workflow_runs[0].id);
              return;
            }

            core.setFailed('No successful CI run found on stage branch. Please ensure CI has run successfully before deploying to staging.');

  deploy:
    name: Deploy to Staging
    needs: [get-artifacts]
    if: >
      always() &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/stage' && needs.get-artifacts.result == 'success') ||
        (github.event_name == 'workflow_run' &&
         github.event.workflow_run.conclusion == 'success' &&
         github.event.workflow_run.event == 'push' &&
         github.event.workflow_run.head_branch != 'dev' &&
         github.event.workflow_run.head_branch != 'main' &&
         (github.event.workflow_run.head_branch == 'stage' || github.event.workflow_run.head_branch == 'refs/heads/stage') &&
         needs.get-artifacts.result == 'success')
      )
    runs-on: ubuntu-latest
    environment:
      name: staging
    steps:
      - name: Verify workflow run repository
        if: github.event_name == 'workflow_run'
        run: |
          # SECURITY: Verify that the workflow run is from the same repository
          # This prevents checkout of untrusted code from external repositories
          if [ "${{ github.event.workflow_run.repository.full_name }}" != "${{ github.repository }}" ]; then
            echo "❌ Security check failed: Workflow run is from a different repository"
            echo "Expected: ${{ github.repository }}"
            echo "Got: ${{ github.event.workflow_run.repository.full_name }}"
            exit 1
          fi
          echo "✅ Repository verified: ${{ github.event.workflow_run.repository.full_name }}"

      - name: Checkout revision
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          persist-credentials: false
          fetch-depth: 1

      - name: Verify branch before downloading artifacts
        if: github.event_name == 'workflow_run'
        id: verify_branch
        run: |
          # Normalize branch name (remove refs/heads/ prefix if present)
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          BRANCH_NAME="${BRANCH_NAME#refs/heads/}"  # Remove prefix if present

          if [ "$BRANCH_NAME" != "stage" ]; then
            echo "❌ CD Staging should only run for stage branch. Detected branch: ${{ github.event.workflow_run.head_branch }} (normalized: $BRANCH_NAME)"
            echo "Skipping deployment - only CI should run for this branch."
            exit 1
          fi
          echo "✅ Branch verified: ${{ github.event.workflow_run.head_branch }} (normalized: $BRANCH_NAME)"
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Download container artifacts
        if: >
          (github.event_name == 'push' && github.ref == 'refs/heads/stage') ||
          (github.event_name == 'workflow_run' && steps.verify_branch.outcome == 'success')
        uses: actions/download-artifact@v4
        with:
          name: container-artifacts-${{ needs.get-artifacts.outputs.workflow_run_id }}
          path: artifacts
          run-id: ${{ needs.get-artifacts.outputs.workflow_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-collision: false

      - name: Parse image digests
        id: images
        shell: bash
        run: |
          backend=$(grep '^backend=' artifacts/image-digests.txt | cut -d= -f2)
          frontend=$(grep '^frontend=' artifacts/image-digests.txt | cut -d= -f2)
          if [[ -z "$backend" || -z "$frontend" ]]; then
            echo "Image digests missing from artifact." >&2
            exit 1
          fi
          echo "backend_image=$backend" >> "$GITHUB_OUTPUT"
          echo "frontend_image=$frontend" >> "$GITHUB_OUTPUT"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify backend signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign verify --keyless ${{ steps.images.outputs.backend_image }}

      - name: Verify frontend signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign verify --keyless ${{ steps.images.outputs.frontend_image }}

      - name: Determine release version
        id: version
        run: echo "value=$(node -p \"require('./apps/backend/package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Deploy stack
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          envs: BACKEND_IMAGE,FRONTEND_IMAGE,STACK_VERSION
          script: |
            set -eo pipefail

            cd ~/fitvibe

            export BACKEND_IMAGE="${BACKEND_IMAGE}"
            export FRONTEND_IMAGE="${FRONTEND_IMAGE}"
            export STACK_VERSION="${STACK_VERSION}"

            compose="docker compose -f infra/docker/staging/docker-compose.staging.yml"

            deploy_stack() {
              $compose pull backend frontend
              $compose up -d --remove-orphans
              $compose exec -T backend node dist/db/utils/migrateAll.js
              $compose exec -T backend node dist/db/utils/postDeploy.js
              $compose exec -T backend node dist/db/utils/verifyIntegrity.js
              curl -fsS http://127.0.0.1:4100/health
              curl -fsS http://127.0.0.1:4100/metrics
            }

            deploy_stack
        env:
          BACKEND_IMAGE: ${{ steps.images.outputs.backend_image }}
          FRONTEND_IMAGE: ${{ steps.images.outputs.frontend_image }}
          STACK_VERSION: v${{ steps.version.outputs.value }}
