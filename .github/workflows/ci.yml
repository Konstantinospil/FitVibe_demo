name: CI

# Concurrency control: cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "dev", "stage"]
  pull_request:

# Default permissions (can be overridden per job for least privilege)
permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write
  actions: read

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fitvibe-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fitvibe-frontend
  NODE_VERSION: "20"
  PNPM_VERSION: "9.14.4"

jobs:
  quality:
    name: Quality Gates (Lint & Type Check)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better caching and blame

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify dependency integrity
        run: |
          pnpm audit --prod --audit-level=moderate || true
          echo "Dependency integrity check completed"

      - name: Lint
        timeout-minutes: 10
        run: pnpm lint:check

      - name: Type check
        timeout-minutes: 10
        run: pnpm typecheck

      - name: Job summary
        if: always()
        run: |
          echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Lint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Type Check: Passed" >> $GITHUB_STEP_SUMMARY

  backend_tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitvibe_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      clamav:
        image: clamav/clamav:1.3
        ports:
          - 3310:3310
        env:
          FRESHCLAM_CHECKS: 0
        options: >-
          --health-cmd="clamdscan --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      # Individual PG env vars for test files to detect database
      PGHOST: 127.0.0.1
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: fitvibe_test
      # Highest priority - test files check this first
      TEST_DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      CLAMAV_ENABLED: "true"
      CLAMAV_HOST: "127.0.0.1"
      CLAMAV_PORT: "3310"
      REAL_CLAMD: "1"
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Cache native dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache
            **/node_modules/.cache
          key: native-deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            native-deps-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Wait for services
        timeout-minutes: 15
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to start" >&2
              exit 1
            fi
            sleep 2
          done

          echo "Waiting for ClamAV..."
          python3 - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 3310
          for i in range(30):
              try:
                  with socket.create_connection((host, port), timeout=2):
                      print("ClamAV is ready")
                      sys.exit(0)
              except OSError:
                  if i == 29:
                      print("ClamAV failed to start", file=sys.stderr)
                      sys.exit(1)
                  time.sleep(2)
          PY

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Backend unit tests & coverage
        timeout-minutes: 15
        run: pnpm --filter @fitvibe/backend test -- --coverage --maxWorkers=2 --testPathIgnorePatterns="migrations/migrations\\.test\\.ts|seeds/seeds\\.test\\.ts|.*\\.integration\\.test\\.ts$|src/db/utils/__tests__/scripts\\.test\\.ts"

      - name: Upload backend coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-${{ github.run_id }}
          path: apps/backend/coverage
          retention-days: 30
          if-no-files-found: ignore

      - name: Job summary
        if: always()
        run: |
          echo "## Backend Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Backend unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Backend unit tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  frontend_tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read
    env:
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Cache native dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache
            **/node_modules/.cache
          key: native-deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            native-deps-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Frontend unit tests & coverage
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/frontend test -- --coverage --maxWorkers=2

      - name: Upload frontend coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_id }}
          path: apps/frontend/coverage
          retention-days: 30
          if-no-files-found: ignore

      - name: Job summary
        if: always()
        run: |
          echo "## Frontend Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Frontend unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Frontend unit tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  database_tests:
    name: Database Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitvibe_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      # Individual PG env vars for test files to detect database
      PGHOST: 127.0.0.1
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: fitvibe_test
      # Highest priority - test files check this first
      TEST_DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client \
            postgresql-client

      - name: Wait for PostgreSQL
        timeout-minutes: 10
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              echo "✓ Database is automatically provided by GitHub Actions service container"
              echo "  Connection: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to start" >&2
              exit 1
            fi
            sleep 2
          done

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run database migration tests
        timeout-minutes: 10
        run: |
          pnpm --filter @fitvibe/backend exec jest migrations/migrations.test.ts --maxWorkers=1 --forceExit

      - name: Run database seed tests
        timeout-minutes: 10
        run: |
          pnpm --filter @fitvibe/backend exec jest seeds/seeds.test.ts --maxWorkers=1 --forceExit

      - name: Force close database connections
        if: always()
        timeout-minutes: 2
        run: |
          echo "Closing all database connections..."
          PGPASSWORD=postgres psql -h 127.0.0.1 -p 5432 -U postgres -d fitvibe_test -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'fitvibe_test' AND pid <> pg_backend_pid();" || true
          echo "Database connections closed"

      - name: Job summary
        if: always()
        run: |
          echo "## Database Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Migration tests passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Seed tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Database tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  coverage:
    name: Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - backend_tests
      - frontend_tests
      - database_tests
    permissions:
      contents: read
      actions: read
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Download backend coverage artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-${{ github.run_id }}
          path: apps/backend/coverage
          if-no-files-found: ignore

      - name: Download frontend coverage artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_id }}
          path: apps/frontend/coverage
          if-no-files-found: ignore

      - name: Aggregate coverage files
        timeout-minutes: 5
        run: |
          mkdir -p coverage
          find apps packages -name "lcov.info" -exec cat {} \; > coverage/lcov.info || true
          if [ ! -s coverage/lcov.info ]; then
            echo "No coverage files found" > coverage/lcov.info
          fi

      - name: Enforce coverage gate
        timeout-minutes: 10
        run: pnpm test:coverage:gate

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.run_id }}
          path: coverage
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload coverage to Codecov
        if: success() && env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          flags: unit
          name: codecov-umbrella

      - name: Job summary
        if: always()
        run: |
          echo "## Coverage Gate Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Coverage gate passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Coverage gate failed" >> $GITHUB_STEP_SUMMARY
          fi

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - quality
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build frontend
        run: pnpm --filter @fitvibe/frontend run build

      - name: Start frontend preview server
        timeout-minutes: 10
        run: |
          cd apps/frontend
          pnpm preview --port 4173 --host 127.0.0.1 &
          echo $! > ../preview-server.pid
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:4173 >/dev/null 2>&1; then
              echo "Frontend preview server started"
              exit 0
            fi
            sleep 2
          done
          echo "Frontend preview server did not start in time" >&2
          exit 1

      - name: Run Lighthouse CI
        timeout-minutes: 10
        env:
          LHCI_PORT: "4173"
        run: pnpm exec lhci autorun --config=tests/perf/lighthouserc.json --exit-on-error

      - name: Upload Lighthouse artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report-${{ github.run_id }}
          path: tests/perf/lhci-output
          retention-days: 30
          if-no-files-found: ignore

      - name: Stop preview server
        if: always()
        timeout-minutes: 1
        run: |
          pkill -f "vite preview" || true
          if [ -f apps/frontend/preview-server.pid ]; then
            kill "$(cat apps/frontend/preview-server.pid)" 2>/dev/null || true
            rm -f apps/frontend/preview-server.pid
          fi

      - name: Job summary
        if: always()
        run: |
          echo "## Lighthouse Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Lighthouse CI passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Lighthouse CI failed" >> $GITHUB_STEP_SUMMARY
          fi

  i18n:
    name: i18n Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - quality
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Check i18n coverage
        timeout-minutes: 10
        run: pnpm i18n:check

      - name: Job summary
        if: always()
        run: |
          echo "## i18n Coverage Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ i18n coverage check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ i18n coverage check failed" >> $GITHUB_STEP_SUMMARY
          fi

  contract_tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - quality
      - backend_tests
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Generate OpenAPI spec
        timeout-minutes: 5
        run: pnpm -w openapi:build

      - name: Run OpenAPI contract tests
        timeout-minutes: 10
        env:
          CI: "true"
        run: pnpm --filter @fitvibe/backend exec jest tests/backend/contract/openapi.contract.test.ts --maxWorkers=1

      - name: Job summary
        if: always()
        run: |
          echo "## API Contract Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ OpenAPI contract tests passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Zod ↔ OpenAPI schema alignment verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ API contract tests failed" >> $GITHUB_STEP_SUMMARY
            echo "- ⚠️ Schema drift detected between Zod and OpenAPI" >> $GITHUB_STEP_SUMMARY
          fi

  excluded_tests:
    name: Excluded Tests (Integration & Scripts)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - backend_tests
      - frontend_tests
      - database_tests
    permissions:
      contents: read
      actions: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitvibe_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      clamav:
        image: clamav/clamav:1.3
        ports:
          - 3310:3310
        env:
          FRESHCLAM_CHECKS: 0
        options: >-
          --health-cmd="clamdscan --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      # Individual PG env vars for test files to detect database
      PGHOST: 127.0.0.1
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: fitvibe_test
      # Highest priority - test files check this first
      TEST_DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      CLAMAV_ENABLED: "true"
      CLAMAV_HOST: "127.0.0.1"
      CLAMAV_PORT: "3310"
      REAL_CLAMD: "1"
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client \
            postgresql-client

      - name: Wait for services
        timeout-minutes: 15
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to start" >&2
              exit 1
            fi
            sleep 2
          done

          echo "Waiting for ClamAV..."
          python3 - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 3310
          for i in range(30):
              try:
                  with socket.create_connection((host, port), timeout=2):
                      print("ClamAV is ready")
                      sys.exit(0)
              except OSError:
                  if i == 29:
                      print("ClamAV failed to start", file=sys.stderr)
                      sys.exit(1)
                  time.sleep(2)
          PY

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run database migrations
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/backend exec tsx src/db/utils/migrateAll.ts

      - name: Run scripts.test.ts
        timeout-minutes: 10
        env:
          CI: "true"
        run: pnpm --filter @fitvibe/backend exec jest src/db/utils/__tests__/scripts.test.ts --maxWorkers=1 --forceExit

      - name: Run integration tests
        timeout-minutes: 20
        env:
          NODE_ENV: test
          CI: "true"
        run: pnpm --filter @fitvibe/backend exec jest --maxWorkers=2 --testMatch="**/integration/**/*.integration.test.ts" --testPathIgnorePatterns="/node_modules/|verification-resend-limit\\.test\\.ts$|login-enumeration\\.test\\.ts$" --forceExit

      - name: Job summary
        if: always()
        run: |
          echo "## Excluded Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Scripts test passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Integration tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Some excluded tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  openapi_spec:
    name: Build OpenAPI spec
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - quality
      - database_tests
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Generate OpenAPI JSON
        timeout-minutes: 5
        run: pnpm -w openapi:build

      - name: Validate OpenAPI schema
        timeout-minutes: 2
        run: |
          if [ ! -f apps/backend/openapi/openapi.json ]; then
            echo "Error: OpenAPI file not generated" >&2
            exit 1
          fi
          node -e "JSON.parse(require('fs').readFileSync('apps/backend/openapi/openapi.json', 'utf8'))"

      - name: Upload OpenAPI artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-${{ github.run_id }}
          path: apps/backend/openapi/openapi.json
          retention-days: 90
          if-no-files-found: error

  integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - backend_tests
      - frontend_tests
      - database_tests
      - excluded_tests
    permissions:
      contents: read
      actions: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: fitvibe
          POSTGRES_USER: fitvibe
          POSTGRES_PASSWORD: fitvibe
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U fitvibe -d fitvibe"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      clamav:
        image: clamav/clamav:1.3
        ports:
          - 3310:3310
        env:
          FRESHCLAM_CHECKS: 0
        options: >-
          --health-cmd="clamdscan --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://fitvibe:fitvibe@127.0.0.1:5432/fitvibe
      CLAMAV_ENABLED: "true"
      CLAMAV_HOST: "127.0.0.1"
      CLAMAV_PORT: "3310"
      REAL_CLAMD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Wait for services
        timeout-minutes: 10
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U fitvibe >/dev/null 2>&1; then
              echo "PostgreSQL is ready"

              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to start" >&2
              exit 1
            fi
            sleep 2
          done

          echo "Waiting for ClamAV..."
          python3 - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 3310
          for i in range(30):
              try:
                  with socket.create_connection((host, port), timeout=2):
                      print("ClamAV is ready")
                      sys.exit(0)
              except OSError:
                  if i == 29:
                      print("ClamAV failed to start", file=sys.stderr)
                      sys.exit(1)
                  time.sleep(2)
          PY

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run database migrations
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/backend exec tsx src/db/utils/migrateAll.ts

      - name: Verify migrations completed successfully
        timeout-minutes: 2
        run: |
          echo "Verifying critical tables exist..."
          PGPASSWORD=fitvibe psql -h 127.0.0.1 -p 5432 -U fitvibe -d fitvibe <<EOF
          DO \$\$
          DECLARE
            missing_tables text[];
          BEGIN
            SELECT array_agg(t) INTO missing_tables
            FROM unnest(ARRAY['users', 'profiles', 'sessions', 'feed_items', 'exercises']) t
            WHERE NOT EXISTS (
              SELECT 1 FROM information_schema.tables
              WHERE table_name = t
            );

            IF array_length(missing_tables, 1) > 0 THEN
              RAISE EXCEPTION 'Missing critical tables: %', array_to_string(missing_tables, ', ');
            END IF;
          END \$\$;
          EOF

      - name: Seed database
        timeout-minutes: 10
        env:
          NODE_ENV: test
        run: pnpm --filter @fitvibe/backend exec tsx src/db/utils/seedAll.ts

      - name: Integration tests
        timeout-minutes: 20
        env:
          NODE_ENV: test
        run: pnpm --filter @fitvibe/backend exec jest --maxWorkers=2 --testMatch="**/integration/**/*.integration.test.ts" --testPathIgnorePatterns="/node_modules/|verification-resend-limit\\.test\\.ts$|login-enumeration\\.test\\.ts$"

      - name: Job summary
        if: always()
        run: |
          echo "## Integration Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Integration tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Integration tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  metrics_contract:
    name: Metrics Contract
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - quality
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate metrics exposure
        timeout-minutes: 3
        run: node tests/metrics/assert-prom.cjs

  security:
    name: Security Scans
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - quality
    permissions:
      contents: read
      security-events: write
      actions: read
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Dependency audit (fail on high severity)
        timeout-minutes: 5
        run: pnpm audit --prod --audit-level=high

      - name: Scan for CVEs (OSV)
        timeout-minutes: 10
        uses: google/osv-scanner-action/osv-scanner-action@v2.2.4
        with:
          scan-args: |-
            --lockfile=pnpm-lock.yaml
            --format=json
            --output=osv-report.json

      - name: Upload OSV report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: osv-report-${{ github.run_id }}
          path: osv-report.json
          retention-days: 90
          if-no-files-found: ignore

      - name: Snyk scan
        if: env.SNYK_TOKEN != ''
        timeout-minutes: 10
        uses: snyk/actions/node@master
        with:
          command: test
          args: --all-projects --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: TruffleHog OSS scan
        timeout-minutes: 5
        uses: trufflesecurity/trufflehog@v3.90.13
        with:
          scan_secrets: true
          only_verified: true

      - name: Static secret scan
        timeout-minutes: 5
        run: node tests/security/secret-scan.cjs

      - name: Container vulnerability scan
        timeout-minutes: 10
        uses: aquasecurity/trivy-action@0.22.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL
          exit-code: 1
          ignore-unfixed: true
          skip-dirs: |
            infra/keys
            infra/docker/keys
            node_modules

      - name: Job summary
        if: always()
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependency audit completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ OSV scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secret scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Container scan completed" >> $GITHUB_STEP_SUMMARY

  codeql:
    name: CodeQL Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - quality
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: Job summary
        if: always()
        run: |
          echo "## CodeQL Analysis Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ CodeQL static analysis completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ CodeQL analysis failed" >> $GITHUB_STEP_SUMMARY
          fi

  zap_baseline:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security
    permissions:
      contents: read
      security-events: write
    env:
      ZAP_TARGET_URL: ${{ secrets.ZAP_TARGET_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ZAP baseline scan
        if: env.ZAP_TARGET_URL != ''
        timeout-minutes: 12
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.ZAP_TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: -a -I

  performance:
    name: Performance Budgets
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - quality
      - lighthouse
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Install k6
        uses: grafana/setup-k6-action@v1

      - name: Build frontend
        run: pnpm --filter @fitvibe/frontend run build

      - name: Start mock services
        timeout-minutes: 10
        run: |
          node tests/perf/mock-server.mjs &
          echo $! > mock-server.pid
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:4173/health >/dev/null; then
              echo "Mock server started"
              exit 0
            fi
            sleep 3
          done
          echo "Mock server did not start in time" >&2
          exit 1

      - name: Run k6 smoke test
        timeout-minutes: 10
        env:
          API_BASE_URL: http://127.0.0.1:4173/health
        run: k6 run --summary-export=tests/perf/k6-summary.json tests/perf/k6-smoke.js

      - name: Assert k6 performance budgets
        timeout-minutes: 10
        run: node tests/perf/assert-budgets.cjs tests/perf/k6-summary.json

      - name: Stop mock server
        if: always()
        timeout-minutes: 1
        run: |
          pkill -f "mock-server.mjs" || true
          if [ -f mock-server.pid ]; then
            kill "$(cat mock-server.pid)" 2>/dev/null || true
            rm -f mock-server.pid
          fi
          sleep 1

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-metrics-${{ github.run_id }}
          path: |
            tests/perf/k6-summary.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Job summary
        if: always()
        run: |
          echo "## Performance Budgets Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ k6 performance tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Performance tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  qa_summary:
    name: QA Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - quality
      - coverage
      - lighthouse
      - i18n
      - performance
      - contract_tests
      - visual_regression
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Download coverage artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: coverage-${{ github.run_id }}
          path: coverage
          if-no-files-found: ignore

      - name: Download performance metrics
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: perf-metrics-${{ github.run_id }}
          path: .
          if-no-files-found: ignore

      - name: Download lighthouse report
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-report-${{ github.run_id }}
          path: tests/perf/lhci-output
          if-no-files-found: ignore

      - name: Generate QA summary
        timeout-minutes: 5
        run: node tests/qa/generate-summary.mjs

      - name: Upload QA summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: qa-summary-${{ github.run_id }}
          path: tests/qa/summary
          retention-days: 90
          if-no-files-found: error

  accessibility:
    name: Accessibility (axe)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - quality
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build frontend bundle
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/frontend run build

      - name: Install Playwright browsers
        timeout-minutes: 10
        run: pnpm exec playwright install --with-deps

      - name: Run axe accessibility suite
        timeout-minutes: 10
        env:
          PLAYWRIGHT_JOBS: 1
        run: pnpm test:a11y

      - name: Upload accessibility artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-a11y-report-${{ github.run_id }}
          path: |
            playwright-report
            test-results
          retention-days: 30
          if-no-files-found: ignore

  visual_regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - quality
      - frontend_tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build frontend
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/frontend run build

      - name: Install Playwright browsers
        timeout-minutes: 10
        run: pnpm exec playwright install --with-deps chromium

      - name: Run visual regression tests
        timeout-minutes: 20
        env:
          APP_URL: "http://127.0.0.1:4173"
          CI: "true"
        run: pnpm exec playwright test --config tests/frontend/visual/config/playwright.config.ts

      - name: Upload visual test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-${{ github.run_id }}
          path: |
            tests/frontend/visual/__screenshots__
            playwright-report/visual
            test-results/visual-junit.xml
          retention-days: 30
          if-no-files-found: ignore

      - name: Job summary
        if: always()
        run: |
          echo "## Visual Regression Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Visual regression tests passed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ All screenshots match baseline (maxDiffPixelRatio ≤ 0.2%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Visual regression tests failed" >> $GITHUB_STEP_SUMMARY
            echo "- ⚠️ Visual differences detected - review screenshots" >> $GITHUB_STEP_SUMMARY
          fi

  e2e:
    name: E2E Playwright
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stage')
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            postgresql-client

      - name: Install project dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Install Playwright browsers
        timeout-minutes: 10
        run: pnpm exec playwright install --with-deps

      - name: Build frontend
        timeout-minutes: 10
        run: pnpm --filter @fitvibe/frontend exec pnpm run build

      - name: Run Playwright smoke tests
        timeout-minutes: 15
        run: pnpm exec playwright test --config tests/frontend/e2e/playwright.config.cjs --reporter=line

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report
            test-results
          retention-days: 30
          if-no-files-found: ignore

  build:
    name: Build & Publish Images
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs:
      - quality
      - backend_tests
      - frontend_tests
      - database_tests
      - coverage
      - excluded_tests
      - integration
      - metrics_contract
      - accessibility
      - qa_summary
      - performance
      - security
      - codeql
      - openapi_spec
      - lighthouse
      - i18n
      - contract_tests
      - visual_regression
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stage')
    permissions:
      contents: read
      packages: write
      id-token: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine package versions
        id: versions
        timeout-minutes: 2
        run: |
          if [ ! -f apps/backend/package.json ] || [ ! -f apps/frontend/package.json ]; then
            echo "Error: package.json files not found" >&2
            exit 1
          fi
          echo "backend=$(node -p \"require('./apps/backend/package.json').version\")" >> "$GITHUB_OUTPUT"
          echo "frontend=$(node -p \"require('./apps/frontend/package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        id: backend
        timeout-minutes: 20
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/docker/prod/Dockerfile.backend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:sha-${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:v${{ steps.versions.outputs.backend }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Build and push frontend image
        id: frontend
        timeout-minutes: 20
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/docker/prod/Dockerfile.frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:v${{ steps.versions.outputs.frontend }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign backend image
        timeout-minutes: 5
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign --yes --keyless ${{ env.BACKEND_IMAGE }}@${{ steps.backend.outputs.digest }}

      - name: Sign frontend image
        timeout-minutes: 5
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign --yes --keyless ${{ env.FRONTEND_IMAGE }}@${{ steps.frontend.outputs.digest }}

      - name: Generate backend SBOM
        timeout-minutes: 5
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.BACKEND_IMAGE }}@${{ steps.backend.outputs.digest }}
          output-file: sbom-backend.spdx.json

      - name: Generate frontend SBOM
        timeout-minutes: 5
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.FRONTEND_IMAGE }}@${{ steps.frontend.outputs.digest }}
          output-file: sbom-frontend.spdx.json

      - name: Record image digests
        timeout-minutes: 2
        run: |
          printf "backend=%s@%s\nfrontend=%s@%s\n" \
            "${{ env.BACKEND_IMAGE }}" "${{ steps.backend.outputs.digest }}" \
            "${{ env.FRONTEND_IMAGE }}" "${{ steps.frontend.outputs.digest }}" > image-digests.txt

      - name: Download OpenAPI artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-${{ github.run_id }}
          path: artifacts/openapi

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: container-artifacts-${{ github.run_id }}
          path: |
            sbom-backend.spdx.json
            sbom-frontend.spdx.json
            image-digests.txt
            artifacts/openapi/openapi.json
          retention-days: 365
          if-no-files-found: error

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        id: create_release
        timeout-minutes: 5
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.versions.outputs.backend }}
          name: Release v${{ steps.versions.outputs.backend }}
          body: |
            - Backend image: ${{ env.BACKEND_IMAGE }}:v${{ steps.versions.outputs.backend }}
            - Frontend image: ${{ env.FRONTEND_IMAGE }}:v${{ steps.versions.outputs.frontend }}
          draft: false
          prerelease: false
          artifacts: container-artifacts-${{ github.run_id }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Job summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Backend image: \`${{ env.BACKEND_IMAGE }}@${{ steps.backend.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Frontend image: \`${{ env.FRONTEND_IMAGE }}@${{ steps.frontend.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Images signed with cosign" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ SBOMs generated" >> $GITHUB_STEP_SUMMARY

  build_verification:
    name: Build Verification (Container Smoke Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stage')
    permissions:
      contents: read
      packages: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitvibe_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install postgresql-client
        timeout-minutes: 2
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        timeout-minutes: 5
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to start" >&2
              exit 1
            fi
            sleep 2
          done

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull backend image
        timeout-minutes: 5
        run: docker pull ${{ env.BACKEND_IMAGE }}:sha-${{ github.sha }}

      - name: Verify backend image size
        timeout-minutes: 2
        run: |
          BACKEND_TAG="${{ env.BACKEND_IMAGE }}:sha-${{ github.sha }}"
          SIZE=$(docker images "$BACKEND_TAG" --format "{{.Size}}" | head -1)
          echo "Backend image size: $SIZE"
          # Extract numeric size (e.g., "1.2GB" -> 1.2)
          NUM_SIZE=$(echo "$SIZE" | sed 's/[^0-9.]//g' | head -c 4)
          if [ -z "$NUM_SIZE" ] || [ "$NUM_SIZE" = "0" ]; then
            echo "Warning: Could not parse image size"
          else
            echo "Backend image size: ${NUM_SIZE} (parsed)"
          fi

      - name: Start backend container
        timeout-minutes: 5
        run: |
          docker run -d \
            --name test-backend \
            -p 4100:4100 \
            -e DATABASE_URL="${{ env.DATABASE_URL }}" \
            -e NODE_ENV=production \
            -e PORT=4100 \
            ${{ env.BACKEND_IMAGE }}:sha-${{ github.sha }}
          echo "Backend container started"

      - name: Wait for backend health check
        timeout-minutes: 30
        run: |
          echo "Waiting for backend health endpoint..."
          for i in {1..60}; do
            if curl -f http://127.0.0.1:4100/health >/dev/null 2>&1; then
              echo "Backend health check passed"
              exit 0
            fi
            if [ $i -eq 60 ]; then
              echo "Backend health check failed after 60 attempts" >&2
              docker logs test-backend
              exit 1
            fi
            sleep 2
          done

      - name: Verify backend health endpoint
        timeout-minutes: 2
        run: |
          RESPONSE=$(curl -s http://127.0.0.1:4100/health)
          echo "Health endpoint response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "ok\|healthy\|status"; then
            echo "✅ Backend health endpoint working"
          else
            echo "❌ Backend health endpoint returned unexpected response"
            exit 1
          fi

      - name: Pull frontend image
        timeout-minutes: 5
        run: docker pull ${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}

      - name: Verify frontend image size
        timeout-minutes: 2
        run: |
          FRONTEND_TAG="${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}"
          SIZE=$(docker images "$FRONTEND_TAG" --format "{{.Size}}" | head -1)
          echo "Frontend image size: $SIZE"
          NUM_SIZE=$(echo "$SIZE" | sed 's/[^0-9.]//g' | head -c 4)
          if [ -z "$NUM_SIZE" ] || [ "$NUM_SIZE" = "0" ]; then
            echo "Warning: Could not parse image size"
          else
            echo "Frontend image size: ${NUM_SIZE} (parsed)"
          fi

      - name: Start frontend container
        timeout-minutes: 5
        run: |
          docker run -d \
            --name test-frontend \
            -p 8080:80 \
            ${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}
          echo "Frontend container started"

      - name: Wait for frontend to serve
        timeout-minutes: 10
        run: |
          echo "Waiting for frontend to serve..."
          for i in {1..30}; do
            if curl -f http://127.0.0.1:8080 >/dev/null 2>&1; then
              echo "Frontend is serving"
              exit 0
            fi
            if [ $i -eq 30 ]; then
              echo "Frontend failed to serve after 30 attempts" >&2
              docker logs test-frontend
              exit 1
            fi
            sleep 2
          done

      - name: Verify frontend serves HTML
        timeout-minutes: 2
        run: |
          RESPONSE=$(curl -s http://127.0.0.1:8080 | head -20)
          if echo "$RESPONSE" | grep -qi "<!doctype html\|<html"; then
            echo "✅ Frontend serves HTML"
          else
            echo "❌ Frontend does not serve HTML"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Cleanup containers
        if: always()
        timeout-minutes: 2
        run: |
          docker stop test-backend test-frontend 2>/dev/null || true
          docker rm test-backend test-frontend 2>/dev/null || true

      - name: Job summary
        if: always()
        run: |
          echo "## Build Verification Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- ✅ Backend container starts and health check passes" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Frontend container starts and serves HTML" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Image sizes verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Build verification failed" >> $GITHUB_STEP_SUMMARY
            echo "- ⚠️ Containers may not be functioning correctly" >> $GITHUB_STEP_SUMMARY
          fi
