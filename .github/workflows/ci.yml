name: CI

on:
  push:
    branches: ["main", "dev", "stage"]
  pull_request:

permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write
  actions: read

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fitvibe-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fitvibe-frontend

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitvibe_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      clamav:
        image: clamav/clamav:1.3
        ports:
          - 3310:3310
        env:
          FRESHCLAM_CHECKS: 0
        options: >-
          --health-cmd="clamdscan --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/fitvibe_test
      CLAMAV_ENABLED: "true"
      CLAMAV_HOST: "127.0.0.1"
      CLAMAV_PORT: "3310"
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      REAL_CLAMD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Pre-warm pnpm
        run: pnpm --version

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Wait for ClamAV
        run: |
          python3 - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 3310
          for _ in range(60):
              try:
                  with socket.create_connection((host, port), timeout=2):
                      sys.exit(0)
              except OSError:
                  time.sleep(2)
          sys.exit("ClamAV service did not become ready in time")
          PY

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint:check

      - name: Type check
        run: pnpm typecheck

      - name: Unit tests & coverage
        run: pnpm test -- --coverage --runInBand

      - name: Enforce coverage gate
        run: pnpm test:coverage:gate

      - name: Validate QA baseline snapshot
        run: node tests/qa/assert-baseline.js

      - name: Check i18n coverage
        run: pnpm i18n:check

      - name: Verify feature flag defaults
        run: node tests/qa/check-feature-flags.js

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          if-no-files-found: ignore

      - name: Aggregate coverage files
        if: success()
        run: |
          # Create root coverage directory and aggregate lcov files
          mkdir -p coverage
          find apps packages -name "lcov.info" -exec cat {} \; > coverage/lcov.info || true
          # If no lcov files found, create empty file to prevent Codecov error
          if [ ! -s coverage/lcov.info ]; then
            echo "No coverage files found" > coverage/lcov.info
          fi

      - name: Upload coverage to Codecov
        if: success() && env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          flags: unit

      - name: Build workspace
        run: pnpm build

  openapi_spec:
    name: Build OpenAPI spec
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Pre-warm pnpm
        run: pnpm --version

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate OpenAPI JSON
        run: pnpm -w openapi:build

      - name: Upload OpenAPI artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openapi
          path: apps/backend/openapi/openapi.json
          if-no-files-found: error

  integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: fitvibe
          POSTGRES_USER: fitvibe
          POSTGRES_PASSWORD: fitvibe
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U fitvibe -d fitvibe"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      clamav:
        image: clamav/clamav:1.3
        ports:
          - 3310:3310
        env:
          FRESHCLAM_CHECKS: 0
        options: >-
          --health-cmd="clamdscan --version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://fitvibe:fitvibe@127.0.0.1:5432/fitvibe
      CLAMAV_ENABLED: "true"
      CLAMAV_HOST: "127.0.0.1"
      CLAMAV_PORT: "3310"
      REAL_CLAMD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Wait for ClamAV
        run: |
          python3 - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 3310
          for _ in range(60):
              try:
                  with socket.create_connection((host, port), timeout=2):
                      sys.exit(0)
              except OSError:
                  time.sleep(2)
          sys.exit("ClamAV service did not become ready in time")
          PY

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm --filter @fitvibe/backend exec tsx src/db/utils/migrateAll.ts

      - name: Seed database
        run: pnpm --filter @fitvibe/backend exec tsx src/db/utils/seedAll.ts

      - name: Integration tests
        env:
          NODE_ENV: test
        run: pnpm --filter @fitvibe/backend exec jest --runInBand

  metrics_contract:
    name: Metrics Contract
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate metrics exposure
        run: node tests/metrics/assert-prom.cjs

  security:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: quality
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Dependency audit (fail on high severity)
        run: pnpm audit --prod --audit-level=high

      - name: Scan for CVEs (OSV)
        uses: google/osv-scanner-action/osv-scanner-action@v2.2.4
        with:
          scan-args: |-
            --lockfile=pnpm-lock.yaml
            --format=json

      - name: Snyk scan
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        with:
          command: test
          args: --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: TruffleHog OSS scan
        uses: trufflesecurity/trufflehog@v3.90.13
        with:
          scan_secrets: true

      - name: Static secret scan
        run: node tests/security/secret-scan.cjs

      - name: Container vulnerability scan
        uses: aquasecurity/trivy-action@0.22.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL
          exit-code: 1
          ignore-unfixed: true
          skip-dirs: |
            infra/keys
            infra/docker/keys

  zap_baseline:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    needs: security
    env:
      ZAP_TARGET_URL: ${{ secrets.ZAP_TARGET_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ZAP baseline scan
        if: env.ZAP_TARGET_URL != ''
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.ZAP_TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: -a -I

  performance:
    name: Performance Budgets
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install k6
        uses: grafana/setup-k6-action@v1

      - name: Start mock services
        run: |
          node tests/perf/mock-server.mjs &
          echo $! > mock-server.pid
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:4173/health >/dev/null; then
              exit 0
            fi
            sleep 3
          done
          echo "Mock server did not start in time" >&2
          exit 1

      - name: Run k6 smoke test
        env:
          API_BASE_URL: http://127.0.0.1:4173/health
        run: k6 run --summary-export=tests/perf/k6-summary.json tests/perf/k6-smoke.js

      - name: Assert k6 performance budgets
        run: node tests/perf/assert-budgets.cjs tests/perf/k6-summary.json

      - name: Run Lighthouse CI
        env:
          LHCI_PORT: "4173"
        run: pnpm exec lhci autorun --config=tests/perf/lighthouserc.json --exit-on-error

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-metrics
          path: |
            tests/perf/k6-summary.json
            tests/perf/lhci-output
          if-no-files-found: ignore

      - name: Stop mock services
        if: always()
        run: |
          # Kill by process name first (more reliable)
          pkill -f "mock-server.mjs" || true
          # Also try to kill by PID if file exists
          if [ -f mock-server.pid ]; then
            kill "$(cat mock-server.pid)" 2>/dev/null || true
            rm -f mock-server.pid
          fi

  qa_summary:
    name: QA Summary
    runs-on: ubuntu-latest
    needs:
      - quality
      - performance
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: Download performance metrics
        uses: actions/download-artifact@v4
        with:
          name: perf-metrics
          path: .

      - name: Generate QA summary
        run: node tests/qa/generate-summary.mjs

      - name: Upload QA summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: qa-summary
          path: tests/qa/summary
          if-no-files-found: error

  accessibility:
    name: Accessibility (axe)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend bundle
        run: pnpm --filter @fitvibe/frontend run build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run axe accessibility suite
        env:
          PLAYWRIGHT_JOBS: 1
        run: pnpm test:a11y

      - name: Upload accessibility artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-a11y-report
          path: |
            playwright-report
            test-results
          if-no-files-found: ignore

  e2e:
    name: E2E Playwright
    runs-on: ubuntu-latest
    needs: integration
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stage')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install native canvas prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - name: Install project dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Build frontend
        run: pnpm --filter @fitvibe/frontend exec pnpm run build

      - name: Run Playwright smoke tests
        run: pnpm exec playwright test --config tests/frontend/e2e/playwright.config.cjs --reporter=line

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results
          if-no-files-found: ignore

  build:
    name: Build & Publish Images
    runs-on: ubuntu-latest
    needs:
      - quality
      - integration
      - metrics_contract
      - accessibility
      - qa_summary
      - performance
      - security
      - openapi_spec
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stage')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine package versions
        id: versions
        run: |
          if [ ! -f apps/backend/package.json ] || [ ! -f apps/frontend/package.json ]; then
            echo "Error: package.json files not found"
            exit 1
          fi
          echo "backend=$(node -p \"require('./apps/backend/package.json').version\")" >> "$GITHUB_OUTPUT"
          echo "frontend=$(node -p \"require('./apps/frontend/package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        id: backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/docker/prod/Dockerfile.backend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:sha-${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:v${{ steps.versions.outputs.backend }}
          provenance: true
          sbom: false

      - name: Build and push frontend image
        id: frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/docker/prod/Dockerfile.frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:v${{ steps.versions.outputs.frontend }}
          provenance: true
          sbom: false

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign backend image
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign --yes --keyless ${{ env.BACKEND_IMAGE }}@${{ steps.backend.outputs.digest }}

      - name: Sign frontend image
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign --yes --keyless ${{ env.FRONTEND_IMAGE }}@${{ steps.frontend.outputs.digest }}

      - name: Generate backend SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.BACKEND_IMAGE }}@${{ steps.backend.outputs.digest }}
          output-file: sbom-backend.spdx.json

      - name: Generate frontend SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.FRONTEND_IMAGE }}@${{ steps.frontend.outputs.digest }}
          output-file: sbom-frontend.spdx.json

      - name: Record image digests
        run: |
          printf "backend=%s@%s\nfrontend=%s@%s\n" \
            "${{ env.BACKEND_IMAGE }}" "${{ steps.backend.outputs.digest }}" \
            "${{ env.FRONTEND_IMAGE }}" "${{ steps.frontend.outputs.digest }}" > image-digests.txt
      - name: Download OpenAPI artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi
          path: artifacts/openapi

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: container-artifacts
          path: |
            sbom-backend.spdx.json
            sbom-frontend.spdx.json
            image-digests.txt
            artifacts/openapi/openapi.json
          if-no-files-found: error
      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.versions.outputs.backend }}
          name: Release v${{ steps.versions.outputs.backend }}
          body: |
            - Backend image: ${{ env.BACKEND_IMAGE }}:v${{ steps.versions.outputs.backend }}
            - Frontend image: ${{ env.FRONTEND_IMAGE }}:v${{ steps.versions.outputs.frontend }}
          draft: false
          prerelease: false
          artifacts: container-artifacts
          token: ${{ secrets.GITHUB_TOKEN }} # Using the repo token to upload artifacts
