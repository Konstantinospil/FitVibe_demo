## ===============================================================
## FitVibe Backend - Monorepo Build Pipeline (Optimized)
## ===============================================================

FROM node:20-alpine AS builder
WORKDIR /app

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY apps/backend/package.json apps/backend/
COPY packages/*/package.json packages/*/

RUN corepack enable && corepack prepare pnpm@9.0.0 --activate
RUN pnpm fetch --prod=false

COPY . .

RUN pnpm install --frozen-lockfile --prod=false --offline
RUN pnpm --filter @fitvibe/backend run build
RUN pnpm deploy --filter @fitvibe/backend --prod /app/backend-deploy

FROM node:20-alpine AS runtime
WORKDIR /app

# Copy deployed backend
COPY --from=builder /app/backend-deploy/ ./

# Override package.json with backend's version (which has type: commonjs)
COPY --from=builder /app/apps/backend/package.json ./package.json

# Copy workspace files needed for pnpm to resolve the glob override
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/packages/patched-glob ./packages/patched-glob

# Install production dependencies to ensure workspace overrides are resolved
# This will install minimatch and other dependencies needed by patched-glob
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate && \
    pnpm install --prod --frozen-lockfile --offline --no-optional && \
    # Ensure glob resolves to patched-glob by creating symlink if needed
    if [ ! -L node_modules/glob ] && [ -d packages/patched-glob ]; then \
      ln -sf ../packages/patched-glob node_modules/glob; \
    fi && \
    # Ensure patched-glob's dependencies are available in node_modules
    cd packages/patched-glob && pnpm install --prod --frozen-lockfile --offline || true

RUN addgroup -S nodeapp && adduser -S nodeapp -G nodeapp
USER nodeapp

ENV NODE_ENV=production \
  PORT=4000

EXPOSE 4000

CMD ["node", "dist/server.js"]
## ===============================================================
