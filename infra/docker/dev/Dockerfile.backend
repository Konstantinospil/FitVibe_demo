## ===============================================================
## FitVibe Backend - Monorepo Build Pipeline (Optimized)
## ===============================================================

FROM node:20-alpine AS builder
WORKDIR /app

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY apps/backend/package.json apps/backend/
COPY packages/*/package.json packages/*/

RUN corepack enable && corepack prepare pnpm@9.0.0 --activate
RUN pnpm fetch --prod=false

COPY . .

RUN pnpm install --frozen-lockfile --prod=false --offline || \
    pnpm install --prod=false
RUN pnpm --filter @fitvibe/backend run build
RUN pnpm deploy --filter @fitvibe/backend --prod /app/backend-deploy

FROM node:20-alpine AS runtime
WORKDIR /app

# Copy built backend dist files
COPY --from=builder /app/apps/backend/dist ./dist

# Copy SQL files needed for migrations (types, functions, triggers, views, schema)
COPY --from=builder /app/apps/backend/src/db/types ./dist/db/types
COPY --from=builder /app/apps/backend/src/db/functions ./dist/db/functions
COPY --from=builder /app/apps/backend/src/db/triggers ./dist/db/triggers
COPY --from=builder /app/apps/backend/src/db/views ./dist/db/views
COPY --from=builder /app/apps/backend/src/db/schema ./dist/db/schema

# Copy package.json and workspace files needed for pnpm
COPY --from=builder /app/apps/backend/package.json ./package.json
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml

# Copy packages needed (patched-glob for workspace override)
COPY --from=builder /app/packages/patched-glob ./packages/patched-glob
COPY --from=builder /app/packages/patched-glob/package.json ./packages/patched-glob/package.json

# Install production dependencies using pnpm (maintains proper module resolution)
# This approach preserves pnpm's structure so all dependencies resolve correctly
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate && \
    pnpm install --prod --frozen-lockfile --offline || \
    pnpm install --prod --no-frozen-lockfile || true && \
    # Ensure glob resolves to patched-glob if it exists
    if [ -d packages/patched-glob ] && [ -d node_modules/glob ] && [ ! -L node_modules/glob ]; then \
      rm -rf node_modules/glob && \
      ln -sf ../packages/patched-glob node_modules/glob; \
    fi

RUN addgroup -S nodeapp && adduser -S nodeapp -G nodeapp
USER nodeapp

ENV NODE_ENV=production \
  PORT=4000

EXPOSE 4000

CMD ["node", "dist/server.js"]
## ===============================================================
