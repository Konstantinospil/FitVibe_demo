## ===============================================================
## FitVibe Backend - Monorepo Build Pipeline (Optimized)
## ===============================================================

FROM node:20-alpine AS builder
WORKDIR /app

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY apps/backend/package.json apps/backend/
COPY packages/*/package.json packages/*/

RUN corepack enable && corepack prepare pnpm@9.0.0 --activate
RUN pnpm fetch --prod=false

COPY . .

RUN pnpm install --frozen-lockfile --prod=false --offline
RUN pnpm --filter @fitvibe/backend run build
RUN pnpm deploy --filter @fitvibe/backend --prod /app/backend-deploy

FROM node:20-alpine AS runtime
WORKDIR /app

COPY --from=builder /app/backend-deploy/ ./
COPY --from=builder /app/apps/backend/node_modules ./apps/backend/node_modules
# Copy workspace configuration and patched-glob package to ensure glob override works
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/packages/patched-glob ./packages/patched-glob
# Copy root node_modules to ensure workspace links are resolved
COPY --from=builder /app/node_modules ./node_modules

RUN addgroup -S nodeapp && adduser -S nodeapp -G nodeapp
USER nodeapp

ENV NODE_ENV=production \
  PORT=4000

EXPOSE 4000

CMD ["node", "dist/server.js"]
## ===============================================================
