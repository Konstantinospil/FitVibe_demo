## ===============================================================
## FitVibe Backend - Monorepo Build Pipeline (Optimized)
## ===============================================================

FROM node:20-alpine AS builder
WORKDIR /app

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY apps/backend/package.json apps/backend/
COPY packages/*/package.json packages/*/

RUN corepack enable && corepack prepare pnpm@9.0.0 --activate
RUN pnpm fetch --prod=false

COPY . .

RUN pnpm install --frozen-lockfile --prod=false --offline
RUN pnpm --filter @fitvibe/backend run build
RUN pnpm deploy --filter @fitvibe/backend --prod /app/backend-deploy

FROM node:20-alpine AS runtime
WORKDIR /app

# Copy deployed backend
COPY --from=builder /app/backend-deploy/ ./

# Override package.json with backend's version (which has type: commonjs)
COPY --from=builder /app/apps/backend/package.json ./package.json

# Copy workspace files needed for pnpm to resolve the glob override
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml

# Install production dependencies
# Note: Use --no-frozen-lockfile to allow override resolution
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate && \
    # Install all production dependencies (pnpm overrides should handle glob via link:packages/patched-glob)
    pnpm install --prod --no-frozen-lockfile --no-optional || \
    npm install --production --no-optional || true && \
    # Ensure minimatch is available (required by glob/patched-glob)
    if [ ! -d node_modules/.pnpm/minimatch* ] && [ ! -d node_modules/minimatch ]; then \
      npm install minimatch@^9.0.4 --save-prod || true; \
    fi

RUN addgroup -S nodeapp && adduser -S nodeapp -G nodeapp
USER nodeapp

ENV NODE_ENV=production \
  PORT=4000

EXPOSE 4000

CMD ["node", "dist/server.js"]
## ===============================================================
