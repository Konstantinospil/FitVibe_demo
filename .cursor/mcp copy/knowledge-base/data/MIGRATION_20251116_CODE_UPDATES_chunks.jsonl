{"chunk_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES", "text": "# Code Updates Required for Schema Alignment Migrations\n\nThis document lists code changes required after running migrations `202511160000` through `202511160002`.\n\n\n## Table Rename: `user_static` → `profiles`\n\nThe following files reference `user_static` and need to be updated to use `profiles`:\n\n### Backend Code Files\n\n1. **`apps/backend/src/modules/users/users.service.ts`** (line 741)\n   - Change: `db<UserStaticRow>(\"user_static\")` → `db<ProfileRow>(\"profiles\")`\n   - Update type definition if `UserStaticRow` exists\n\n2. **`apps/backend/src/modules/users/dsr.service.ts`** (line 141)\n   - Change: `trx(\"user_static\")` → `trx(\"profiles\")`\n\n3. **`apps/backend/src/modules/users/__tests__/dsr.service.test.ts`** (lines 232, 321)\n   - Change: `ensureTable(\"user_static\")` → `ensureTable(\"profiles\")`\n   - Change: `tables.user_static` → `tables.profiles`\n\n4.", "source_file": "../../docs/2.Technical_Design_Document/MIGRATION_20251116_CODE_UPDATES.md", "category": "technical", "chunk_index": 0, "token_count": 214, "hash_short": "7287c87c", "version": 1.0, "title": "Code Updates Required for Schema Alignment Migrations", "mtime": "2025-11-24T01:07:01.959596", "ingested_at": "2025-11-30T04:00:42.213839", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES", "text": "end/src/modules/users/__tests__/dsr.service.test.ts`** (lines 232, 321)\n   - Change: `ensureTable(\"user_static\")` → `ensureTable(\"profiles\")`\n   - Change: `tables.user_static` → `tables.profiles`\n\n4. **`apps/backend/src/modules/points/points.repository.ts`** (line 255)\n   - Change: `exec<UserStaticRow>(\"user_static\")` → `exec<ProfileRow>(\"profiles\")`\n\n5. **`apps/backend/src/db/utils/verifyIntegrity.ts`** (line 11)\n   - Change: `\"user_static\"` → `\"profiles\"` in table list\n\n6. **`apps/backend/src/db/seeds/__tests__/seed-files.test.ts`** (lines 140, 142)\n   - Change: `name: \"user_static\"` → `name: \"profiles\"`\n   - Change: `table: \"user_static\"` → `table: \"profiles\"`\n\n### Type Definitions\n\n7. **Type definitions** - Search for `UserStaticRow` type and:\n   - Rename to `ProfileRow` or update to match new schema\n   - Add new fields: `alias`, `bio`, `avatar_asset_id`, `visibility`, `timezone`, `unit_preferences`\n\n### Database Schema Files\n\n8.", "source_file": "../../docs/2.Technical_Design_Document/MIGRATION_20251116_CODE_UPDATES.md", "category": "technical", "chunk_index": 1, "token_count": 236, "hash_short": "042e4e05", "version": 1.0, "title": "Code Updates Required for Schema Alignment Migrations", "mtime": "2025-11-24T01:07:01.959596", "ingested_at": "2025-11-30T04:00:42.213839", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES", "text": "type and:\n   - Rename to `ProfileRow` or update to match new schema\n   - Add new fields: `alias`, `bio`, `avatar_asset_id`, `visibility`, `timezone`, `unit_preferences`\n\n### Database Schema Files\n\n8. **`apps/backend/src/db/schema/fitvibe_schema.sql`** (line 41)\n   - Update schema dump to reflect `profiles` table name and new columns\n\n## Column Already Renamed: `exercises.owner` → `exercises.owner_id`\n\nThe column `exercises.owner` was already renamed to `exercises.owner_id` in migration `202510180001`.\nNo code changes needed - all references already use `owner_id`.\n\n## New Profile Fields\n\nAfter migration `202511160000`, the `profiles` table includes new fields:\n\n- `alias` (citext, unique, nullable)\n- `bio` (text, max 500 chars)\n- `avatar_asset_id` (uuid, FK to media_assets)\n- `visibility` (text, CHECK constraint)\n- `timezone` (text)\n- `unit_preferences` (jsonb)\n\nUpdate any code that reads/writes profile data to handle these new fields.\n\n## Migration Order\n\n1.", "source_file": "../../docs/2.Technical_Design_Document/MIGRATION_20251116_CODE_UPDATES.md", "category": "technical", "chunk_index": 2, "token_count": 243, "hash_short": "2bbe8f03", "version": 1.0, "title": "Code Updates Required for Schema Alignment Migrations", "mtime": "2025-11-24T01:07:01.959596", "ingested_at": "2025-11-30T04:00:42.213839", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_MIGRATION_20251116_CODE_UPDATES", "text": "ia_assets)\n- `visibility` (text, CHECK constraint)\n- `timezone` (text)\n- `unit_preferences` (jsonb)\n\nUpdate any code that reads/writes profile data to handle these new fields.\n\n## Migration Order\n\n1. Run migration `202511160000` (enhances user_static → profiles)\n2. Run migration `202511160001` (ensures exercises.owner_id, idempotent)\n3. Run migration `202511160002` (adds FK for avatar_asset_id, conditional)\n4. Update code references listed above\n5. Update type definitions\n6. Test all user/profile-related functionality\n\n## Testing Checklist\n\n- [ ] User registration creates profile record\n- [ ] Profile queries work with new table name\n- [ ] DSR (Data Subject Rights) deletion works\n- [ ] Points/leaderboard queries work\n- [ ] Seed data loads correctly\n- [ ] Integration tests pass", "source_file": "../../docs/2.Technical_Design_Document/MIGRATION_20251116_CODE_UPDATES.md", "category": "technical", "chunk_index": 3, "token_count": 196, "hash_short": "6bb75387", "version": 1.0, "title": "Code Updates Required for Schema Alignment Migrations", "mtime": "2025-11-24T01:07:01.959596", "ingested_at": "2025-11-30T04:00:42.213839", "tags": ["technical", "md"]}
