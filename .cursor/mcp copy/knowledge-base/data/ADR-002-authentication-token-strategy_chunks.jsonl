{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "# ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)\n\n> **File:** docs/adr/ADR-002-authentication-token-strategy.md  \n> **Purpose:** Decide the application-wide authentication and session strategy for FitVibe.\n\n---\n\nid: ADR-002\ntitle: \"Authentication & Session Strategy — JWT (RS256) with Refresh Token Rotation and Sliding Sessions\"\nstatus: \"Accepted\"\ndate: \"2025-10-13\"\nowners: [\"Dr. Konstantinos Pilpilidis\"]\nversion: \"1.0\"\nsupersedes: []\nlinks:\n\n- PRD: \"docs/1. Product Requirements Document.md#security--privacy\"\n- TDD: \"docs/2. Technical Design Document v2.md#authentication-authorization\"\n- QA: \"docs/3.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 0, "token_count": 159, "hash_short": "2e431634", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "version: \"1.0\"\nsupersedes: []\nlinks:\n\n- PRD: \"docs/1. Product Requirements Document.md#security--privacy\"\n- TDD: \"docs/2. Technical Design Document v2.md#authentication-authorization\"\n- QA: \"docs/3. Testing and Quality Assurance Plan.md#security-tests-and-slos\"\n- ADR-001: \"docs/adr/ADR-001-api-versioning-policy.md\"\n\n---\n\n\n## Context\n\nFitVibe’s web SPA and future native clients require an authentication mechanism that is:\n\n- **Secure by default** (privacy-by-design, GDPR-aligned)\n- **Browser-friendly** (protect against XSS/CSRF)\n- **Stateless for scale** (horizontal scaling across instances)\n- **Revocable** (account/device compromise response)\n- **Observable** (auditing, anomaly detection, SLOs)\n\nWe considered cookie-based server sessions (opaque IDs, Redis), opaque tokens, and JWT-based access + refresh flows. The platform will run behind a reverse proxy with TLS termination and expects multiple clients (SPA now; mobile in Phase 2).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 1, "token_count": 236, "hash_short": "a49c7e3e", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "(opaque IDs, Redis), opaque tokens, and JWT-based access + refresh flows. The platform will run behind a reverse proxy with TLS termination and expects multiple clients (SPA now; mobile in Phase 2).\n\n## Decision\n\nAdopt **JWT access tokens (RS256)** with **rotating refresh tokens** and **sliding session expiration**, using **HttpOnly, Secure cookies** for browser clients and **Authorization headers** for non-browser clients.\n\n### Token Model\n\n- **Access Token (AT)**: JWT (RS256), **short-lived** (10–15 min).  \n  Claims: `iss`, `aud`, `sub`, `exp`, `iat`, `nbf`, `jti`, `sid`, `scope`, `roles`, `locale`.  \n  Header includes `kid` for key rotation.\n- **Refresh Token (RT)**: Opaque, **one-time-use rotating token** with **reuse detection**. Stored **hashed** in DB. Lifetime **up to 30 days** (configurable) subject to **max_session_age**.\n- **Session**: Identified by `sid` stored with device metadata (UA, IP hash, platform, createdAt, lastUsedAt, revokedAt).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 2, "token_count": 241, "hash_short": "e04e74f7", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "B. Lifetime **up to 30 days** (configurable) subject to **max_session_age**.\n- **Session**: Identified by `sid` stored with device metadata (UA, IP hash, platform, createdAt, lastUsedAt, revokedAt).\n\n### Storage & Transport\n\n- **Browser**:\n  - `AT` in **HttpOnly, Secure, SameSite=Lax** cookie `at`, path `/`, domain app scope.\n  - `RT` in **HttpOnly, Secure, SameSite=Strict** cookie `rt`, path `/auth/refresh`.\n  - CSRF protection via **double-submit token** (header `X-CSRF-Token` matching a non-HttpOnly cookie) for **state-changing** requests.\n- **Mobile/API clients**: Bearer `Authorization` header for `AT`; `RT` exchanged via refresh endpoint using client-auth or signed body.\n\n### Rotation & Reuse Detection\n\n- On each refresh:\n  1. Validate existing RT against DB **hash** and **session state**.\n  2. Invalidate the used RT (rotate) and issue a **new RT** and **new AT**.\n  3. If a **reused** or invalid RT is presented, **revoke entire session** (`sid`) and require re-login.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 3, "token_count": 246, "hash_short": "c0d05afd", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "**session state**.\n  2. Invalidate the used RT (rotate) and issue a **new RT** and **new AT**.\n  3. If a **reused** or invalid RT is presented, **revoke entire session** (`sid`) and require re-login.\n- **Sliding session**: Extend session `expiresAt` on legitimate refreshes, capped by `max_session_age` (e.g., 30 days).\n\n### Key Management\n\n- **Asymmetric keys (RS256)** with `JWT_PRIVATE_KEY` / `JWT_PUBLIC_KEY`.\n- Use `kid` header and maintain a **JWKS** endpoint for current/previous public keys.\n- **Key rotation**: Planned **quarterly** or on incident; keep previous key active for overlap window.\n\n### Authorization\n\n- **RBAC** baked into tokens (`roles`, `scope`).\n- Enforce **least privilege** at route/method level.\n- Admin endpoints require elevated scopes and stricter rate limits.\n\n### Security Controls\n\n- **Rate limiting** on `/auth/*` and login by IP + account.\n- **Device/session management UI**: List & revoke sessions per device.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 4, "token_count": 236, "hash_short": "bac8fc6a", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "re elevated scopes and stricter rate limits.\n\n### Security Controls\n\n- **Rate limiting** on `/auth/*` and login by IP + account.\n- **Device/session management UI**: List & revoke sessions per device.\n- **Anomaly detection**: Alert on RT reuse, impossible travel, excessive refreshes.\n- **TLS everywhere**; cookies always `Secure`.\n- **Content Security Policy** and **no AT in JS-accessible storage** (avoid XSS exfiltration risk).\n\n## Consequences\n\n**Positive**\n\n- Strong revocation and compromise response via RT rotation & reuse detection.\n- Scales horizontally; JWT verification is stateless.\n- Works for SPA and future mobile/partner clients.\n\n**Trade-offs**\n\n- Added complexity (session store, RT rotation logic, reuse detection).\n- More moving parts (JWKS, key rotation ops).\n- Requires rigorous implementation and tests.\n\n## Alternatives Considered\n\n1. **Opaque server sessions (Redis) only**  \n   _Pros_: Simple revocation, familiar pattern.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 5, "token_count": 237, "hash_short": "6024bf13", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "(JWKS, key rotation ops).\n- Requires rigorous implementation and tests.\n\n## Alternatives Considered\n\n1. **Opaque server sessions (Redis) only**  \n   _Pros_: Simple revocation, familiar pattern.  \n   _Cons_: Sticky sessions or shared store; less suitable for third-party APIs; harder for zero-downtime deploys across regions.\n\n2. **JWT only without refresh**  \n   _Pros_: Simpler.  \n   _Cons_: Either very short AT (poor UX) or long AT (security risk); no sliding sessions; weak revocation.\n\n3. **LocalStorage tokens**  \n   _Pros_: Simple implementation.  \n   _Cons_: High XSS exfiltration risk; not acceptable for security posture.\n\n## Implementation Notes\n\n- **DB**: `auth.sessions` (sid PK), `auth.refresh_tokens` (hash, sid FK, revoked, expiresAt, createdAt, lastUsedAt, ipHash, ua).\n- **Endpoints**: `/auth/login`, `/auth/refresh`, `/auth/logout`, `/auth/sessions`, `/auth/revoke/:sid`.\n- **Cookies**: `at` (Lax), `rt` (Strict), `csrf` (non-HttpOnly).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 6, "token_count": 238, "hash_short": "bd5e1732", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "edAt, lastUsedAt, ipHash, ua).\n- **Endpoints**: `/auth/login`, `/auth/refresh`, `/auth/logout`, `/auth/sessions`, `/auth/revoke/:sid`.\n- **Cookies**: `at` (Lax), `rt` (Strict), `csrf` (non-HttpOnly).\n- **Headers**: `Authorization: Bearer <AT>`, `X-CSRF-Token` for mutations.\n- **Middleware**: JWT verify with `kid` → fetch public key; scope/role guards; CSRF for state-changing methods.\n- **Observability**: Emit audit logs for login, refresh, logout, revoke, RT reuse; metrics: `auth_login_success_total`, `auth_rt_reuse_total`, `auth_refresh_latency_ms` (p95).\n\n## QA & Acceptance\n\n- Contract tests for token issuance/refresh/reuse/revocation.\n- Playwright E2E ensures cookies are HttpOnly/SameSite and CSRF blocks forged requests.\n- Security tests: RT reuse triggers session revocation; key rotation keeps logins working.\n- Performance: p95 login/refresh < 300 ms; error rate < 0.5% under load.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 7, "token_count": 224, "hash_short": "723bb0c2", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-002-authentication-token-strategy", "text": "e and CSRF blocks forged requests.\n- Security tests: RT reuse triggers session revocation; key rotation keeps logins working.\n- Performance: p95 login/refresh < 300 ms; error rate < 0.5% under load.\n\n## Backout Plan\n\nIf critical issues arise (e.g., widespread RT reuse false-positives), **fallback to opaque server sessions** (Redis-backed) with `sid` cookie while investigating. Keep JWT verification for API auth but disable RT rotation temporarily by feature flag. Maintain a migration to clean stale RTs and close sessions on rollback.\n\n## Change Log\n\n- **1.0 (2025-10-13):** Initial acceptance.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-002-authentication-token-strategy.md", "category": "technical", "chunk_index": 8, "token_count": 149, "hash_short": "4dac5db9", "version": 1.0, "title": "ADR-002 — Authentication & Session Strategy (JWT RS256 with Refresh Rotation)", "mtime": "2025-10-18T10:54:49.790507", "ingested_at": "2025-11-30T04:00:44.064769", "tags": ["technical", "md"]}
