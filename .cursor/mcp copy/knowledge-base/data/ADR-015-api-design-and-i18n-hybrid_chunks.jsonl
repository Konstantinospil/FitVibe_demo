{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "# ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged\n\n**Date:** 2025-10-14  \n**Status:** Accepted  \n**Author:** Reviewer  \n**Cross-References:** PRD §5–§7 (API principles, security, i18n §6.14); TDD §3–§7 (routes, layering, idempotency), §10 (ops); QA §2–§14 (CI gates, perf/a11y/security)\n\n---\n\n\n## Context\n\nWe need a consistent REST API that is easy to consume, testable, and compliant with security and i18n requirements. The PRD specifies REST with strong security defaults, idempotent writes, and a **hybrid i18n** approach (static UI tokens; optional AI translation for UGC). The TDD locks the MVP to **static i18n only**, with dynamic UGC translation **deferred** and **behind a feature flag**. QA enforces budgets (API p95 < 300 ms) and regression gates, plus a11y and security scans.\n\nThis ADR defines the API style guide and how i18n concerns are represented at the API layer without violating MVP scope.\n\n---\n\n## Decision\n\n1.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 0, "token_count": 245, "hash_short": "4ca027ac", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "ms) and regression gates, plus a11y and security scans.\n\nThis ADR defines the API style guide and how i18n concerns are represented at the API layer without violating MVP scope.\n\n---\n\n## Decision\n\n1. **API Style & Versioning**\n   - **RESTful JSON over HTTPS**, base path `/api/v1`.\n   - **OpenAPI** spec generated in CI from route definitions and shared DTO/validators. Artifacts published with each build.\n   - **Backward compatibility:** additive changes preferred; deprecations announced with `Deprecation` header and doc changelog; removal after ≥2 minor versions.\n\n2. **Resource Modeling & Conventions**\n   - Plural nouns: `/users`, `/exercises`, `/sessions`, `/progress`, `/points`, `/feed`.\n   - **Nesting** only when ownership is strict (e.g., `/users/{id}/sessions`). Otherwise use query filters.\n   - **IDs:** expose ULIDs for public resources; server maintains internal PKs as needed.\n\n3. **Pagination, Filtering, Sorting**\n   - **Cursor-based** pagination: `?cursor=...&limit=50`.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 1, "token_count": 248, "hash_short": "b88fb7bb", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "ery filters.\n   - **IDs:** expose ULIDs for public resources; server maintains internal PKs as needed.\n\n3. **Pagination, Filtering, Sorting**\n   - **Cursor-based** pagination: `?cursor=...&limit=50`. Response includes `{ items, nextCursor }`.\n   - Filtering/sorting via whitelisted query params (`?userId=...&sort=-createdAt`).\n\n4. **Errors & Problem Details**\n   - Errors conform to **RFC 7807** style: `{ type, title, status, detail, instance, code }`.\n   - Domain errors mapped from `DomainError(code, message)` in the router. No DB error details are leaked.\n\n5. **Idempotency for Unsafe Writes**\n   - All `POST`/`PUT`/`PATCH` that create or mutate accept `Idempotency-Key` header.\n   - The service layer stores **24h** idempotency keys; **409** on payload mismatch; deterministic replay for identical payloads. Keys are **scoped to user+route**.\n\n6. **Security Defaults**\n   - **Auth:** Bearer **JWT RS256** access tokens; server-stored rotating refresh tokens.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 2, "token_count": 241, "hash_short": "b47b571b", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "deterministic replay for identical payloads. Keys are **scoped to user+route**.\n\n6. **Security Defaults**\n   - **Auth:** Bearer **JWT RS256** access tokens; server-stored rotating refresh tokens.\n   - **RBAC:** Coarse checks in router, fine-grained in services.\n   - **Headers:** CSP (no `unsafe-inline`), HSTS, Referrer-Policy, Permissions-Policy, strict CORS allowlist.\n   - **CSRF:** Protection on cookie-based flows and all state-changing routes when cookies are present.\n   - **Rate limits:** Per-IP and per-user token bucket; separate bucket for translation API if enabled.\n   - **Logging:** Correlation ID; no PII in logs.\n\n7. **Internationalization (API Facets)**\n   - **MVP:** API conveys UI language via `Accept-Language` (client optional); server returns UI text keys, not translated UI strings. Clients render UI using **static catalogs (EN/DE)**.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 3, "token_count": 214, "hash_short": "c8794913", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "acets)**\n   - **MVP:** API conveys UI language via `Accept-Language` (client optional); server returns UI text keys, not translated UI strings. Clients render UI using **static catalogs (EN/DE)**.\n   - **UGC Translation (Feature-flagged, Phase 2):**\n     - Endpoint capability signaled via response capability object (e.g., `{ capabilities: { ugcTranslation: true } }`) when the flag is enabled.\n     - Translation is performed server-side via `POST /i18n/translate` (internal call from services), **not** exposed directly to clients.\n     - **Caching:** hash(text+targetLang) as key; TTL configured; invalidation on source edit/delete.\n     - **Privacy:** PII redaction before provider call; cache stores redacted text only; DSR delete purges entries within ≤14 days.\n     - **UX hints:** payloads carrying translated text include `{ translated: true, originalLanguage: \"xx\", notice: \"Translated from …\" }`.\n\n8.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 4, "token_count": 228, "hash_short": "799e5bd0", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "d text only; DSR delete purges entries within ≤14 days.\n     - **UX hints:** payloads carrying translated text include `{ translated: true, originalLanguage: \"xx\", notice: \"Translated from …\" }`.\n\n8. **Content Negotiation & Localization Hints**\n   - API may include localized, non-UGC labels (e.g., enums) **if** they originate from static catalogs; otherwise it returns keys and clients map them.\n   - All date/time fields are ISO-8601 in UTC; clients apply locale formatting.\n\n9. **Performance Budgets & Caching at API Edge**\n   - **Budgets:** API **p95 < 300 ms** overall; auth ≤200 ms; feed ≤400 ms; analytics ≤600 ms.\n   - **Cache-Control** used for safe GETs where applicable; ETags supported for conditional requests.\n   - CI **fails on >10% regression** against baseline k6 smoke.\n\n10. **Observability**\n    - Prometheus metrics by route (`http_server_requests_seconds_bucket`), auth failures, cache hits, translation latency (`i18n_translation_latency_ms`).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 5, "token_count": 241, "hash_short": "c3d8d725", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "aseline k6 smoke.\n\n10. **Observability**\n    - Prometheus metrics by route (`http_server_requests_seconds_bucket`), auth failures, cache hits, translation latency (`i18n_translation_latency_ms`).\n    - OpenTelemetry tracing enabled for HTTP and DB spans with correlation IDs propagated.\n\n11. **Documentation & SDKs**\n    - OpenAPI generated clients for **TypeScript** in `packages/shared` (SDK), versioned with the app.\n    - Changelog and migration notes per API release; code samples validated in CI.\n\n---\n\n## Consequences\n\n**Positive**\n\n- Clear, testable API style with idempotency and error contracts; aligned with PRD security/i18n and TDD layering.\n- MVP ships without UGC translation risk; Phase-2 enables it safely behind a flag with caching and privacy controls.\n- QA can assert budgets, headers, and compatibility via generated OpenAPI and Playwright flows.\n\n**Negative / Trade-offs**\n\n- Cursor pagination requires client handling of `nextCursor`.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 6, "token_count": 239, "hash_short": "e98cbea3", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "acy controls.\n- QA can assert budgets, headers, and compatibility via generated OpenAPI and Playwright flows.\n\n**Negative / Trade-offs**\n\n- Cursor pagination requires client handling of `nextCursor`.\n- Maintaining OpenAPI generation and SDK publishing adds CI complexity (acceptable for benefits).\n\n**Operational**\n\n- Feature flags must be pinned in environment (prod off).\n- Idempotency key store monitored for TTL eviction and storage growth; alerts if collision rate > expected baseline.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 7, "token_count": 122, "hash_short": "1a470453", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "its).\n\n**Operational**\n\n- Feature flags must be pinned in environment (prod off).\n- Idempotency key store monitored for TTL eviction and storage growth; alerts if collision rate > expected baseline.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 8, "token_count": 49, "hash_short": "64b215f9", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid_chunk_009", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-015-api-design-and-i18n-hybrid", "text": "---\n\n## Alternatives Considered\n\n| Option                  | Description           | Reason Rejected                                                                  |\n| ----------------------- | --------------------- | -------------------------------------------------------------------------------- |\n| Offset-based pagination | `?page=1&size=50`     | Hotspot pages and drift under writes; cursor is more stable and efficient        |\n| GraphQL                 | Single graph endpoint | Added infra/complexity for MVP; REST satisfies PRD/TDD and improves cacheability |\n| Client-side translation | Use SDKs in browser   | Violates privacy model and observability; caching harder; not aligned with PRD   |\n\n---\n\n## References\n\n- PRD: API principles, security baselines, hybrid i18n (§6.14)\n- TDD: Layered architecture, idempotency policy, MVP i18n scope (static)\n- QA: CI gates (security, perf, a11y), regression thresholds, API budgets\n\n---\n\n## Status Log\n\n| Version | Date       | Change                                                                                      | Author   |\n| ------- | ---------- | ------------------------------------------------------------------------------------------- | -------- |\n| v1.0    | 2025-10-14 | Initial ADR for API design & i18n hybrid with MVP static-only and flaggable UGC translation | Reviewer |", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-015-api-design-and-i18n-hybrid.md", "category": "technical", "chunk_index": 9, "token_count": 337, "hash_short": "30cfa620", "version": 1.0, "title": "ADR-015: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged", "mtime": "2025-10-18T10:54:49.976537", "ingested_at": "2025-11-30T04:00:44.126233", "tags": ["technical", "md"]}
