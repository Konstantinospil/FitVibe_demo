{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics", "text": "# ADR-008 — Materialized Views for Analytics\n\n> **File:** docs/adr/ADR-008-materialized-views-for-analytics.md  \n> **Purpose:** Provide fast read paths for dashboards and reports without impacting OLTP workload.\n\n---\n\nid: ADR-008\ntitle: \"Materialized Views for Analytics\"\nstatus: \"Proposed\"\ndate: \"2025-10-13\"\nowners: [\"Dr. Konstantinos Pilpilidis\"]\nversion: \"1.0\"\nlinks:\n\n- TDD §4.5: \"Reporting & analytics\"\n- TDD §6.3: \"Performance architecture\"\n\n---\n\n\n## Context\n\nDashboards need quick aggregates (e.g., weekly volume, PRs, exercise counts). Computing these over raw `sessions` and `sets` on every page load is expensive and affects OLTP. We need **pre‑computed** aggregates with predictable refresh.\n\n## Decision\n\nUse **PostgreSQL Materialized Views** for:\n\n- `analytics.session_summary` — per session aggregates (total volume, duration, avg RPE).\n- `analytics.weekly_aggregates` — per user, per week KPIs (distance, time, volume, sessions).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-008-materialized-views-for-analytics.md", "category": "technical", "chunk_index": 0, "token_count": 236, "hash_short": "550e3514", "version": 1.0, "title": "ADR-008 — Materialized Views for Analytics", "mtime": "2025-10-18T10:54:49.865023", "ingested_at": "2025-11-30T04:00:44.097537", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics", "text": "Views** for:\n\n- `analytics.session_summary` — per session aggregates (total volume, duration, avg RPE).\n- `analytics.weekly_aggregates` — per user, per week KPIs (distance, time, volume, sessions).\n\n### Refresh Strategy\n\n- **Incremental on write (near‑real‑time)**: After successful commit of `core.sets`/`core.sessions`, enqueue a small job to refresh **only affected partitions** or **parameterized subsets** via **REFRESH MATERIALIZED VIEW CONCURRENTLY** with filters (when feasible using helper tables).\n- **Scheduled full refresh**: Nightly **02:00** UTC job to run `REFRESH ... CONCURRENTLY` for both views.\n- **Staging tables**: Maintain `analytics.staging_changes(user_id, session_id, week)` fed by triggers or app events; refresh jobs read and clear this table.\n\n### Indexing\n\n- Create indexes on matviews for typical filters: `(user_id, week_start)` for weekly, `(user_id, session_id)` for session summary.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-008-materialized-views-for-analytics.md", "category": "technical", "chunk_index": 1, "token_count": 229, "hash_short": "3f8d5884", "version": 1.0, "title": "ADR-008 — Materialized Views for Analytics", "mtime": "2025-10-18T10:54:49.865023", "ingested_at": "2025-11-30T04:00:44.097537", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-008-materialized-views-for-analytics", "text": "app events; refresh jobs read and clear this table.\n\n### Indexing\n\n- Create indexes on matviews for typical filters: `(user_id, week_start)` for weekly, `(user_id, session_id)` for session summary.\n\n### Consistency\n\n- Readers tolerate slight staleness; dashboards show `as of <timestamp>` from matview `last_refresh_at` column.\n\n## Consequences\n\n- Faster dashboards; reduced OLTP contention.\n- Additional complexity (refresh jobs and staging).\n\n## Alternatives Considered\n\n- **On‑the‑fly views**: Simpler but slow under load.\n- **External OLAP**: Future option; overkill for MVP.\n\n## QA & Acceptance\n\n- E2E tests: creating/updating/deleting sessions updates aggregates after refresh.\n- Performance tests: dashboard queries p95 < 150 ms using matviews.\n\n## Backout Plan\n\nDisable incremental refresh and rely solely on nightly refresh; if still problematic, fall back to normal SQL views while we redesign.\n\n## Change Log\n\n- **1.0 (2025-10-13):** Initial proposal.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-008-materialized-views-for-analytics.md", "category": "technical", "chunk_index": 2, "token_count": 240, "hash_short": "8fb4b2b5", "version": 1.0, "title": "ADR-008 — Materialized Views for Analytics", "mtime": "2025-10-18T10:54:49.865023", "ingested_at": "2025-11-30T04:00:44.097537", "tags": ["technical", "md"]}
