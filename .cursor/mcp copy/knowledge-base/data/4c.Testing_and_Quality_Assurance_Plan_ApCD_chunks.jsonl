{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_000", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "﻿---\ntitle: \"FitVibe — Testing & Quality Assurance Plan\"\nversion: \"v3.0\"\nstatus: \"Approved (MVP → GA baseline)\"\nreview_cadence: \"Per release and quarterly\"\ndate: \"2025-10-26\"\nlicense: \"MIT\"\n---\n\n# Appendix C — CI Gate Snippets (indicative)\n\n# C.1 Objectives & Policy\n\nThis appendix defines **enforceable CI/CD gates** that map directly to the **Acceptance Criteria** and **RTM**. Any gate breach **fails the pipeline**. Waivers require **ID, rationale, expiry, approver (PO+Tech+QA)**, and are tracked as artifacts and issues.\n\n**Top-level gates (blockers):**\n\n- Coverage thresholds: repo ≥ **80%** lines & branches; critical areas (auth/sessions/points) ≥ **90%**.\n- Perf budgets (p95): **auth ≤200ms · crud ≤300ms · feed ≤400ms · analytics ≤600ms**; regression guard **≤10%**.\n- A11y: Lighthouse/axe score ≥ **90** on tracked screens.\n- Visual: diff ≤ **0.2%** on critical pages; tokens & contrast checks pass.\n- Security: **0 High/Critical** (SCA/ZAP/Images); headers policy enforced.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 0, "token_count": 246, "hash_short": "990f7d7e", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_001", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "ighthouse/axe score ≥ **90** on tracked screens.\n- Visual: diff ≤ **0.2%** on critical pages; tokens & contrast checks pass.\n- Security: **0 High/Critical** (SCA/ZAP/Images); headers policy enforced.\n- Observability: metrics contract passes (`/metrics` required series).\n- Supply chain: **SBOM + cosign verify + pinned digests**.\n- Release safety: feature flags default **off** in prod; rollback smoke passes.\n\n---\n\n# C.2 Pipeline Overview\n\nStages (some parallelized):\n\n1. **static** (lint, typecheck)\n2. **unit+int** (coverage enforced)\n3. **contract** (OpenAPI + DB)\n4. **e2e** (Playwright + traces)\n5. **a11y** (axe + Lighthouse)\n6. **perf** (k6 budgets + regression guard)\n7. **security** (SCA + ZAP baseline + image scan)\n8. **visual** (snapshots + tokens + contrast)\n9. **observability** (metrics contract)\n10. **package** (SBOM, sign, verify, digest pinning)\n11.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 1, "token_count": 217, "hash_short": "b9ec4bd6", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_002", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "guard)\n7. **security** (SCA + ZAP baseline + image scan)\n8. **visual** (snapshots + tokens + contrast)\n9. **observability** (metrics contract)\n10. **package** (SBOM, sign, verify, digest pinning)\n11. **deploy:staging** (manual) → **release-safety smoke** → **UAT sign‑off** → **deploy:prod**\n\n---\n\n# C.3 GitHub Actions (reference YAML)\n\n> Save as `.github/workflows/ci.yml`\n\n```yaml\nname: CI\non:\n  pull_request:\n    branches: [main]\n  push:\n    branches: [main]\n  workflow_dispatch: { {} }\n\nenv:\n  NODE_OPTIONS: --max-old-space-size=4096\n  PNPM_CACHE_DIR: .pnpm-store\n  PLAYWRIGHT_BROWSERS_PATH: 0\n\nconcurrency:\n  group: ci-${{ github.ref }}\n  cancel-in-progress: true\n\njobs:\n  setup:\n    runs-on: ubuntu-latest\n    outputs:\n      cache-hit: ${{{{ steps.cache-pnpm.outputs.cache-hit }}}}\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: \"pnpm\"\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - id: cache-pnpm\n        uses: actions/cache@v4\n        with:\n          path: |\n            .pnpm-store\n            node_modules\n          key: pnpm-${{{{ runner.os }}}}-${{{{ hashFiles('**/pnpm-lock.yaml') }}}}\n      - run: pnpm install --frozen-lockfile\n\n  static:\n    needs: setup\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm -w lint && pnpm -w typecheck\n\n  unit_int:\n    needs: static\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm -w test -- --coverage --maxWorkers=2\n      - name: Enforce coverage thresholds\n        run: node ./scripts/ci/assert-coverage.mjs 80 80 90:auth,sessions,points\n      - uses: actions/upload-artifact@v4\n        with:\n          name: coverage-html\n          path: coverage\n\n  contract:\n    needs: unit_int\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm --filter backend contract:test # zod ↔ OpenAPI\n      - run: pnpm --filter backend db:contracts # index/FK/migration guards\n      - uses: actions/upload-artifact@v4\n        with:\n          name: contract-reports\n          path: reports/contract\n\n  e2e:\n    needs: unit_int\n    runs-on: ubuntu-latest\n    strategy:\n      fail-fast: false\n      matrix:\n        browser: [chromium, firefox, webkit]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm --filter frontend e2e -- --project ${{{{ matrix.browser }}}}\n      - uses: actions/upload-artifact@v4\n        with:\n          name: playwright-traces-${{{{ matrix.browser }}}}\n          path: playwright-report\n\n  a11y:\n    needs: e2e\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm --filter frontend a11y # axe + Lighthouse\n      - run: node ./scripts/ci/assert-lighthouse.mjs 90\n      - uses: actions/upload-artifact@v4\n        with:\n          name: accessibility-reports\n          path: reports/accessibility\n\n  perf:\n    needs: contract\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: grafana/setup-k6@v1\n      - run: k6 run tests/perf/k6/budgets.js --out json=reports/perf.json\n      - run: node tests/perf/k6/assert-budgets.mjs reports/perf.json               --groups auth:200 crud:300 feed:400 analytics:600               --regression 10\n      - uses: actions/upload-artifact@v4\n        with:\n          name: perf-k6\n          path: reports/perf.json\n\n  security:\n    needs: [unit_int, contract]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Dependency audit (npm/OSV)\n        run: pnpm -w audit:ci\n      - name: Container scan (Trivy)\n        uses: aquasecurity/trivy-action@0.24.0\n        with:\n          image-ref: ghcr.io/org/fitvibe:ci\n          severity: HIGH,CRITICAL\n          exit-code: \"1\"\n      - name: ZAP baseline\n        uses: zaproxy/action-baseline@v0.11.0\n        with:\n          target: ${{{{ secrets.STAGING_URL }}}}\n          rules_file_name: .zap/rules.tsv\n          cmd_options: -a -I\n      - uses: actions/upload-artifact@v4\n        with:\n          name: zap-report\n          path: zap\n\n  visual:\n    needs: e2e\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n        with: { { version: 9 } }\n      - run: pnpm --filter frontend test:visual\n      - run: node scripts/ci/assert-visual.mjs --maxDiff 0.002\n      - uses: actions/upload-artifact@v4\n        with:\n          name: visual-diffs\n          path: reports/visual\n\n  observability:\n    needs: contract\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - run: node tests/metrics/assert-prom.js\n      - uses: actions/upload-artifact@v4\n        with:\n          name: metrics-contract\n          path: reports/metrics\n\n  package:\n    needs: [security, perf, a11y, visual, observability]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Build image\n        run: docker build -t ghcr.io/org/fitvibe:${{{{ github.sha }}}}", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 2, "token_count": 1341, "hash_short": "d16363fd", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_003", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": ", a11y, visual, observability]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Build image\n        run: docker build -t ghcr.io/org/fitvibe:${{{{ github.sha }}}} .", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 3, "token_count": 50, "hash_short": "7b94c752", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_004", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "visual, observability]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Build image\n        run: docker build -t ghcr.io/org/fitvibe:${{{{ github.sha }}}} .\n      - name: SBOM (Syft)\n        uses: anchore/sbom-action@v0\n        with:\n          image: ghcr.io/org/fitvibe:${{{{ github.sha }}}}\n          output-file: reports/sbom.json\n      - name: Cosign sign\n        run: cosign sign --key env://COSIGN_KEY ghcr.io/org/fitvibe:${{{{ github.sha }}}}\n        env:\n          COSIGN_KEY: ${{{{ secrets.COSIGN_KEY }}}}\n      - name: Cosign verify\n        run: cosign verify --key env://COSIGN_PUB ghcr.io/org/fitvibe:${{{{ github.sha }}}}\n        env:\n          COSIGN_PUB: ${{{{ secrets.COSIGN_PUB }}}}\n      - name: Enforce pinned digests\n        run: node scripts/ci/assert-pinned-digests.mjs k8s/deploy/*.yaml\n      - uses: actions/upload-artifact@v4\n        with:\n          name: supply-chain\n          path: reports\n\n  deploy_staging:\n    if: github.ref == 'refs/heads/main'\n    needs: package\n    runs-on: ubuntu-latest\n    environment:\n      name: staging\n      url: ${{{{ secrets.STAGING_URL }}}}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Deploy\n        run: ./scripts/deploy.sh staging ${{{{ github.sha }}}}\n\n  release_safety:\n    needs: deploy_staging\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - run: pnpm -w flag:assert-defaults # must be off in prod config\n      - run: pnpm --filter frontend smoke:rollback\n      - run: node scripts/ci/assert-release-safety.mjs\n\n  uat_gate:\n    needs: release_safety\n    runs-on: ubuntu-latest\n    steps:\n      - name: Require UAT sign-off\n        run: node scripts/ci/assert-uat.mjs\n\n  deploy_prod:\n    if: github.event_name == 'workflow_dispatch'\n    needs: uat_gate\n    runs-on: ubuntu-latest\n    environment:\n      name: production\n      url: ${{{{ secrets.PROD_URL }}}}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Deploy\n        run: ./scripts/deploy.sh prod ${{{{ github.sha }}}}\n```\n\n---", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 4, "token_count": 510, "hash_short": "ebe62e1e", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_005", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "t:\n      name: production\n      url: ${{{{ secrets.PROD_URL }}}}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Deploy\n        run: ./scripts/deploy.sh prod ${{{{ github.sha }}}}\n```\n\n---\n\n\n# C.4 Assertion Scripts (key snippets)\n\n**Coverage gate (`scripts/ci/assert-coverage.mjs`):**\n\n```js\nimport fs from \"node:fs\";\nconst summary = JSON.parse(fs.readFileSync(\"coverage/coverage-summary.json\", \"utf8\"));\nconst repoLines = summary.total.lines.pct;\nconst repoBranches = summary.total.branches.pct;\nconst [minLines, minBranches, criticalSpec] = process.argv.slice(2);\nif (repoLines < minLines || repoBranches < minBranches) process.exit(1);\n// Critical packages threshold (e.g., 90%)\nconst [pct, list] = criticalSpec.split(\":\");\nconst critical = list.split(\",\");\nfor (const pkg of critical) {\n  {\n    /* read per-package coverage & assert ≥ pct */\n  }\n}\n```\n\n**Perf budgets (`tests/perf/k6/assert-budgets.mjs`):**\n\n```js\n// Parse k6 JSON, compute p95 by group, compare to budgets; also enforce ≤10% regression vs baseline stored in artifact", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 5, "token_count": 262, "hash_short": "a3616257", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_006", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "pct */\n  }\n}\n```\n\n**Perf budgets (`tests/perf/k6/assert-budgets.mjs`):**\n\n```js\n// Parse k6 JSON, compute p95 by group, compare to budgets; also enforce ≤10% regression vs baseline stored in artifact.\n```\n\n**Visual diff gate (`scripts/ci/assert-visual.mjs`):**\n\n```js\n// Read Playwright diff artifacts; assert maxDiffPixelRatio ≤ 0.002 (0.2%)\n```\n\n**Metrics contract (`tests/metrics/assert-prom.js`):**\n\n- Implements checks from **Appendix E** (names, labels, buckets, sample presence).\n\n**Pinned digests (`scripts/ci/assert-pinned-digests.mjs`):**\n\n```js\n// Fail if any image reference is not a sha256 digest.\n```\n\n---\n\n# C.5 Artifacts & Retention\n\n- **coverage-html**, **playwright-traces-\\***, **accessibility-reports**, **perf-k6**, **zap-report**, **visual-diffs**, **metrics-contract**, **supply-chain**.\n- Retain **30 days** (or until next release) for auditability.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 6, "token_count": 218, "hash_short": "69626865", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_007", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "aywright-traces-\\***, **accessibility-reports**, **perf-k6**, **zap-report**, **visual-diffs**, **metrics-contract**, **supply-chain**.\n- Retain **30 days** (or until next release) for auditability.\n\n---\n\n# C.6 Waivers (temporary policy)\n\nWaiver file schema (`reports/waivers.json`):\n\n```json\n{{ \"id\":\"WVR-2025-001\", \"gate\":\"PERF-P95\", \"reason\":\"Cold cache incident\", \"expires\":\"2025-11-15\", \"approver\":\"QA Lead + PO + Tech\", \"issue\":\"#1234\" }}\n```\n\nCI step **must** validate expiry and approvers; expired waivers **fail**.\n\n---\n\n# C.7 Secrets, Caching & Parallelism\n\n- Secrets in **GitHub Environments**; short‑lived tokens preferred.\n- PNPM & Playwright caches enabled; browsers vendored via action.\n- Parallel E2E across browsers; **fail-fast: false** to collect full signal.\n\n---\n\n# C.8 Required Status Checks (branch protection)\n\nEnable **required checks**: `static`, `unit_int`, `contract`, `e2e`, `a11y`, `perf`, `security`, `visual`, `observability`, `package`.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 7, "token_count": 242, "hash_short": "019546b8", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_008", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "signal.\n\n---\n\n# C.8 Required Status Checks (branch protection)\n\nEnable **required checks**: `static`, `unit_int`, `contract`, `e2e`, `a11y`, `perf`, `security`, `visual`, `observability`, `package`.\n\n---\n\n# C.9 Local Parity\n\nProvide `pnpm ci:all` to reproduce CI locally: runs all gates with sane defaults.\n\n---\n\n# C.10 Maintenance\n\n- Update thresholds in lockstep with **PRD/TDD/AC** changes.\n- Review flaky tests weekly; quarantine maximum **1 sprint** with issue link.\n- Revisit perf budgets quarterly with traffic & infra data.\n\n---\n\n# Appendix D — Visual Snapshot Config (Playwright)\n\n# D.1 Purpose\n\nDefine a **deterministic, reviewable system** for visual regression testing that protects FitVibe’s UI and **design tokens** across themes, breakpoints, and locales. Visual diffs are **release-blocking** per AC **VIZ-SNAP-02**, **VIZ-TOK-03**, **VIZ-RESP-05**, **VIZ-MOTION-09**.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 8, "token_count": 221, "hash_short": "8b9169b5", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_009", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "protects FitVibe’s UI and **design tokens** across themes, breakpoints, and locales. Visual diffs are **release-blocking** per AC **VIZ-SNAP-02**, **VIZ-TOK-03**, **VIZ-RESP-05**, **VIZ-MOTION-09**.\n\n**Gate:** Any unapproved diff > **0.2%** (maxDiffPixelRatio **0.002**) or token/contrast violation **fails** the pipeline.\n\n---\n\n# D.2 Scope\n\n- Pages: **Auth**, **Planner**, **Logger**, **Dashboard**, **Feed**, **Profile**, **Settings**.\n- Components (critical): **Navbar**, **SessionCard**, **ExerciseRow**, **PointBadge**, **ChartPanel**, **Toast**.\n- Themes: **light** and **dark**.\n- Breakpoints: **xs(360)**, **sm(640)**, **md(1024)**, **lg(1280)**.\n- Locales: **EN** and **DE** (long-string stress on DE).\n- Modes: **reduced-motion on/off**.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 9, "token_count": 186, "hash_short": "7a1bc7fb", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_010", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "*.\n- Themes: **light** and **dark**.\n- Breakpoints: **xs(360)**, **sm(640)**, **md(1024)**, **lg(1280)**.\n- Locales: **EN** and **DE** (long-string stress on DE).\n- Modes: **reduced-motion on/off**.\n\n---\n\n# D.3 Test Matrix\n\n| Page/Component   | Themes     | Breakpoints    | Locales | Motion | Notes                        |\n| ---------------- | ---------- | -------------- | ------- | ------ | ---------------------------- |\n| Auth             | light/dark | xs, sm         | EN/DE   | both   | captcha placeholder masked   |\n| Planner          | light/dark | sm, md, lg     | EN/DE   | both   | date/time masked             |\n| Logger           | light/dark | sm, md         | EN/DE   | both   | live counters masked         |\n| Dashboard        | light/dark | xs, sm, md, lg | EN/DE   | both   | chart animations/data masked |\n| Feed             | light/dark | md, lg         | EN/DE   | both   | avatars/timestamps masked    |\n| Profile/Settings | light/dark | sm, md         | EN/DE   | both   | avatar masked                |\n\n---", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 10, "token_count": 259, "hash_short": "8513d193", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_011", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "| light/dark | md, lg         | EN/DE   | both   | avatars/timestamps masked    |\n| Profile/Settings | light/dark | sm, md         | EN/DE   | both   | avatar masked                |\n\n---\n\n\n# D.4 Determinism Controls\n\n- **FakeClock**: freeze time to static UTC (e.g., `2025-10-01T12:00:00Z`).\n- **Seeded data**: deterministic fixtures for sessions/exercises/points.\n- **Network stability**: mock analytics; record/replay API with MSW.\n- **Font loading**: self-hosted test fonts (no FOIT/FOUT); CSS `font-display: swap` disabled in tests.\n- **Animations**: set `prefers-reduced-motion` for baseline; validate parity when **on**.\n- **Dynamic regions masked**: timestamps, avatars, sparklines, animated loaders.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 11, "token_count": 177, "hash_short": "aa24de2a", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_012", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "y: swap` disabled in tests.\n- **Animations**: set `prefers-reduced-motion` for baseline; validate parity when **on**.\n- **Dynamic regions masked**: timestamps, avatars, sparklines, animated loaders.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 12, "token_count": 49, "hash_short": "d185947d", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_013", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "---\n\n# D.5 Repository Layout\n\n```\napps/frontend/\n├─ tests/visual/\n│  ├─ config/\n│  │  ├─ playwright.config.ts\n│  │  ├─ mask.ts\n│  │  ├─ themes.ts\n│  │  ├─ viewport.ts\n│  ├─ helpers/\n│  │  ├─ fakeClock.ts\n│  │  ├─ msw.ts\n│  │  └─ seed.ts\n│  ├─ pages/\n│  │  ├─ auth.spec.ts\n│  │  ├─ planner.spec.ts\n│  │  ├─ logger.spec.ts\n│  │  ├─ dashboard.spec.ts\n│  │  ├─ feed.spec.ts\n│  │  └─ profile_settings.spec.ts\n│  └─ components/\n│     ├─ navbar.spec.tsx\n│     ├─ sessionCard.spec.tsx\n│     └─ pointBadge.spec.tsx\n└─ reports/visual/   # diff artifacts (CI uploads)\n```\n\n---\n\n# D.6 Playwright Config (reference)\n\n> Save as `apps/frontend/tests/visual/config/playwright.config.ts`\n\n```ts\nimport { defineConfig, devices } from \"@playwright/test\";\n\nconst light = { name: \"light\", colorScheme: \"light\" as const };\nconst dark = { name: \"dark\", colorScheme: \"dark\" as const };\n\nconst viewports = [\n  { name: \"xs\", width: 360, height: 900 },\n  { name: \"sm\", width: 640, height: 900 },\n  { name: \"md\", width: 1024, height: 900 },\n  { name: \"lg\", width: 1280, height: 900 },\n];\n\nexport default defineConfig({\n  testDir: \"../\",\n  reporter: [[\"html\", { outputFolder: \"../../playwright-report\" }], [\"list\"]],\n  use: {\n    baseURL: process.env.APP_URL || \"http://localhost:5173\",\n    timezoneId: \"UTC\",\n    locale: \"en-US\",\n    geolocation: { latitude: 52.52, longitude: 13.405 }, // Berlin for consistency\n    colorScheme: \"light\",\n    viewport: { width: 1024, height: 900 },\n    video: \"off\",\n    trace: \"on-first-retry\",\n  },\n  projects: [\n    ...[light, dark].flatMap((theme) =>\n      viewports.map((vp) => ({\n        name: `ui:${theme.name}:${vp.name}`,\n        use: { colorScheme: theme.colorScheme, viewport: { width: vp.width, height: vp.height } },\n      })),\n    ),\n  ],\n  expect: {\n    toHaveScreenshot: { maxDiffPixelRatio: 0.002 }, // 0.2%\n  },\n});\n```\n\n---", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 13, "token_count": 462, "hash_short": "681e4e7c", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_014", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "{ colorScheme: theme.colorScheme, viewport: { width: vp.width, height: vp.height } },\n      })),\n    ),\n  ],\n  expect: {\n    toHaveScreenshot: { maxDiffPixelRatio: 0.002 }, // 0.2%\n  },\n});\n```\n\n---\n\n\n# D.7 Helper: Fake Clock & MSW\n\n```ts\n// helpers/fakeClock.ts\nimport { Page } from \"@playwright/test\";\nexport async function freezeTime(page: Page, iso = \"2025-10-01T12:00:00.000Z\") {\n  await page.addInitScript(`{\n    // Override Date.now and new Date()\n    const fixed = ${Date.parse(\"2025-10-01T12:00:00.000Z\")};\n    Date.now = () => fixed;\n    const _Date = Date;\n    // @ts-ignore\n    globalThis.Date = class extends _Date { constructor(...args){ super(args.length ?", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 14, "token_count": 167, "hash_short": "cbdb2bd7", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_015", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "${Date.parse(\"2025-10-01T12:00:00.000Z\")};\n    Date.now = () => fixed;\n    const _Date = Date;\n    // @ts-ignore\n    globalThis.Date = class extends _Date { constructor(...args){ super(args.length ?", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 15, "token_count": 49, "hash_short": "b515016c", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_016", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "args[0] : fixed); } };\n  }`);\n}\n```\n\n```ts\n// helpers/msw.ts - mock analytics + network stability\nexport async function installNetworkGuards(page) {\n  await page.route(\"**/analytics/**\", (r) => r.fulfill({ status: 204 }));\n  await page.route(\"**/*\", async (route, req) => {\n    if ([\".png\", \".jpg\", \".webp\", \".gif\", \".svg\"].some((ext) => req.url().endsWith(ext))) {\n      return route.fulfill({ status: 200, body: \"\" });\n    }\n    return route.continue();\n  });\n}\n```\n\n---\n\n# D.8 Helper: Masking Dynamic Regions\n\n```ts\n// config/mask.ts\nimport { Page, Locator } from \"@playwright/test\";\nexport function dynamicMasks(page: Page): Locator[] {\n  return [\n    page.locator(\"[data-dynamic]\"),\n    page.locator('[data-testid=\"timestamp\"]'),\n    page.locator('[data-testid=\"avatar\"] img'),\n    page.locator('[data-testid=\"chart\"] canvas'),\n    page.locator(\".animated,.skeleton,.loader\"),\n  ];\n}\n```\n\n---\n\n# D.9 Example Page Test (Dashboard)\n\n```ts\n// pages/dashboard.spec.ts\nimport { test, expect } from \"@playwright/test\";\nimport { freezeTime } from \"../helpers/fakeClock\";\nimport { installNetworkGuards } from \"../helpers/msw\";\nimport { dynamicMasks } from \"../config/mask\";\n\ntest.describe(\"Dashboard visual\", () => {\n  test.beforeEach(async ({ page }) => {\n    await freezeTime(page);\n    await installNetworkGuards(page);\n  });\n\n  for (const locale of [\"en\", \"de\"]) {\n    for (const motion of [\"reduced\", \"full\"]) {\n      test(`dashboard snapshot ${locale} ${motion}`, async ({ page }) => {\n        await page.addInitScript(() => {\n          const mq = window.matchMedia(\"(prefers-reduced-motion: reduce)\");\n          Object.defineProperty(mq, \"matches\", { value: true });\n        });\n        if (motion === \"full\") {\n          await page.addStyleTag({ content: \":root { --reduce-motion: 0 }\" });\n        }\n        await page.goto(`/dashboard?locale=${locale}`);\n        await page.waitForSelector('[data-ready=\"true\"]');\n        await expect(page).toHaveScreenshot(`dashboard-${locale}-${motion}.png`, {\n          mask: dynamicMasks(page),\n        });\n      });\n    }\n  }\n});\n```\n\n---", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 16, "token_count": 520, "hash_short": "5222ead8", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_017", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "ForSelector('[data-ready=\"true\"]');\n        await expect(page).toHaveScreenshot(`dashboard-${locale}-${motion}.png`, {\n          mask: dynamicMasks(page),\n        });\n      });\n    }\n  }\n});\n```\n\n---\n\n\n# D.10 Component Snapshot Example (SessionCard)\n\n```tsx\n// components/sessionCard.spec.tsx\nimport { test, expect } from \"@playwright/experimental-ct-react\";\nimport SessionCard from \"@/components/SessionCard\";\nimport { dynamicMasks } from \"../config/mask\";\n\ntest.use({ viewport: { width: 640, height: 420 } });\n\ntest(\"SessionCard states\", async ({ mount, page }) => {\n  const props = { title: \"5×5 Squats\", points: 120, plannedAt: \"2025-10-01\" };\n  await mount(<SessionCard {...props} state=\"planned\" />);\n  await expect(page).toHaveScreenshot(\"sessionCard-planned.png\", { mask: dynamicMasks(page) });\n\n  await mount(<SessionCard {...props} state=\"completed\" />);\n  await expect(page).toHaveScreenshot(\"sessionCard-completed.png\", { mask: dynamicMasks(page) });\n});\n```\n\n---\n\n# D.11 Baseline Management & Review\n\n- Baselines live under `apps/frontend/tests/visual/__screenshots__/` mirrored to CI artifact storage", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 17, "token_count": 278, "hash_short": "1f5d24fd", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_018", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "d-completed.png\", { mask: dynamicMasks(page) });\n});\n```\n\n---\n\n# D.11 Baseline Management & Review\n\n- Baselines live under `apps/frontend/tests/visual/__screenshots__/` mirrored to CI artifact storage.\n- **Change control:** baseline updates must be accompanied by **design approval** and PR description with before/after thumbnails.\n- **Auto-reject** baseline updates in PRs that lack `design-ack` label.\n- **Rebase conflicts:** regenerate by re-running visual suite locally with the same commit SHA.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 18, "token_count": 125, "hash_short": "4c17e983", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_019", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "with before/after thumbnails.\n- **Auto-reject** baseline updates in PRs that lack `design-ack` label.\n- **Rebase conflicts:** regenerate by re-running visual suite locally with the same commit SHA.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 19, "token_count": 49, "hash_short": "1e672762", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_020", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "---\n\n# D.12 Naming Convention\n\n`screenshots/<page|component>/<theme>/<breakpoint>/<locale>/<motion>/<name>.png`\nExample: `screenshots/dashboard/dark/lg/de/reduced/dashboard-de-reduced.png`\n\n---\n\n# D.13 Responsive Guards (VIZ-RESP-05)\n\nAutomated checks to **fail** on horizontal overflow or layout breakage:\n\n```ts\nawait expect(\n  page.evaluate(() => document.body.scrollWidth <= window.innerWidth),\n).resolves.toBeTruthy();\n```\n\nLong-DE strings suite:\n\n```ts\nawait page.addInitScript(() => localStorage.setItem(\"i18n_long_strings\", \"1\"));\n```\n\nGrids & alignment:\n\n```ts\nconst box = await page.locator(\"[data-grid]\").boundingBox();\nexpect(box?.width).toBeGreaterThan(0);\n```\n\n---\n\n# D.14 Token & Contrast Checks (VIZ-TOK-03)\n\n- Validate presence of required CSS variables: `--color-*`, `--radius-*`, `--font-size-*`, spacing scale.\n- Deny ad-hoc inline overrides (lint rule).", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 20, "token_count": 218, "hash_short": "cc353400", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_021", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "---\n\n# D.14 Token & Contrast Checks (VIZ-TOK-03)\n\n- Validate presence of required CSS variables: `--color-*`, `--radius-*`, `--font-size-*`, spacing scale.\n- Deny ad-hoc inline overrides (lint rule).\n- Contrast assertions via DevTools protocol or axe:\n\n```ts\nimport axe from \"axe-core\";\n// rules: color-contrast, aria-required-attr, focus-visible\n```\n\n---\n\n# D.15 Flake Handling & Retries\n\n- `expect.toHaveScreenshot` retries: **2** on CI.\n- Mark tests **@flaky** only with issue link; quarantine ≤ 1 sprint.\n- Non-deterministic regions must be **masked** or **stubbed**, not ignored.\n\n---\n\n# D.16 CI Integration\n\n- Run after E2E; upload **`reports/visual/`** artifacts (diffs, actual, expected).\n- Gate script `scripts/ci/assert-visual.mjs --maxDiff 0.002` parses Playwright JSON and fails on breach.\n- PR comment bot posts thumbnails for changed baselines.\n\n---\n\n# D.17 Accessibility Parity (VIZ-MOTION-09)\n\n- Ensure **visual parity** with `prefers-reduced-motion`.", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 21, "token_count": 241, "hash_short": "e6880d1c", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
{"chunk_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD_chunk_022", "doc_id": ".._.._docs_4.Testing_and_Quality_Assurance_Plan_4c.Testing_and_Quality_Assurance_Plan_ApCD", "text": "ywright JSON and fails on breach.\n- PR comment bot posts thumbnails for changed baselines.\n\n---\n\n# D.17 Accessibility Parity (VIZ-MOTION-09)\n\n- Ensure **visual parity** with `prefers-reduced-motion`.\n- No essential information by animation alone (tooltips, progress).\n- Keyboard focus ring visible and not masked.\n\n---\n\n# D.18 Troubleshooting\n\n- **Large diffs**: verify fonts, dark mode tokens, seed data, clock.\n- **Only on CI**: ensure headless rendering fonts installed; match device scale.\n- **Transient network**: confirm asset routes mocked.\n- **Canvas/charts**: always mask canvases or render with deterministic seed.\n\n---\n\n# D.19 Checklist (Quick)\n\n- [ ] FakeClock + seeded data in place\n- [ ] Assets mocked; analytics silenced\n- [ ] Masks applied for dynamic regions\n- [ ] Themes × breakpoints × locales matrix covered\n- [ ] Reduced-motion parity captured\n- [ ] Token & contrast checks pass\n- [ ] Diff ≤ 0.2% or approved with `design-ack`\n- [ ] Artifacts uploaded to `reports/visual/`\n\n---", "source_file": "../../docs/4.Testing_and_Quality_Assurance_Plan/4c.Testing_and_Quality_Assurance_Plan_ApCD.md", "category": "testing", "chunk_index": 22, "token_count": 249, "hash_short": "f344e73d", "version": 1.0, "title": "Appendix C — CI Gate Snippets (indicative)", "mtime": "2025-10-26T18:14:50.301204", "ingested_at": "2025-11-30T04:00:43.804134", "tags": ["testing", "md"]}
