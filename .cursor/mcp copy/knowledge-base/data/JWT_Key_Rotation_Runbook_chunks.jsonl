{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_000", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "# JWT Key Rotation Runbook\n\n**Version:** 1.0\n**Last Updated:** 2025-11-11\n**Owner:** Security & DevOps Team\n**Frequency:** Quarterly (every 90 days)\n\nThis runbook provides step-by-step procedures for rotating JWT signing keys in FitVibe production and staging environments.\n\n---\n\n\n## Table of Contents\n\n- [Overview](#overview)\n- [Pre-Rotation Checklist](#pre-rotation-checklist)\n- [Rotation Procedure](#rotation-procedure)\n- [Verification](#verification)\n- [Rollback Procedure](#rollback-procedure)\n- [Monitoring](#monitoring)\n- [Troubleshooting](#troubleshooting)\n\n---\n\n## Overview\n\n### Purpose\n\nFitVibe uses RS256 (RSA asymmetric) JWT tokens for authentication. Per ADR-002 and security best practices, signing keys must be rotated quarterly to:\n\n1. Limit the blast radius of key compromise\n2. Comply with GDPR and security standards\n3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 0, "token_count": 209, "hash_short": "948f39ae", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_001", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "kens for authentication. Per ADR-002 and security best practices, signing keys must be rotated quarterly to:\n\n1. Limit the blast radius of key compromise\n2. Comply with GDPR and security standards\n3. Maintain crypto-agility\n\n### Key Concepts\n\n- **Access Token:** Short-lived (15 min), signed with current private key\n- **Refresh Token:** Long-lived (14 days), stored hashed in database\n- **Key Rotation Window:** 24-hour overlap period where both old and new keys are valid\n- **JWKS Endpoint:** `/.well-known/jwks.json` publishes current public keys with `kid` (Key ID)\n\n### Rotation Policy\n\n- **Schedule:** Every 90 days\n- **Alert Window:** 14 days before due date (warning), immediate at 105 days (critical)\n- **Overlap Period:** 24 hours (both keys valid during transition)\n- **Process:** Blue-green key deployment with zero downtime\n\n---\n\n## Pre-Rotation Checklist\n\n### 1.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 1, "token_count": 219, "hash_short": "6b4a0d71", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_002", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "immediate at 105 days (critical)\n- **Overlap Period:** 24 hours (both keys valid during transition)\n- **Process:** Blue-green key deployment with zero downtime\n\n---\n\n## Pre-Rotation Checklist\n\n### 1. Schedule and Notification\n\n- [ ] Schedule rotation during low-traffic window (e.g., 2 AM UTC on a Wednesday)\n- [ ] Notify engineering team 48 hours in advance via #eng-announcements\n- [ ] Create maintenance ticket in JIRA/Linear\n- [ ] Verify on-call engineer availability\n\n### 2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 2, "token_count": 119, "hash_short": "b71f0610", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_003", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "g., 2 AM UTC on a Wednesday)\n- [ ] Notify engineering team 48 hours in advance via #eng-announcements\n- [ ] Create maintenance ticket in JIRA/Linear\n- [ ] Verify on-call engineer availability\n\n### 2. Environment Preparation\n\n- [ ] Verify current key age:\n\n  ```bash\n  # SSH to production server\n  stat -c %Y /app/keys/jwt_private.pem\n  # Calculate age: (current_time - creation_time) / 86400 = days\n  ```\n\n- [ ] Check monitoring dashboard for baseline metrics:\n  - Current request rate\n  - Auth endpoint latency\n  - Active user sessions\n\n- [ ] Confirm staging environment is healthy and ready for testing\n\n- [ ] Backup current keys:\n  ```bash\n  cp /app/keys/jwt_private.pem /app/keys/backup/jwt_private_$(date +%Y%m%d).pem\n  cp /app/keys/jwt_public.pem /app/keys/backup/jwt_public_$(date +%Y%m%d).pem\n  ```\n\n### 3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 3, "token_count": 203, "hash_short": "a23b0362", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_004", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "kup current keys:\n  ```bash\n  cp /app/keys/jwt_private.pem /app/keys/backup/jwt_private_$(date +%Y%m%d).pem\n  cp /app/keys/jwt_public.pem /app/keys/backup/jwt_public_$(date +%Y%m%d).pem\n  ```\n\n### 3. Access Verification\n\n- [ ] Verify SSH access to production servers\n- [ ] Verify access to secrets manager (Vault/AWS Secrets Manager)\n- [ ] Verify deployment permissions (CI/CD, K8s, etc.)\n\n---\n\n## Rotation Procedure\n\n### Phase 1: Generate New Key Pair (Staging)\n\n1. **Generate new RSA-4096 key pair:**\n\n   ```bash\n   # On secure workstation (not production server)\n   openssl genrsa -out jwt_private_new.pem 4096\n   openssl rsa -in jwt_private_new.pem -pubout -out jwt_public_new.pem\n\n   # Verify key integrity\n   openssl rsa -in jwt_private_new.pem -check -noout\n   # Expected output: RSA key ok\n   ```\n\n2. **Assign Key ID (kid):**\n\n   ```bash\n   # Generate unique kid (timestamp-based)\n   export NEW_KID=\"key-$(date +%Y%m%d-%H%M%S)\"\n   echo $NEW_KID > jwt_kid_new.txt\n   ```\n\n3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 4, "token_count": 245, "hash_short": "e8431bd3", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_005", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "put: RSA key ok\n   ```\n\n2. **Assign Key ID (kid):**\n\n   ```bash\n   # Generate unique kid (timestamp-based)\n   export NEW_KID=\"key-$(date +%Y%m%d-%H%M%S)\"\n   echo $NEW_KID > jwt_kid_new.txt\n   ```\n\n3. **Store in Secrets Manager:**\n\n   **Vault:**\n\n   ```bash\n   vault kv put secret/fitvibe/staging/jwt \\\n     private_key=@jwt_private_new.pem \\\n     public_key=@jwt_public_new.pem \\\n     kid=\"$NEW_KID\"\n   ```\n\n   **AWS Secrets Manager:**\n\n   ```bash\n   aws secretsmanager create-secret \\\n     --name fitvibe/staging/jwt-new \\\n     --secret-string \"$(jq -n \\\n       --arg priv \"$(cat jwt_private_new.pem)\" \\\n       --arg pub \"$(cat jwt_public_new.pem)\" \\\n       --arg kid \"$NEW_KID\" \\\n       '{private_key: $priv, public_key: $pub, kid: $kid}')\"\n   ```\n\n4.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 5, "token_count": 188, "hash_short": "dc08feb4", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_006", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "\\\n       --arg priv \"$(cat jwt_private_new.pem)\" \\\n       --arg pub \"$(cat jwt_public_new.pem)\" \\\n       --arg kid \"$NEW_KID\" \\\n       '{private_key: $priv, public_key: $pub, kid: $kid}')\"\n   ```\n\n4. **Deploy to staging:**\n\n   ```bash\n   # Update environment variables\n   export JWT_PRIVATE_KEY_PATH=/app/keys/jwt_private_new.pem\n   export JWT_PUBLIC_KEY_PATH=/app/keys/jwt_public_new.pem\n   export JWT_KEY_ID=$NEW_KID\n\n   # Restart backend service\n   kubectl rollout restart deployment/fitvibe-backend -n staging\n   # OR for Docker Compose:\n   docker-compose -f docker-compose.staging.yml restart backend\n   ```\n\n### Phase 2: Test in Staging\n\n1. **Verify JWKS endpoint:**\n\n   ```bash\n   curl https://staging.fitvibe.app/.well-known/jwks.json | jq\n   ```\n\n   Expected output:\n\n   ```json\n   {\n     \"keys\": [\n       {\n         \"kty\": \"RSA\",\n         \"kid\": \"key-20251111-020000\",\n         \"use\": \"sig\",\n         \"alg\": \"RS256\",\n         \"n\": \"...\",\n         \"e\": \"AQAB\"\n       }\n     ]\n   }\n   ```\n\n2", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 6, "token_count": 249, "hash_short": "75d8d50d", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_007", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "keys\": [\n       {\n         \"kty\": \"RSA\",\n         \"kid\": \"key-20251111-020000\",\n         \"use\": \"sig\",\n         \"alg\": \"RS256\",\n         \"n\": \"...\",\n         \"e\": \"AQAB\"\n       }\n     ]\n   }\n   ```\n\n2. **Test authentication flow:**\n\n   ```bash\n   # Register new user\n   curl -X POST https://staging.fitvibe.app/api/v1/auth/register \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n       \"email\": \"rotation-test@example.com\",\n       \"username\": \"rotation-test\",\n       \"password\": \"TestPassword123!@#\"\n     }'\n\n   # Login and capture tokens\n   curl -X POST https://staging.fitvibe.app/api/v1/auth/login \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n       \"email\": \"rotation-test@example.com\",\n       \"password\": \"TestPassword123!@#\"\n     }' | jq -r '.accessToken' > access_token.txt\n\n   # Verify token signature\n   jwt decode $(cat access_token.txt)\n   # Check \"kid\" field matches $NEW_KID\n   ```\n\n3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 7, "token_count": 229, "hash_short": "38d5733b", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_008", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "password\": \"TestPassword123!@#\"\n     }' | jq -r '.accessToken' > access_token.txt\n\n   # Verify token signature\n   jwt decode $(cat access_token.txt)\n   # Check \"kid\" field matches $NEW_KID\n   ```\n\n3. **Load test (optional but recommended):**\n\n   ```bash\n   k6 run tests/performance/auth-load-test.js --vus 10 --duration 2m\n   ```\n\n4. **Staging smoke test checklist:**\n   - [ ] User can register\n   - [ ] User can login\n   - [ ] User can refresh token\n   - [ ] User can access protected endpoints\n   - [ ] Token signature validates correctly\n   - [ ] JWKS endpoint returns new key ID\n\n### Phase 3: Production Deployment (Blue-Green)\n\n**During this phase, BOTH old and new keys are valid for 24 hours.**\n\n1.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 8, "token_count": 176, "hash_short": "ff575f63", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_009", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "oken signature validates correctly\n   - [ ] JWKS endpoint returns new key ID\n\n### Phase 3: Production Deployment (Blue-Green)\n\n**During this phase, BOTH old and new keys are valid for 24 hours.**\n\n1. **Deploy new key alongside old key:**\n\n   ```bash\n   # Store new key in secrets manager\n   vault kv put secret/fitvibe/production/jwt-new \\\n     private_key=@jwt_private_new.pem \\\n     public_key=@jwt_public_new.pem \\\n     kid=\"$NEW_KID\"\n\n   # Update application config to load BOTH keys\n   # The application should publish both public keys in JWKS\n   # but sign NEW tokens with the NEW key\n   ```\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 9, "token_count": 150, "hash_short": "3f0ac00d", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_010", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "ublic_new.pem \\\n     kid=\"$NEW_KID\"\n\n   # Update application config to load BOTH keys\n   # The application should publish both public keys in JWKS\n   # but sign NEW tokens with the NEW key\n   ```\n\n2. **Update backend configuration:**\n\n   Edit backend environment config to use new key for signing:\n\n   ```bash\n   export JWT_PRIVATE_KEY_PATH=/app/keys/jwt_private_new.pem\n   export JWT_PUBLIC_KEY_PATH=/app/keys/jwt_public_new.pem\n   export JWT_KEY_ID=$NEW_KID\n\n   # Keep old public key available for validation\n   export JWT_PUBLIC_KEY_OLD_PATH=/app/keys/jwt_public.pem\n   export JWT_KEY_ID_OLD=\"key-20250811-020000\"  # Previous kid\n   ```\n\n3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 10, "token_count": 160, "hash_short": "c6cf5910", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_011", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "KEY_ID=$NEW_KID\n\n   # Keep old public key available for validation\n   export JWT_PUBLIC_KEY_OLD_PATH=/app/keys/jwt_public.pem\n   export JWT_KEY_ID_OLD=\"key-20250811-020000\"  # Previous kid\n   ```\n\n3. **Rolling deployment:**\n\n   **Kubernetes:**\n\n   ```bash\n   # Update deployment with new secret references\n   kubectl set env deployment/fitvibe-backend \\\n     JWT_KEY_ID=$NEW_KID \\\n     -n production\n\n   # Rolling restart (zero-downtime)\n   kubectl rollout restart deployment/fitvibe-backend -n production\n   kubectl rollout status deployment/fitvibe-backend -n production\n   ```\n\n   **Docker Swarm:**\n\n   ```bash\n   docker service update \\\n     --env-add JWT_KEY_ID=$NEW_KID \\\n     fitvibe_backend\n\n   # Monitor rollout\n   docker service ps fitvibe_backend\n   ```\n\n4.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 11, "token_count": 192, "hash_short": "ae22af69", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_012", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "ion\n   ```\n\n   **Docker Swarm:**\n\n   ```bash\n   docker service update \\\n     --env-add JWT_KEY_ID=$NEW_KID \\\n     fitvibe_backend\n\n   # Monitor rollout\n   docker service ps fitvibe_backend\n   ```\n\n4. **Monitor during rollout:**\n\n   Watch these metrics in Grafana:\n   - `http_requests_total{route=\"/api/v1/auth/*\", status_code=\"401\"}` (should not spike)\n   - `http_request_duration_seconds{route=\"/api/v1/auth/login\"}` (should remain stable)\n   - Error logs for \"invalid signature\" or \"unknown kid\"\n\n### Phase 4: Grace Period (24 hours)\n\nDuring the 24-hour overlap:\n\n- New tokens are signed with NEW key (kid = $NEW_KID)\n- Old tokens signed with OLD key are still accepted\n- JWKS endpoint exposes BOTH public keys\n\n**Monitor:**\n\n1. **Check token distribution:**\n\n   ```bash\n   # Query backend metrics (if instrumented)\n   curl -s http://localhost:4000/metrics | grep jwt_tokens_validated_total\n   ```\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 12, "token_count": 225, "hash_short": "a9046db3", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_013", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "lic keys\n\n**Monitor:**\n\n1. **Check token distribution:**\n\n   ```bash\n   # Query backend metrics (if instrumented)\n   curl -s http://localhost:4000/metrics | grep jwt_tokens_validated_total\n   ```\n\n2. **Watch for errors:**\n\n   ```bash\n   # Tail logs for JWT errors\n   kubectl logs -f deployment/fitvibe-backend -n production | grep -i \"jwt\\|signature\"\n   ```\n\n3. **User session analysis:**\n\n   ```sql\n   -- Count active sessions by key ID\n   SELECT\n     substring(access_token FROM 'kid.*?(key-[0-9-]+)') AS kid,\n     COUNT(*) AS session_count\n   FROM user_sessions\n   WHERE expires_at > NOW()\n   GROUP BY kid;\n   ```\n\n### Phase 5: Remove Old Key (After 24 Hours)\n\n1. **Verify all active sessions use new key:**\n\n   ```sql\n   -- Ensure no sessions rely on old key\n   SELECT COUNT(*)\n   FROM user_sessions\n   WHERE expires_at > NOW()\n     AND access_token LIKE '%\"kid\":\"key-20250811%';\n   -- Expected: 0\n   ```\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 13, "token_count": 228, "hash_short": "1306709e", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_014", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "```sql\n   -- Ensure no sessions rely on old key\n   SELECT COUNT(*)\n   FROM user_sessions\n   WHERE expires_at > NOW()\n     AND access_token LIKE '%\"kid\":\"key-20250811%';\n   -- Expected: 0\n   ```\n\n2. **Remove old key from JWKS:**\n\n   ```bash\n   # Update backend config to remove old public key\n   unset JWT_PUBLIC_KEY_OLD_PATH\n   unset JWT_KEY_ID_OLD\n\n   # Restart backend\n   kubectl rollout restart deployment/fitvibe-backend -n production\n   ```\n\n3. **Archive old key (do NOT delete):**\n\n   ```bash\n   # Move to secure archive (retain for 2 years per compliance)\n   aws s3 cp jwt_private.pem s3://fitvibe-secrets-archive/jwt/2025/\n   aws s3 cp jwt_public.pem s3://fitvibe-secrets-archive/jwt/2025/\n\n   # Update secrets manager\n   vault kv metadata delete secret/fitvibe/production/jwt-old\n   ```\n\n---\n\n## Verification\n\n### Post-Rotation Checks\n\n1.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 14, "token_count": 211, "hash_short": "694fa908", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_015", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "public.pem s3://fitvibe-secrets-archive/jwt/2025/\n\n   # Update secrets manager\n   vault kv metadata delete secret/fitvibe/production/jwt-old\n   ```\n\n---\n\n## Verification\n\n### Post-Rotation Checks\n\n1. **Verify JWKS endpoint:**\n\n   ```bash\n   curl https://api.fitvibe.app/.well-known/jwks.json | jq '.keys | length'\n   # Expected: 1 (after grace period)\n   ```\n\n2. **End-to-end authentication test:**\n\n   ```bash\n   # Automated E2E test\n   npm run test:e2e -- --grep \"authentication flow\"\n   ```\n\n3. **Check monitoring dashboards:**\n   - [ ] No spike in 401 errors\n   - [ ] Auth endpoint latency within SLO (< 200ms p95)\n   - [ ] No alerts firing\n   - [ ] Session creation rate normal\n\n4.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 15, "token_count": 171, "hash_short": "25a96f98", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_016", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "```\n\n3. **Check monitoring dashboards:**\n   - [ ] No spike in 401 errors\n   - [ ] Auth endpoint latency within SLO (< 200ms p95)\n   - [ ] No alerts firing\n   - [ ] Session creation rate normal\n\n4. **Verify key age metric:**\n\n   ```bash\n   curl -s http://localhost:4000/metrics | grep jwt_key_created_timestamp\n   # Should show current timestamp (within last 24 hours)\n   ```\n\n---\n\n## Rollback Procedure\n\nIf issues arise during rotation (e.g., spike in 401s, users unable to login):\n\n### Immediate Rollback (< 1 hour into rotation)\n\n1. **Revert to old key:**\n\n   ```bash\n   kubectl set env deployment/fitvibe-backend \\\n     JWT_PRIVATE_KEY_PATH=/app/keys/jwt_private.pem \\\n     JWT_PUBLIC_KEY_PATH=/app/keys/jwt_public.pem \\\n     JWT_KEY_ID=\"key-20250811-020000\" \\\n     -n production\n\n   kubectl rollout restart deployment/fitvibe-backend -n production\n   ```\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 16, "token_count": 215, "hash_short": "2aceab45", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_017", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "te.pem \\\n     JWT_PUBLIC_KEY_PATH=/app/keys/jwt_public.pem \\\n     JWT_KEY_ID=\"key-20250811-020000\" \\\n     -n production\n\n   kubectl rollout restart deployment/fitvibe-backend -n production\n   ```\n\n2. **Verify rollback:**\n\n   ```bash\n   curl https://api.fitvibe.app/.well-known/jwks.json | jq -r '.keys[0].kid'\n   # Should show old key ID\n   ```\n\n3. **Communicate incident:**\n   - Post in #engineering and #incidents channels\n   - Update status page if user-facing impact\n   - Schedule post-mortem\n\n### Partial Rollback (During Grace Period)\n\nIf issues surface during the 24-hour grace period:\n\n1. **Extend grace period:**\n   - Keep both keys active for additional 24-48 hours\n   - Monitor user sessions and error rates\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 17, "token_count": 180, "hash_short": "7021bdb3", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_018", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "ing Grace Period)\n\nIf issues surface during the 24-hour grace period:\n\n1. **Extend grace period:**\n   - Keep both keys active for additional 24-48 hours\n   - Monitor user sessions and error rates\n\n2.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 18, "token_count": 49, "hash_short": "784026dd", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_019", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "**Force re-authentication:**\n   - If necessary, invalidate all sessions and require re-login:\n     ```sql\n     UPDATE user_sessions SET expires_at = NOW() WHERE expires_at > NOW();\n     ```\n\n---\n\n## Monitoring\n\n### Dashboards\n\n- **SLO Dashboard:** `/grafana/d/slo-overview`\n  - Track availability and latency during rotation\n\n- **Auth Metrics Dashboard:** `/grafana/d/auth-metrics`\n  - Monitor login success rate, token issuance, refresh operations\n\n- **Alerting Dashboard:** `/grafana/d/alerts`\n  - Watch for JWT-related alerts\n\n### Alerts\n\nPre-configured alerts (see `infra/observability/alert-rules.yml`):\n\n- `JWTKeyRotationDue` (warning at 90 days)\n- `JWTKeyRotationOverdue` (critical at 105 days)\n- `HighErrorRate` (5xx errors > 0.5%)\n- `AuthBruteForceSpike` (failed login spike)\n\n### Metrics to Watch\n\n```promql\n# 401 Unauthorized rate (should not spike)\nrate(http_requests_total{status_code=\"401\"}[5m])\n\n# Token validation errors (custom metric - needs instrumentation)\nrate(jwt_validation_errors_total[5m])", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 19, "token_count": 253, "hash_short": "bbe05f5b", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_020", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "ql\n# 401 Unauthorized rate (should not spike)\nrate(http_requests_total{status_code=\"401\"}[5m])\n\n# Token validation errors (custom metric - needs instrumentation)\nrate(jwt_validation_errors_total[5m])\n\n\n# Active sessions by key ID (custom metric - needs instrumentation)\njwt_active_sessions_by_kid\n\n# Auth endpoint latency\nhistogram_quantile(0.95, rate(http_request_duration_seconds_bucket{route=\"/api/v1/auth/login\"}[5m]))\n```\n\n---\n\n## Troubleshooting\n\n### Issue: Users getting 401 errors after rotation\n\n**Symptoms:**\n\n- Spike in 401 responses\n- Users reporting \"session expired\" or \"unauthorized\"\n\n**Diagnosis:**\n\n```bash\n# Check if old tokens are being rejected\nkubectl logs deployment/fitvibe-backend -n production | grep \"unknown kid\\|signature verification failed\"\n\n# Verify JWKS endpoint has both keys during grace period\ncurl https://api.fitvibe.app/.well-known/jwks.json | jq '.keys | length'\n# Expected: 2 (during grace period), 1 (after)\n```\n\n**Resolution:**\n\n1.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 20, "token_count": 243, "hash_short": "fb2dba8b", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_021", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "Verify JWKS endpoint has both keys during grace period\ncurl https://api.fitvibe.app/.well-known/jwks.json | jq '.keys | length'\n# Expected: 2 (during grace period), 1 (after)\n```\n\n**Resolution:**\n\n1. If in grace period and old key missing: Re-add old public key to JWKS\n2. If after grace period: Extend grace period by 24 hours\n3. If persistent: Rollback to old key (see Rollback Procedure)\n\n### Issue: JWKS endpoint not updating\n\n**Symptoms:**\n\n- New key ID not appearing in `/.well-known/jwks.json`\n- Frontend still using old tokens\n\n**Diagnosis:**\n\n```bash\n# Check backend logs for JWKS generation errors\nkubectl logs deployment/fitvibe-backend -n production | grep -i jwks\n\n# Verify environment variables\nkubectl exec deployment/fitvibe-backend -n production -- env | grep JWT\n```\n\n**Resolution:**\n\n1. Restart backend pods to reload JWKS\n2. Clear CDN cache if using caching proxy\n3.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 21, "token_count": 221, "hash_short": "0be8f258", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_022", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "environment variables\nkubectl exec deployment/fitvibe-backend -n production -- env | grep JWT\n```\n\n**Resolution:**\n\n1. Restart backend pods to reload JWKS\n2. Clear CDN cache if using caching proxy\n3. Verify public key file permissions (must be readable by app user)\n\n### Issue: Key file not found\n\n**Symptoms:**\n\n- Backend fails to start\n- Error: `ENOENT: no such file or directory, open '/app/keys/jwt_private_new.pem'`\n\n**Diagnosis:**\n\n```bash\n# Check if secret is mounted\nkubectl describe pod <backend-pod> -n production | grep -A 10 Mounts\n```\n\n**Resolution:**\n\n1. Verify secret exists in secrets manager\n2. Ensure Kubernetes secret/configmap is created and referenced in deployment\n3. Check file path in environment variable matches actual mount path\n\n### Issue: Performance degradation after rotation\n\n**Symptoms:**\n\n- Auth endpoint latency increased\n- Slower token validation\n\n**Diagnosis:**\n\n- RSA-4096 verification is compute-intensive; ensure adequate CPU allocation\n\n**Resolution:**\n\n1.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 22, "token_count": 249, "hash_short": "ee5bac2e", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_023", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "rotation\n\n**Symptoms:**\n\n- Auth endpoint latency increased\n- Slower token validation\n\n**Diagnosis:**\n\n- RSA-4096 verification is compute-intensive; ensure adequate CPU allocation\n\n**Resolution:**\n\n1. Check CPU usage: `kubectl top pods -n production`\n2. Scale horizontally if needed: `kubectl scale deployment/fitvibe-backend --replicas=6 -n production`\n3. Consider implementing token caching (with TTL = token expiry)\n\n---\n\n## Appendix\n\n### A.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 23, "token_count": 110, "hash_short": "2c4689f1", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_024", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "tion`\n2. Scale horizontally if needed: `kubectl scale deployment/fitvibe-backend --replicas=6 -n production`\n3. Consider implementing token caching (with TTL = token expiry)\n\n---\n\n## Appendix\n\n### A. Key Generation Script\n\nSee `infra/scripts/generate-jwt-keys.sh`:\n\n```bash\n#!/bin/bash\nset -euo pipefail\n\nKID=\"key-$(date +%Y%m%d-%H%M%S)\"\nOUTPUT_DIR=\"${1:-.}\"\n\necho \"Generating RSA-4096 key pair with kid=$KID...\"\nopenssl genrsa -out \"$OUTPUT_DIR/jwt_private.pem\" 4096\nopenssl rsa -in \"$OUTPUT_DIR/jwt_private.pem\" -pubout -out \"$OUTPUT_DIR/jwt_public.pem\"\n\necho \"Verifying key integrity...\"\nopenssl rsa -in \"$OUTPUT_DIR/jwt_private.pem\" -check -noout\n\necho \"$KID\" > \"$OUTPUT_DIR/jwt_kid.txt\"\necho \"Keys generated successfully:\"\necho \"  Private: $OUTPUT_DIR/jwt_private.pem\"\necho \"  Public:  $OUTPUT_DIR/jwt_public.pem\"\necho \"  Key ID:  $KID\"\n```\n\n### B.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 24, "token_count": 213, "hash_short": "1d881ea8", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_025", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "ho \"$KID\" > \"$OUTPUT_DIR/jwt_kid.txt\"\necho \"Keys generated successfully:\"\necho \"  Private: $OUTPUT_DIR/jwt_private.pem\"\necho \"  Public:  $OUTPUT_DIR/jwt_public.pem\"\necho \"  Key ID:  $KID\"\n```\n\n### B. Rotation Schedule\n\n| Quarter | Rotation Window | Alert Start | Critical Alert |\n| ------- | --------------- | ----------- | -------------- |\n| Q1      | Jan 15 - Jan 22 | Jan 1       | Jan 30         |\n| Q2      | Apr 15 - Apr 22 | Apr 1       | Apr 30         |\n| Q3      | Jul 15 - Jul 22 | Jul 1       | Jul 30         |\n| Q4      | Oct 15 - Oct 22 | Oct 1       | Oct 30         |\n\n### C. Contact Information\n\n- **Primary:** DevOps On-Call (PagerDuty)\n- **Secondary:** Security Team (#security-team Slack)\n- **Escalation:** CTO / Engineering Lead\n\n### D.", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 25, "token_count": 189, "hash_short": "6293823e", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
{"chunk_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook_chunk_026", "doc_id": ".._.._docs_5.Policies_5.a.Ops_JWT_Key_Rotation_Runbook", "text": "| Oct 30         |\n\n### C. Contact Information\n\n- **Primary:** DevOps On-Call (PagerDuty)\n- **Secondary:** Security Team (#security-team Slack)\n- **Escalation:** CTO / Engineering Lead\n\n### D. References\n\n- [ADR-002: Authentication Token Strategy](../docs/6.%20adr/ADR-002-authentication-token-strategy.md)\n- [RFC 7517: JSON Web Key (JWK)](https://datatracker.ietf.org/doc/html/rfc7517)\n- [RFC 7519: JSON Web Token (JWT)](https://datatracker.ietf.org/doc/html/rfc7519)\n- [NIST SP 800-57: Key Management](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)", "source_file": "../../docs/5.Policies/5.a.Ops/JWT_Key_Rotation_Runbook.md", "category": "policies", "chunk_index": 26, "token_count": 143, "hash_short": "15409fe8", "version": 1.0, "title": "JWT Key Rotation Runbook", "mtime": "2025-11-15T07:01:39.658033", "ingested_at": "2025-11-30T04:00:43.995464", "tags": ["policies", "md"]}
