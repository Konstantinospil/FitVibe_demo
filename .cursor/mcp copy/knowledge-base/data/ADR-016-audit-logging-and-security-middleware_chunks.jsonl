{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "# ADR-016: Security Middleware & Audit Logging\n\n**Date:** 2025-10-14  \n**Status:** Accepted  \n**Author:** Reviewer  \n**Cross-References:** PRD §5 Security & Privacy; PRD §7 Engineering Standards; TDD §5–§7 (auth, RBAC, logging), §10 (ops); QA §2–§12 (CI gates, security scans), §11 (performance)\n\n---\n\n\n## Context\n\nWe must enforce a secure-by-default HTTP stack and produce reliable, privacy-safe audit logs for regulated operations (auth, profile changes, data exports/deletes, payments if added). The PRD requires strict security headers, CSRF protection where applicable, role-based access control, rate limiting, and **PII-safe** logs with correlation/traceability. The TDD specifies layered middleware and centralized logging; the QA plan runs ZAP baseline, dependency scanning, and rejects builds with high CVEs or missing headers.\n\nThis ADR defines the standard middleware stack, audit event model, storage/retention, and CI observability needed to satisfy those requirements.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 0, "token_count": 245, "hash_short": "9042d008", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "nd rejects builds with high CVEs or missing headers.\n\nThis ADR defines the standard middleware stack, audit event model, storage/retention, and CI observability needed to satisfy those requirements.\n\n---\n\n## Decision\n\n1. **Authentication & Session**\n   - **Access tokens:** JWT **RS256** (short-lived).\n   - **Refresh tokens:** Server-stored, **rotating**; revocation list persisted.\n   - Clock skew tolerance ≤ 60 s; mandatory TLS; token audience and issuer validated.\n\n2. **Authorization (RBAC)**\n   - **Router-level** coarse checks from JWT claims (role/scope).\n   - **Service-level** fine-grained checks on resource ownership and attributes.\n   - Admin-only routes isolated under `/admin` with enhanced logging/alerts.\n\n3. **Security Middleware (HTTP)**\n   - **CSP** without `unsafe-inline`; nonces for inline scripts if unavoidable.\n   - **HSTS** (include subdomains), **Referrer-Policy: strict-origin-when-cross-origin**, **Permissions-Policy** (deny by default).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 1, "token_count": 242, "hash_short": "7ec61788", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "thout `unsafe-inline`; nonces for inline scripts if unavoidable.\n   - **HSTS** (include subdomains), **Referrer-Policy: strict-origin-when-cross-origin**, **Permissions-Policy** (deny by default).\n   - **CORS** strict allowlist; preflight handled centrally.\n   - **CSRF** protection for cookie-based sessions and any state-changing route when cookies present.\n   - **Input size limits** and **rate limiting** (token bucket per IP/user/route class).\n   - **Body parsing** with `limit` and type checks; file uploads scanned via AV before persistence.\n\n4. **Audit Logging Model**\n   - **PII-Free Principle:** Request/response bodies are **not** logged; only minimal metadata and event fields.\n   - **Correlation:** Every request carries a `correlation_id` (generated if missing); propagated to logs, metrics, and traces.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 2, "token_count": 204, "hash_short": "f4fb5d7a", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "e bodies are **not** logged; only minimal metadata and event fields.\n   - **Correlation:** Every request carries a `correlation_id` (generated if missing); propagated to logs, metrics, and traces.\n   - **Event schema (log line):**\n     ```json\n     {\n       \"ts\": \"2025-10-14T12:34:56.789Z\",\n       \"event\": \"user.update\",\n       \"actor_user_id\": \"ulid\",\n       \"subject_type\": \"user\",\n       \"subject_id\": \"ulid\",\n       \"action\": \"update\",\n       \"result\": \"success\",\n       \"ip\": \"client-ip\",\n       \"user_agent\": \"ua\",\n       \"correlation_id\": \"uuid/ulid\",\n       \"resource\": \"/api/v1/users/ulid\",\n       \"http_method\": \"PATCH\",\n       \"status\": 200,\n       \"extras\": { \"fields_changed\": [\"displayName\", \"avatarId\"] }\n     }\n     ```\n   - **Never store secrets or raw PII** (e.g., email, address); use stable IDs or hashed tokens for lookup when necessary.\n   - **Sampling:** Info-level request logs sampled; **security/audit events are not sampled**.\n\n5.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 3, "token_count": 239, "hash_short": "85668b41", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "rets or raw PII** (e.g., email, address); use stable IDs or hashed tokens for lookup when necessary.\n   - **Sampling:** Info-level request logs sampled; **security/audit events are not sampled**.\n\n5. **Storage, Retention, and Integrity**\n   - **Structured JSON logs** shipped to a centralized store (e.g., OpenSearch/Cloud Logging).\n   - **Retention:** 180 days default; **access-controlled** indices; DSR deletions **do not** remove audit entries but they contain no PII.\n   - **Tamper-evidence:** Append-only sink with periodic **hash chaining** or provider-native immutability (WORM) for audit-critical streams.\n\n6. **Observability & Alerts**\n   - **Metrics:** Prometheus counters/histograms for `http_requests`, `auth_failures_total`, `rate_limit_hits_total`, `audit_events_total`, and latency per route.\n   - **Alerts:** Notify on spikes of 401/403/429, admin route access, and audit writer failures. SLO: API p95 < **300 ms**; logging overhead < **5%** CPU budget.\n\n7.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 4, "token_count": 243, "hash_short": "076eab6f", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "ts_total`, and latency per route.\n   - **Alerts:** Notify on spikes of 401/403/429, admin route access, and audit writer failures. SLO: API p95 < **300 ms**; logging overhead < **5%** CPU budget.\n\n7. **Idempotency & Replays (tie-in)**\n   - Audit entries reference idempotency keys on unsafe writes; replays are marked `result: \"replay\"` to distinguish from duplicates.\n\n8. **Privacy & Compliance**\n   - **Redaction hooks** scrub known fields before logging.\n   - **Data residency** follows deployment region; logs tagged with region.\n   - **Access controls**: least-privileged roles for log readers; auditable access to the log platform.\n\n9. **Testing & CI Integration**\n   - **Automated checks** ensure security headers, CORS policy, and CSRF tokens on protected routes (ZAP baseline in CI).\n   - Unit/integration tests assert: no PII in logs, correlation propagation, and audit events for critical actions.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 5, "token_count": 227, "hash_short": "8d76cc72", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "headers, CORS policy, and CSRF tokens on protected routes (ZAP baseline in CI).\n   - Unit/integration tests assert: no PII in logs, correlation propagation, and audit events for critical actions.\n   - **Performance gate:** k6 smoke must pass with budgets; log sampling configurable for test envs.\n\n---\n\n## Consequences\n\n**Positive**\n\n- Strong, testable security posture with minimal risk of PII leakage.\n- Traceable actions with correlation across logs, metrics, and traces.\n- Clear retention and integrity guarantees for audits.\n\n**Negative / Trade-offs**\n\n- Added complexity and cost for centralized logging and immutability.\n- Sampling and redaction must be maintained as fields evolve.\n\n**Operational**\n\n- Rotate keys regularly; monitor token refresh anomalies.\n- Track log volume; adjust sampling and retention to control costs.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 6, "token_count": 208, "hash_short": "4903a775", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "ing and redaction must be maintained as fields evolve.\n\n**Operational**\n\n- Rotate keys regularly; monitor token refresh anomalies.\n- Track log volume; adjust sampling and retention to control costs.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 7, "token_count": 49, "hash_short": "b80c126f", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-016-audit-logging-and-security-middleware", "text": "---\n\n## Alternatives Considered\n\n| Option                           | Description        | Reason Rejected                                              |\n| -------------------------------- | ------------------ | ------------------------------------------------------------ |\n| Verbose request/response logging | Log full payloads  | Privacy/compliance risk; exceeds PRD guidance                |\n| Client-only analytics            | No server audit    | Fails compliance and forensics needs                         |\n| Single-layer authorization       | Only router checks | Insufficient for resource-level rules; violates TDD layering |\n\n---\n\n## References\n\n- PRD: Security & privacy baselines (headers, CSRF, RBAC, logging)\n- TDD: Auth/RBAC design, centralized logging, operational practices\n- QA: ZAP baseline, dependency scans, perf budgets\n\n---\n\n## Status Log\n\n| Version | Date       | Change                                                | Author   |\n| ------- | ---------- | ----------------------------------------------------- | -------- |\n| v1.0    | 2025-10-14 | Initial ADR for security middleware and audit logging | Reviewer |", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-016-audit-logging-and-security-middleware.md", "category": "technical", "chunk_index": 8, "token_count": 285, "hash_short": "7fd39b48", "version": 1.0, "title": "ADR-016: Security Middleware & Audit Logging", "mtime": "2025-10-18T10:54:49.993236", "ingested_at": "2025-11-30T04:00:44.130535", "tags": ["technical", "md"]}
