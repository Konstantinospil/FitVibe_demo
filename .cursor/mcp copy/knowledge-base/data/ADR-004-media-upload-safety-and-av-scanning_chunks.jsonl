{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning", "text": "# ADR-004 — Media Upload Safety & AV Scanning\n\n> **File:** docs/adr/ADR-004-media-upload-safety-and-av-scanning.md  \n> **Purpose:** Define a secure pipeline for handling user media (images/videos) to prevent malware and abuse content from entering the system.\n\n---\n\nid: ADR-004\ntitle: \"Media Upload Safety & AV Scanning\"\nstatus: \"Accepted\"\ndate: \"2025-10-14\"\nowners: [\"Dr. Konstantinos Pilpilidis\"]\nversion: \"1.0\"\nlinks:\n\n- PRD: \"docs/1. Product Requirements Document.md#security--privacy\"\n- TDD: \"docs/2. Technical Design Document v2.md#media-handling--object-storage\"\n- QA: \"docs/3. Testing and Quality Assurance Plan.md#security-tests-and-slos\"\n\n---\n\n\n## Context\n\nMVP and future phases allow users to upload media (e.g., exercise photos). File uploads introduce risks: malware, poisoned payloads, abusive content, and storage abuse. We need a **defense‑in‑depth** pipeline compatible with the SPA and our object storage (S3/MinIO).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-004-media-upload-safety-and-av-scanning.md", "category": "technical", "chunk_index": 0, "token_count": 233, "hash_short": "03ca4d43", "version": 1.0, "title": "ADR-004 — Media Upload Safety & AV Scanning", "mtime": "2025-10-18T10:54:49.819759", "ingested_at": "2025-11-30T04:00:44.079738", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning", "text": "tos). File uploads introduce risks: malware, poisoned payloads, abusive content, and storage abuse. We need a **defense‑in‑depth** pipeline compatible with the SPA and our object storage (S3/MinIO).\n\n## Decision\n\nImplement a **quarantine → scan → transform → publish** pipeline with strict **allow‑list**, **content‑sniffing**, and **ClamAV** scanning. No file is served until it clears the pipeline.\n\n### Pipeline\n\n1. **Pre‑Upload Checks (Client & Edge)**\n   - Max size: **10 MB** (MVP).\n   - Allowed types: `image/jpeg`, `image/png`, `image/webp`, `video/mp4` (Phase 2).\n   - Use presigned POST to **quarantine bucket** with server‑generated object key; deny public access.\n2. **Ingestion (Backend)**\n   - Validate MIME via **server‑side sniffing** (magic bytes).\n   - Store metadata row with `status=\"quarantined\"`.\n3. **AV Scanning**\n   - **ClamAV** daemon scans new objects; on **malware detected** → delete object, mark row `status=\"rejected\"`, alert.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-004-media-upload-safety-and-av-scanning.md", "category": "technical", "chunk_index": 1, "token_count": 239, "hash_short": "b6562b23", "version": 1.0, "title": "ADR-004 — Media Upload Safety & AV Scanning", "mtime": "2025-10-18T10:54:49.819759", "ingested_at": "2025-11-30T04:00:44.079738", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning", "text": "es).\n   - Store metadata row with `status=\"quarantined\"`.\n3. **AV Scanning**\n   - **ClamAV** daemon scans new objects; on **malware detected** → delete object, mark row `status=\"rejected\"`, alert.\n   - Keep **signature DB** updated on a schedule.\n4. **Transformations**\n   - Strip **EXIF**, normalize color space, resize to sensible resolutions.\n   - Re‑encode to safe formats; disallow active content (SVG with scripts, PDFs with JS).\n5. **Publish**\n   - Move to **public bucket** with immutable names; serve via CDN with **Content‑Disposition** and **Content‑Type** set explicitly.\n   - Attach **Object Lock/retention** optional; use short **cache‑control** for revocation agility.\n6. **Abuse & Content Controls (Phase 2+)**\n   - Optional ML nudity/abuse detection; human review queue.\n\n### Security Controls\n\n- **Allow‑list only**, block everything else.\n- **Rate limiting** per user/IP; total storage quotas.\n- **Signed URLs** short‑lived; no direct bucket listing.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-004-media-upload-safety-and-av-scanning.md", "category": "technical", "chunk_index": 2, "token_count": 242, "hash_short": "fe17dc8c", "version": 1.0, "title": "ADR-004 — Media Upload Safety & AV Scanning", "mtime": "2025-10-18T10:54:49.819759", "ingested_at": "2025-11-30T04:00:44.079738", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning", "text": "man review queue.\n\n### Security Controls\n\n- **Allow‑list only**, block everything else.\n- **Rate limiting** per user/IP; total storage quotas.\n- **Signed URLs** short‑lived; no direct bucket listing.\n- **CSP** headers on media domains to prevent content sniffing in browsers.\n- **No SVG uploads** in MVP; consider sanitized SVG later.\n- **Checksum** on upload (SHA‑256) and store content hash to detect duplicates.\n\n### Observability\n\n- Metrics: `uploads_quarantined_total`, `uploads_rejected_total`, scan latency p95, transform failures.\n- Audit log for every state change (quarantine→scanned→published).\n\n## Consequences\n\n- Strong malware protection and safer media serving.\n- Slight latency added between upload and publish; extra infra (ClamAV workers).\n\n## Alternatives Considered\n\n- **Inline scanning** at upload: Higher perceived latency, fewer retries.\n- **Third‑party scanning service**: Less ops, but vendor coupling/cost.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-004-media-upload-safety-and-av-scanning.md", "category": "technical", "chunk_index": 3, "token_count": 233, "hash_short": "2f9a1613", "version": 1.0, "title": "ADR-004 — Media Upload Safety & AV Scanning", "mtime": "2025-10-18T10:54:49.819759", "ingested_at": "2025-11-30T04:00:44.079738", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-004-media-upload-safety-and-av-scanning", "text": "infra (ClamAV workers).\n\n## Alternatives Considered\n\n- **Inline scanning** at upload: Higher perceived latency, fewer retries.\n- **Third‑party scanning service**: Less ops, but vendor coupling/cost.\n\n## QA & Acceptance\n\n- E2E: infected EICAR file is rejected and deleted.\n- Ensure invalid MIME/extension mismatches rejected.\n- Privacy: EXIF stripped; GPS data never stored.\n\n## Backout Plan\n\nIf ClamAV throughput is a bottleneck, scale workers horizontally or temporarily switch to **inline scanning** with queue back‑pressure.\n\n## Change Log\n\n- **1.0 (2025-10-14)** Initial acceptance.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-004-media-upload-safety-and-av-scanning.md", "category": "technical", "chunk_index": 4, "token_count": 146, "hash_short": "8867a2cd", "version": 1.0, "title": "ADR-004 — Media Upload Safety & AV Scanning", "mtime": "2025-10-18T10:54:49.819759", "ingested_at": "2025-11-30T04:00:44.079738", "tags": ["technical", "md"]}
