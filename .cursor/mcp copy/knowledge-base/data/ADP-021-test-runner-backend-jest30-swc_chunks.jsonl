{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "---\ntitle: \"ADP-021: Standardize Backend Test Runner on Jest 30 + @swc/jest\"\nversion: 1.0\nstatus: Proposed → Accepted\ndate: 2025-10-14\nauthor: Konstantinos Pilpilidis (FitVibe)\nreviewers: Core Team\ntags: [testing, qa, backend, ci, jest, swc]\nreferences:\n  - PRD §6.4.4 Testing Approach; PRD Tooling Table (“Testing Framework: Jest + ts-jest” → updated to Jest + SWC)\n  - TDD §8.* Backend Services – Testing notes (Jest + Supertest)\n  - QA Plan §8.1 Backend (API) Test Strategy (Jest + Supertest), §12 Toolchain & Automation\n---\n\n# Decision\n\n**Adopt _Jest 30_ with _@swc/jest_ for the backend test runner** (unit + integration with Supertest), replacing ts-jest.  \nFrontend remains on **Vitest** (fast dev UX). This preserves our existing Jest semantics for the API layer while modernizing TypeScript transforms with SWC.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 0, "token_count": 205, "hash_short": "fc9be209", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "ion with Supertest), replacing ts-jest.  \nFrontend remains on **Vitest** (fast dev UX). This preserves our existing Jest semantics for the API layer while modernizing TypeScript transforms with SWC.\n\n# Context\n\n- Our current attempt to run tests with **Jest 30** failed because **TypeScript sources weren’t transformed**; Node tried to load `.ts` files directly (e.g., `export` / `as const`), causing syntax errors in imports from `/apps/backend/src/modules/auth/*.ts`.\n- The previous baseline in docs used **Jest 29 + ts-jest**. Jest 30 changed transform hooks; **ts-jest** isn’t a good fit for our setup anymore.\n- We need a **TS-aware** transform that works with Jest 30, is **fast**, and has **low migration risk**.\n\n# Decision Drivers\n\n- **Alignment with governance docs**: Backend = **Jest + Supertest** (PRD/TDD); QA Plan §8.1 calls out **Jest** for API tests.\n- **Low churn**: Keep reporters, snapshot behavior, watch mode, mock APIs, and existing Jest helpers.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 1, "token_count": 242, "hash_short": "d277a70d", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "docs**: Backend = **Jest + Supertest** (PRD/TDD); QA Plan §8.1 calls out **Jest** for API tests.\n- **Low churn**: Keep reporters, snapshot behavior, watch mode, mock APIs, and existing Jest helpers.\n- **Performance**: **SWC** is faster than Babel and avoids ts-jest’s overhead.\n- **CI stability**: Preserve coverage gates (≥ 80% lines & branches) and existing GitHub Actions steps.\n- **Future flexibility**: We can still standardize repo-wide later if needed via ADR/ADP.\n\n# Options Considered\n\n| Option                              | Summary                             | Pros                                                      | Cons                                                                                       |\n| ----------------------------------- | ----------------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------ |\n| **A.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 2, "token_count": 240, "hash_short": "2a08c476", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "| ----------------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------ |\n| **A. Jest 30 + @swc/jest (Chosen)** | Use SWC to transform TS for Jest 30 | Keeps Jest semantics; fast; minimal code changes; easy CI | Slightly different source-map behavior vs ts-jest; SWC config surface                      |\n| **B. Vitest (backend)**             | Migrate API tests to Vitest         | Very fast; native TS; modern runner                       | Diverges from QA §8.1 (Jest); requires adapting some Jest-specific helpers; ADR + QA edits |\n| **C. Pin Jest 29 + ts-jest**        | Roll back to the old stack          | Minimal work now                                          | Freezes on old major; future upgrade tax; slower than SWC                                  |\n\n# Scope\n\n- **In scope**: `/apps/backend` tests (unit + integration with Supertest), coverage collection, CI gates", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 3, "token_count": 250, "hash_short": "5bcea2a9", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "on old major; future upgrade tax; slower than SWC                                  |\n\n# Scope\n\n- **In scope**: `/apps/backend` tests (unit + integration with Supertest), coverage collection, CI gates.\n- **Out of scope**: Frontend (continue with Vitest), E2E (Playwright), load tests (k6).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 4, "token_count": 72, "hash_short": "b7ef748d", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "ope\n\n- **In scope**: `/apps/backend` tests (unit + integration with Supertest), coverage collection, CI gates.\n- **Out of scope**: Frontend (continue with Vitest), E2E (Playwright), load tests (k6).\n\n# Detailed Plan\n\n## 1) Dependencies (backend)\n\n`apps/backend/package.json` (devDependencies excerpt):\n\n```json\n{\n  \"jest\": \"^30.0.0\",\n  \"@swc/core\": \"^1.7.0\",\n  \"@swc/jest\": \"^0.2.36\",\n  \"supertest\": \"^7.0.0\",\n  \"typescript\": \"^5.6.0\"\n}\n```\n\n## 2) Jest config (ESM example)\n\n`apps/backend/jest.config.ts`:\n\n```ts\nimport type { Config } from \"jest\";\n\nconst config: Config = {\n  testEnvironment: \"node\",\n  transform: {\n    \"^.+\\.(t|j)s$\": [\n      \"@swc/jest\",\n      {\n        jsc: {\n          parser: { syntax: \"typescript\", decorators: true },\n          transform: { decoratorMetadata: true },\n        },\n        module: { type: \"es6\" },\n      },\n    ],\n  },\n  extensionsToTreatAsEsm: [\".ts\"],\n  moduleFileExtensions: [\"ts\", \"js\", \"json\"],\n  testMatch: [\"**/*.(spec|test).ts\"],\n  modulePathIgnorePatterns: [\"<rootDir>/dist\"],\n  moduleNameMapper: { \"^@/(.*)$\": \"<rootDir>/src/$1\" },\n  collectCoverageFrom: [\"src/**/*.ts\", \"!src/**/index.ts\", \"!src/**/__tests__/**\"],\n  coverageThreshold: { global: { lines: 80, branches: 80 } },\n};\n\nexport default config;\n```\n\n> If the backend is **CJS**, set `module: { type: 'commonjs' }` and remove `extensionsToTreatAsEsm`", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 5, "token_count": 339, "hash_short": "17c6c115", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "/**\"],\n  coverageThreshold: { global: { lines: 80, branches: 80 } },\n};\n\nexport default config;\n```\n\n> If the backend is **CJS**, set `module: { type: 'commonjs' }` and remove `extensionsToTreatAsEsm`.\n\n## 3) TS config for tests (optional)\n\n`apps/backend/tsconfig.jest.json`:\n\n```json\n{\n  \"extends\": \"./tsconfig.json\",\n  \"compilerOptions\": {\n    \"module\": \"ESNext\",\n    \"types\": [\"jest\", \"node\"]\n  }\n}\n```\n\n## 4) NPM scripts\n\n```json\n{\n  \"scripts\": {\n    \"test\": \"jest --runInBand --passWithNoTests\",\n    \"test:watch\": \"jest --watch\",\n    \"test:cov\": \"jest --coverage\"\n  }\n}\n```\n\n## 5) CI: keep gates and reports\n\n- No change to the CI stage names. Coverage uses V8 (default in Jest 30) and remains **≥ 80%** for lines & branches.\n- Ensure `apps/backend` test task in Turbo/Actions calls `pnpm --filter backend test`.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 6, "token_count": 204, "hash_short": "c1ad17f5", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "change to the CI stage names. Coverage uses V8 (default in Jest 30) and remains **≥ 80%** for lines & branches.\n- Ensure `apps/backend` test task in Turbo/Actions calls `pnpm --filter backend test`.\n\n# Risks & Mitigations\n\n| Risk                                | Impact                      | Mitigation                                                           |\n| ----------------------------------- | --------------------------- | -------------------------------------------------------------------- |\n| Source maps differ (SWC vs ts-jest) | Debugging stack traces      | Enable `sourceMaps` in SWC if needed; rely on IDE mappings           |\n| Decorators/metadata not emitted     | Tests using reflection fail | `decorators: true` + `decoratorMetadata: true` in `@swc/jest` config |\n| Mixed ESM/CJS friction              | Import/require errors       | Choose one module system per package; set `module.type` correctly    |\n| Snapshot diffs                      | Minor                       | Re-run snapshots once; review changes                                |\n| Coverage drift                      | Gate failures               | Keep `collectCoverageFrom` strict; validate in CI before merge       |", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 7, "token_count": 302, "hash_short": "b9b5b99d", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "hots once; review changes                                |\n| Coverage drift                      | Gate failures               | Keep `collectCoverageFrom` strict; validate in CI before merge       |\n\n\n# Backout Plan\n\nIf regressions appear, temporarily pin backend to **Jest 29 + ts-jest** (previous known-good), while keeping this ADP as the long-term target. Rollback steps: replace transform/preset, re-run CI, create a follow-up fix branch.\n\n# Consequences\n\n- **Positive**: Green tests on Jest 30; faster transforms; governance alignment; minimal developer retraining.\n- **Trade-offs**: Another tool (`@swc/*`) in the stack; slight differences in source-map accuracy vs ts-jest.\n\n# Compliance & Traceability\n\n- **PRD**: Testing approach and CI coverage thresholds remain as specified (≥ 80%). (PRD §6.4.4, PRD Tooling table updated to “Jest + SWC”).\n- **TDD**: Backend testing remains “Jest + Supertest” with coverage gates.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 8, "token_count": 232, "hash_short": "ae02a281", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_009", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "ng approach and CI coverage thresholds remain as specified (≥ 80%). (PRD §6.4.4, PRD Tooling table updated to “Jest + SWC”).\n- **TDD**: Backend testing remains “Jest + Supertest” with coverage gates.\n- **QA Plan**: Conforms to **§8.1 Backend (API) Test Strategy** and **§12 Toolchain & Automation** (Jest present).\n\n# Tasks (extract for backlog)\n\n- **A-120** Update `apps/backend/package.json` devDependencies (Jest 30 + @swc/jest).\n- **A-121** Add/adjust `jest.config.ts` (SWC transform, coverage settings).\n- **A-122** Ensure `moduleNameMapper` matches TS path aliases.\n- **A-123** Validate CI coverage gates (≥ 80% lines & branches).\n- **A-124** Smoke-run integration tests (Supertest) against running API.\n- **A-125** Update docs (PRD Tooling, TDD testing notes) to reflect Jest + SWC.\n- **A-126** (Optional) Create troubleshooting guide for ESM/CJS with Jest 30 + SWC.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 9, "token_count": 218, "hash_short": "e8aa105c", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc_chunk_010", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADP-021-test-runner-backend-jest30-swc", "text": "s (Supertest) against running API.\n- **A-125** Update docs (PRD Tooling, TDD testing notes) to reflect Jest + SWC.\n- **A-126** (Optional) Create troubleshooting guide for ESM/CJS with Jest 30 + SWC.\n\n# Appendix: Minimal Diff Preview\n\n```diff\n-  \"jest\": \"29.7.0\",\n-  \"ts-jest\": \"29.2.5\",\n+  \"jest\": \"^30.0.0\",\n+  \"@swc/core\": \"^1.7.0\",\n+  \"@swc/jest\": \"^0.2.36\"\n```\n\n```ts\n// jest.config.ts\n- export default { preset: 'ts-jest', testEnvironment: 'node' };\n+ export default {\n+   testEnvironment: 'node',\n+   transform: { '^.+\\.(t|j)s$': ['@swc/jest', { jsc: { parser: { syntax: 'typescript', decorators: true }, transform: { decoratorMetadata: true } }, module: { type: 'es6' } }] },\n+   extensionsToTreatAsEsm: ['.ts'],\n+   /* coverage + mapper + ignores as above */\n+ };\n```", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADP-021-test-runner-backend-jest30-swc.md", "category": "technical", "chunk_index": 10, "token_count": 193, "hash_short": "cb71ebe1", "version": 1.0, "title": "Decision", "mtime": "2025-10-19T17:57:29.915177", "ingested_at": "2025-11-30T04:00:44.055336", "tags": ["technical", "md"]}
