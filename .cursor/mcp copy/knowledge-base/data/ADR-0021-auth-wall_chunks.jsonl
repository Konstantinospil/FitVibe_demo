{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "---\nid: ADR-0021\ntitle: Enforce Authentication Wall (pre-login access limited to /auth/* only)\nstatus: Accepted\ndate: 2025-10-26\nowner: FitVibe Architecture (GPT-5 Thinking, on behalf of K. Pilpilidis)\nsupersedes: ADR-0007 (Public Feed Feature Flag)\n---\n\n## Context\n\nCurrent documentation sets **private-by-default** visibility with optional public surfaces via feature flags\n(e.g., public feed / share-by-link). This creates ambiguity about pre-login reachability and increases\nthe attack surface (scraping, token misuse, link leakage). The product direction is to **require login**\nfor all user-facing content unless strictly necessary for auth flows.\n\n## Decision\n\n1.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 0, "token_count": 167, "hash_short": "f2576b5f", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "creases\nthe attack surface (scraping, token misuse, link leakage). The product direction is to **require login**\nfor all user-facing content unless strictly necessary for auth flows.\n\n## Decision\n\n1. **Auth wall:** All app routes **MUST** require an authenticated session **except** the following unauthenticated endpoints:\n   - **GET/POST** `/auth/login`\n   - **POST** `/auth/register`\n   - **POST** `/auth/password-reset/request`\n   - **POST** `/auth/verify` (email token submission)\n   - **Static assets** needed to render the login/registration page (e.g., `/assets/*`, `/favicon.ico`).\n2. **Disable public surfaces:** The `PUBLIC_FEED` and any “share-by-link” or “public visibility” flags are **disabled** in all environments.\n3. **Legacy public links:** Any previously generated public URLs must now return **404 Not Found** and be purged from caches/CDN.\n4. **API semantics:**\n   - For API requests without a valid session/JWT: return **401 Unauthorized** (JSON error body).", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 1, "token_count": 245, "hash_short": "2d4e9f27", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "public URLs must now return **404 Not Found** and be purged from caches/CDN.\n4. **API semantics:**\n   - For API requests without a valid session/JWT: return **401 Unauthorized** (JSON error body).\n   - For SPA navigation: redirect unauthenticated users to **`/login`**.\n5. **Health checks:** `/healthz` remains **unauthenticated but IP-allowlisted at the reverse proxy** (ops control). No functional data is exposed.\n\n## Scope\n\n- Web SPA (React+Vite) and Backend API (Node/Express).\n- All environments (local, CI, staging, production).\n\n## Non-Goals\n\n- Changing the authentication mechanism itself (still JWT RS256 + refresh tokens).\n- Anonymous telemetry or cookie-banner flows (handled separately by compliance).\n\n## Security & Privacy Impact\n\n- Reduces data exposure risk and scraping.\n- Limits the blast radius of stolen public-share links.\n- Simplifies threat modeling and CSP rules for unauthenticated surfaces.\n- Aligns with privacy-by-default and GDPR data minimization.\n\n## Rollout Plan\n\n1.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 2, "token_count": 249, "hash_short": "ed5fc086", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "e blast radius of stolen public-share links.\n- Simplifies threat modeling and CSP rules for unauthenticated surfaces.\n- Aligns with privacy-by-default and GDPR data minimization.\n\n## Rollout Plan\n\n1. **Config:**\n   - Set `AUTH_WALL=true` in all envs.\n   - Set/confirm `PUBLIC_FEED=false` and remove any “public share” toggles from UI.\n2. **Backend middleware (pseudocode):**\n   ```ts\n   // auth-wall.ts (Express middleware)\n   const ALLOWLIST = new Set([\n     '/auth/login', '/auth/register', '/auth/password-reset/request', '/auth/verify',\n     '/favicon.ico'\n   ]);\n   export function authWall(req, res, next) {\n     if (req.method === 'GET' and req.path.startsWith('/assets/')) return next();\n     if (ALLOWLIST.has(req.path)) return next();\n     if (req.user) return next();\n     const isApi = req.path.startsWith('/api/');\n     return isApi ? res.status(401).json({error:'unauthorized'}) : res.redirect('/login');\n   }\n   ```\n3.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 3, "token_count": 233, "hash_short": "1446b6a1", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "rn next();\n     if (req.user) return next();\n     const isApi = req.path.startsWith('/api/');\n     return isApi ? res.status(401).json({error:'unauthorized'}) : res.redirect('/login');\n   }\n   ```\n3. **Frontend routing:**\n   - Guard all routes except `/login` and `/register`.\n   - Remove “public share” UI and any references to public feed.\n4. **Data/Artifacts:**\n   - Invalidate and delete existing public share tokens/rows (if any).\n   - CDN purge for known public URLs.\n5. **Docs:**\n   - Update QA/UAT scenarios (see linked AC document).\n   - Mark ADR-0007 as superseded.\n\n## Alternatives Considered\n\n- Keep public-by-link while tightening token entropy/expiry → rejected (still leaks via referrers/analytics).\n- Partial wall (read public, write private) → rejected (complex policy surface).\n\n## Consequences\n\n- Some marketing/SEO benefits of public pages are lost; deliberate decision.\n- Simpler mental model for users and developers.\n- Fewer conditional branches in tests and middleware.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 4, "token_count": 248, "hash_short": "e6dc3ae6", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-0021-auth-wall", "text": "## Consequences\n\n- Some marketing/SEO benefits of public pages are lost; deliberate decision.\n- Simpler mental model for users and developers.\n- Fewer conditional branches in tests and middleware.\n\n## Monitoring & Reversibility\n\n- Track 401/302 rates post-rollout.\n- One-feature-flag rollback: `AUTH_WALL=false` (re-enable former behavior), but `PUBLIC_FEED` stays false unless explicitly re-approved via ADR.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-0021-auth-wall.md", "category": "technical", "chunk_index": 5, "token_count": 102, "hash_short": "2e972b81", "version": 1.0, "title": "Adr 0021 Auth Wall", "mtime": "2025-10-26T22:25:26.285890", "ingested_at": "2025-11-30T04:00:44.070370", "tags": ["technical", "md"]}
