{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes", "text": "# ADR-007 — Idempotency Policy for Writes\n\n> **File:** docs/adr/ADR-007-idempotency-policy-for-writes.md  \n> **Purpose:** Prevent duplicate side‑effects on retried client requests and provide deterministic, safe replays.\n\n---\n\nid: ADR-007\ntitle: \"Idempotency Policy for Writes\"\nstatus: \"Proposed\"\ndate: \"2025-10-13\"\nowners: [\"Dr. Konstantinos Pilpilidis\"]\nversion: \"1.0\"\nlinks:\n\n- TDD §5.7: \"Command handling & retries\"\n- TDD §7.14: \"HTTP conventions\"\n\n---\n\n\n## Context\n\nThe SPA and future mobile clients perform retries on network failures. Without idempotency, duplicate POST/PUT/PATCH requests can create extra resources or apply the same mutation multiple times. We need a consistent policy and server storage model to deduplicate safely across instances and after restarts.\n\n## Decision\n\nAdopt the **`Idempotency-Key`** header for all **unsafe** endpoints (POST/PUT/PATCH/DELETE) that create or mutate resources. Keys are **opaque**, **client‑generated**, and **unique per logical operation**.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-007-idempotency-policy-for-writes.md", "category": "technical", "chunk_index": 0, "token_count": 249, "hash_short": "d0efd17b", "version": 1.0, "title": "ADR-007 — Idempotency Policy for Writes", "mtime": "2025-10-18T10:54:49.853323", "ingested_at": "2025-11-30T04:00:44.094502", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes", "text": "the **`Idempotency-Key`** header for all **unsafe** endpoints (POST/PUT/PATCH/DELETE) that create or mutate resources. Keys are **opaque**, **client‑generated**, and **unique per logical operation**. The server stores request **fingerprints** for **24h**, enforces **payload match**, and **replays deterministic responses**.\n\n### Rules\n\n- Clients send `Idempotency-Key: <uuid>` per operation; keys are **single‑use** for that route and principal.\n- Server stores `{ key, route, method, principal, body_hash, response_code, response_body, created_at, ttl }`.\n- On duplicate with **same** `body_hash`: **return stored response** (status + body); do **not** re‑execute side‑effects.\n- On duplicate with **different** `body_hash`: return **409 Conflict** with machine‑readable error.\n- TTL: **24 hours** by default; configurable. After expiry, key is forgotten; new request executes.\n- **Scoping**: Key is scoped to `{principal, method, route_template}`; different routes require different keys.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-007-idempotency-policy-for-writes.md", "category": "technical", "chunk_index": 1, "token_count": 247, "hash_short": "5da07c47", "version": 1.0, "title": "ADR-007 — Idempotency Policy for Writes", "mtime": "2025-10-18T10:54:49.853323", "ingested_at": "2025-11-30T04:00:44.094502", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes", "text": "ours** by default; configurable. After expiry, key is forgotten; new request executes.\n- **Scoping**: Key is scoped to `{principal, method, route_template}`; different routes require different keys.\n\n### Storage & Concurrency\n\n- Storage backend: **Redis** (primary) with TTL; fallback to Postgres table `system.idempotency_keys` when Redis unavailable (best‑effort).\n- Atomic write: `SETNX` or Lua script for **first‑write wins**; store provisional record before executing the command.\n- On success/failure: fill stored **final response** to enable deterministic replay.\n\n### Responses\n\n- Include header: `Idempotency-Key: <key>` in responses (original and replayed).\n- Include `Idempotent-Replayed: true` on replayed responses.\n\n## Consequences\n\n- Prevents duplicate resource creation and repeated charges/side‑effects.\n- Requires additional infra (Redis) and careful atomicity.\n\n## Alternatives Considered\n\n- **No idempotency**: Simpler but unsafe.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-007-idempotency-policy-for-writes.md", "category": "technical", "chunk_index": 2, "token_count": 237, "hash_short": "7af6e2be", "version": 1.0, "title": "ADR-007 — Idempotency Policy for Writes", "mtime": "2025-10-18T10:54:49.853323", "ingested_at": "2025-11-30T04:00:44.094502", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-007-idempotency-policy-for-writes", "text": "events duplicate resource creation and repeated charges/side‑effects.\n- Requires additional infra (Redis) and careful atomicity.\n\n## Alternatives Considered\n\n- **No idempotency**: Simpler but unsafe.\n- **Request signatures without storage**: Cannot protect across restarts or multi‑node.\n\n## QA & Acceptance\n\n- Unit tests for same‑payload replay and mismatched 409 behavior.\n- Race tests ensure first writer wins and others replay.\n- TTL expiry tests: after 24h, request executes again.\n\n## Backout Plan\n\nDisable enforcement per route via feature flag; clients may continue to send keys but server ignores them.\n\n## Change Log\n\n- **1.0 (2025-10-13):** Initial proposal.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-007-idempotency-policy-for-writes.md", "category": "technical", "chunk_index": 3, "token_count": 167, "hash_short": "0b6dfc43", "version": 1.0, "title": "ADR-007 — Idempotency Policy for Writes", "mtime": "2025-10-18T10:54:49.853323", "ingested_at": "2025-11-30T04:00:44.094502", "tags": ["technical", "md"]}
