{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "# ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)\n\n**Date:** 2025-10-14  \n**Status:** Accepted  \n**Author:** Reviewer  \n**Cross-References:** PRD §5 Security/Privacy, §6 Media & Files, §7 Engineering Standards; TDD §5.1.6 (uploads), §6.2 (schema), §7.9 (media access), §10 (ops); QA §2–§12 (CI gates, security), §11 (performance), §14 (perf regression)\n\n---\n\n\n## Context\n\nEarlier drafts stored avatars as **base64 blobs in the DB**, which increases row size, complicates caching, and weakens scanning and access controls. The PRD and TDD require **object storage in production** (S3-compatible or GCS), **antivirus scanning**, **re-encoding to safe image formats**, strict **size/type limits**, and **private-by-default** access via signed URLs or a media proxy. QA enforces security scanning, performance budgets, and E2E coverage for the upload/change avatar flow.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 0, "token_count": 221, "hash_short": "4ad9dd4e", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "rict **size/type limits**, and **private-by-default** access via signed URLs or a media proxy. QA enforces security scanning, performance budgets, and E2E coverage for the upload/change avatar flow.\n\nThis ADR standardizes avatar handling and media storage in a way that is privacy-first, performant, and testable under CI.\n\n---\n\n## Decision\n\n1. **Storage & Access**\n   - **Production:** Store images in **object storage** (S3-compatible/GCS) in a **private bucket**.\n   - **Development:** Store under local `./uploads` with the same interface (adapter pattern).\n   - **Access:** Serve via **short-lived signed URLs** (preferred) or a **server proxy** that checks authorization and sets cache headers.\n\n2. **Upload Flow (Server-Mediated)**\n   1. Client `POST /api/v1/users/{id}/avatar` (multipart).\n   2. Server validates authn/z, **rate limits**, and content-type/size.\n   3. Server streams to temp storage, performs **AV scan**.\n   4.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 1, "token_count": 233, "hash_short": "f2740440", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "**\n   1. Client `POST /api/v1/users/{id}/avatar` (multipart).\n   2. Server validates authn/z, **rate limits**, and content-type/size.\n   3. Server streams to temp storage, performs **AV scan**.\n   4. Server **re-encodes** and **strips EXIF**; generates derivative sizes (**128, 256, 512** px square) using letterboxing/cropping rules.\n   5. Server uploads originals/derivatives to object storage with keys (see §4).\n   6. Metadata record created in DB; user profile points to the active asset.\n   7. Old assets are scheduled for deletion (grace window ≤ 24h) and invalidated from caches/CDN.\n\n   > Optional: For large media, support **pre-signed POST** initiation, but finalization still goes through server validation & AV scan before activation.\n\n3. **Constraints & Validation**\n   - **Accepted types:** `image/jpeg`, `image/png`, `image/webp`.\n   - **Max size:** **5 MB** (request rejected otherwise).\n   - **Dimensions:** min 64×64; max 4096×4096; auto-resize to derivative set.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 2, "token_count": 245, "hash_short": "6bbf2e3c", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "**Accepted types:** `image/jpeg`, `image/png`, `image/webp`.\n   - **Max size:** **5 MB** (request rejected otherwise).\n   - **Dimensions:** min 64×64; max 4096×4096; auto-resize to derivative set.\n   - **MIME sniffing** by magic number; filename extensions are advisory only.\n\n4. **Object Keys & Versioning**\n   - Bucket structure: `avatars/{user_ulid}/{sha256[:16]}/{size}.webp` where `size ∈ {orig,128,256,512}`.\n   - Keys are **content-addressed** (hash-based) to enable cache-busting; the **user record references the active key**.\n   - On update, the pointer changes; old keys are deleted after grace window and lifecycle rules purge from storage/CDN.\n\n5. **Database Model**\n   - Table: `media_assets` with fields:\n     - `id (ulid)`, `owner_user_id (ulid)`, `kind ('avatar')`, `bucket`, `key_prefix`, `format`, `size_bytes`, `width`, `height`, `hash_sha256`, `created_at`, `deleted_at` (nullable).\n   - `users.avatar_asset_id` references `media_assets.id`.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 3, "token_count": 240, "hash_short": "6be9b0c0", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "ind ('avatar')`, `bucket`, `key_prefix`, `format`, `size_bytes`, `width`, `height`, `hash_sha256`, `created_at`, `deleted_at` (nullable).\n   - `users.avatar_asset_id` references `media_assets.id`.\n   - Derivatives share `key_prefix`; each file stored separately.\n\n6. **Security & Privacy**\n   - **AV scan** must pass before any asset is activated.\n   - **Private-by-default**: no public ACLs; signed URLs expire quickly (e.g., ≤ 10 min).\n   - **EXIF/metadata stripped** to avoid location/device leakage.\n   - **CSP** ensures images load from the media domain only.\n   - **Logging:** No PII; record asset IDs and correlation IDs only.\n\n7. **Caching & CDN**\n   - Set `Cache-Control` on media responses; leverage CDN with **origin shielding**.\n   - Client-side `ETag`/`If-None-Match` supported by the proxy; for signed URLs, rely on key changes to invalidate caches.\n   - Derivative sizes reduce layout shifts and improve LCP.\n\n8.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 4, "token_count": 231, "hash_short": "00d98c3e", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "shielding**.\n   - Client-side `ETag`/`If-None-Match` supported by the proxy; for signed URLs, rely on key changes to invalidate caches.\n   - Derivative sizes reduce layout shifts and improve LCP.\n\n8. **Deletion & DSR**\n   - User-triggered avatar removal marks the asset as `deleted_at` and removes pointers.\n   - Objects and derivatives are deleted from storage; **backups** purge within **≤14 days** per retention policy.\n   - Signed URLs or cached versions naturally expire; no PII is exposed via object names.\n\n9. **Performance & Budgets**\n   - Upload endpoints are tracked separately from general API p95; **target p95 ≤ 1200 ms** end-to-end for a 1–3 MB image in staging parity.\n   - General API budgets remain **p95 < 300 ms**; avatar reads via CDN should be ≤ 100 ms p95.\n\n10. **Operations & Secrets**\n    - Separate **IAM role** for media read/write; **least privilege**.\n    - Rotating access keys; CI uses OIDC federation or environment-scoped secrets.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 5, "token_count": 240, "hash_short": "1314b1cf", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "100 ms p95.\n\n10. **Operations & Secrets**\n    - Separate **IAM role** for media read/write; **least privilege**.\n    - Rotating access keys; CI uses OIDC federation or environment-scoped secrets.\n    - Bucket **lifecycle rules** remove orphaned objects and incomplete uploads.\n\n11. **Feature Flags & Fallbacks**\n    - **Feature flag** guards S3/GCS use in non-prod; dev defaults to filesystem adapter.\n    - If user has no avatar, render a **generated letter avatar** based on display name or a neutral silhouette.\n\n---\n\n## Consequences\n\n**Positive**\n\n- Privacy-first and scalable; fast delivery via CDN; safe formats and sizes.\n- Clear cache-busting and easy revocation via key rotation.\n- Testable under CI with deterministic adapters and DB schema.\n\n**Negative / Trade-offs**\n\n- Requires object storage credentials and AV infrastructure.\n- Slight complexity around derivatives and lifecycle rules.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 6, "token_count": 225, "hash_short": "eba86dab", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "der CI with deterministic adapters and DB schema.\n\n**Negative / Trade-offs**\n\n- Requires object storage credentials and AV infrastructure.\n- Slight complexity around derivatives and lifecycle rules.\n\n**Operational**\n\n- Monitor AV scan performance and failure rates; alert on upload spikes and 5xx from the media proxy.\n- Track storage growth; enable lifecycle reports and cost alerts.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 7, "token_count": 96, "hash_short": "a0dace6a", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "cycle rules.\n\n**Operational**\n\n- Monitor AV scan performance and failure rates; alert on upload spikes and 5xx from the media proxy.\n- Track storage growth; enable lifecycle reports and cost alerts.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 8, "token_count": 49, "hash_short": "9206a16e", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64_chunk_009", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-017-avatar-handling-base64", "text": "---\n\n## Alternatives Considered\n\n| Option                    | Description                       | Reason Rejected                                                    |\n| ------------------------- | --------------------------------- | ------------------------------------------------------------------ |\n| **DB base64 blobs**       | Store raw base64 in a text column | Bloats DB, poor cacheability, harder scanning; contradicts PRD/TDD |\n| **Public bucket**         | Public-read objects               | Violates private-by-default and revocation requirements            |\n| **Client-direct S3 only** | Browser uploads straight to S3    | Hard to enforce AV scan/authz; server must still gate activation   |\n\n---\n\n## References\n\n- PRD: Media/storage requirements, security & privacy baselines, engineering standards\n- TDD: Upload flow, schema, media access model, operations\n- QA: CI gates (security/perf), E2E upload tests, regression budgets\n\n---\n\n## Status Log\n\n| Version | Date       | Change                                                                               | Author   |\n| ------- | ---------- | ------------------------------------------------------------------------------------ | -------- |\n| v1.0    | 2025-10-14 | Adopt object storage, AV scan, derivatives, signed access; remove DB base64 approach | Reviewer |", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-017-avatar-handling-base64.md", "category": "technical", "chunk_index": 9, "token_count": 333, "hash_short": "d2dd050e", "version": 1.0, "title": "ADR-017: Avatar Handling & Media Storage (Object Storage + AV Scan)", "mtime": "2025-10-18T10:54:50.010786", "ingested_at": "2025-11-30T04:00:44.135055", "tags": ["technical", "md"]}
