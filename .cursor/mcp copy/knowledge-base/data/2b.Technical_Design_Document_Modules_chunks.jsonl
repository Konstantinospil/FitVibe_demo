{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "﻿---\ntitle: \"FitVibe Technical Design Document (TDD): Modules\"\nversion: \"v2.0\"\nstatus: \"Accepted\"\nowner: \"Konstantinos Pilpilidis (Dr.)\"\ndate: \"2025-10-21\"\nlinks:\n  - PRD: docs/1.Product_Requirements_Document.md\n  - QA: docs/3.Testing_and_Quality_Assurance_Plan.md\n  - ADR Index: docs/adr/README.md\nlicense: \"MIT\"\n---\n\n# 0. Introduction\n\n## 0.1 Purpose & Scope\n\nThis TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).\n\n## 0.2 Audience & Reading Guide\n\n- **Engineers** implement according to specs, contracts, and runbooks.\n- **QA** uses RTM links to derive tests and quality gates.\n- **Security/Compliance** verifies controls, data classification, GDPR flows.\n- **Product/Design** confirms that behavior matches PRD intent.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 0, "token_count": 227, "hash_short": "0c163da9", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "**QA** uses RTM links to derive tests and quality gates.\n- **Security/Compliance** verifies controls, data classification, GDPR flows.\n- **Product/Design** confirms that behavior matches PRD intent.\n\n## 0.3 Assumptions & Constraints\n\n- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL ≥ 14 (target 16-18 locally).\n- All external calls (email) are **adapterized** and mockable for tests.\n- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.\n- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.\n\n## 0.4 Versioning & Changelog\n\n- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.\n\n---\n\n# 4. Feature Modules (per Functional Requirement)\n\n> This section specifies module responsibilities, state models, input/output contracts, permissions, error cases, non-goals, and test hooks.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 1, "token_count": 240, "hash_short": "46cee2d3", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": ".\n\n---\n\n# 4. Feature Modules (per Functional Requirement)\n\n> This section specifies module responsibilities, state models, input/output contracts, permissions, error cases, non-goals, and test hooks. Detailed API paths and DTOs are listed in §7 (API Design) and the database design in §6 (Data Design).\n\n## 4.0 Conventions for Module Specs\n\n- **Roles:** `anonymous`, `user`, `admin`.\n- **Identifiers:** UUIDv7/ULID, immutable.\n- **Timestamps:** UTC, RFC 3339 strings in APIs.\n- **Idempotency:** State-changing endpoints accept `Idempotency-Key` (store for 24h).\n- **Rate limits:** Per-IP and per-account; auth flows stricter.\n- **Privacy default:** All user-created content is **private** unless explicitly published/shared.\n- **Error envelope:** `{ \"error\": { \"code\", \"message\", \"details\", \"requestId\" } }`.\n\n---\n\n## 4.1 Authentication & Authorization (FR-1)\n\n### 4.1.1 Responsibilities\n\n- Account lifecycle: register → email verify → login → refresh rotation → logout.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 2, "token_count": 242, "hash_short": "5ee75013", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "essage\", \"details\", \"requestId\" } }`.\n\n---\n\n## 4.1 Authentication & Authorization (FR-1)\n\n### 4.1.1 Responsibilities\n\n- Account lifecycle: register → email verify → login → refresh rotation → logout.\n- Password reset (request + complete).\n- Optional 2FA (TOTP) with backup codes; feature flag controllable.\n- Session management (revoke all / device-level).\n- Lockout & brute-force protection; no user enumeration.\n- RBAC: role assignment (`user`, `admin`).\n\n### 4.1.2 States & Flows\n\nSee also [State flows](./diagrams/tdd-4-1-2-states-flows.mmd).\n\n- **Sessions:** Short-lived access token; long-lived refresh token bound to a session id; rotation on refresh; stolen-token detection (rotate-with-reused refresh → revoke session family).\n\n### 4.1.3 Inputs/Outputs (high-level)\n\n- **Register:** `email`, `password`, `alias` (unique, case-insensitive), optional locale.\n- **Verify:** `token` (email link) within TTL.\n- **Login:** `email`+`password` (+`otp` if 2FA enabled) → `{accessToken, refreshToken}`", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 3, "token_count": 250, "hash_short": "c8394df2", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_004", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "`password`, `alias` (unique, case-insensitive), optional locale.\n- **Verify:** `token` (email link) within TTL.\n- **Login:** `email`+`password` (+`otp` if 2FA enabled) → `{accessToken, refreshToken}`.\n- **Refresh:** `refreshToken` → new `{accessToken, refreshToken}`.\n- **Password reset:** request with `email`; complete with `token` + `newPassword`.\n\n### 4.1.4 Permissions & Policies\n\n- **Anonymous:** register, login, password-reset request, verify.\n- **User:** refresh, logout, 2FA setup/disable (with password confirmation), revoke sessions.\n- **Admin:** manage roles; access global audit (no content peeking without lawful basis).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 4, "token_count": 158, "hash_short": "6ca5c0b1", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_005", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "quest, verify.\n- **User:** refresh, logout, 2FA setup/disable (with password confirmation), revoke sessions.\n- **Admin:** manage roles; access global audit (no content peeking without lawful basis).\n\n### 4.1.5 Security Controls\n\n- RS256 JWT; key rotation via JWKS; leeway ≤ 60s;\n- Lockout progressive backoff; event-based alerts for brute force;\n- CSRF not applicable to pure token APIs; if cookies used, enforce same-site + CSRF token;\n- Strict headers via edge; CORS allow-list;\n- No user enumeration: identical messages for existent/non-existent emails;\n- Password policy: minimum 12 characters and must include uppercase, lowercase, number, and symbol.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 5, "token_count": 164, "hash_short": "aea3f007", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_006", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "edge; CORS allow-list;\n- No user enumeration: identical messages for existent/non-existent emails;\n- Password policy: minimum 12 characters and must include uppercase, lowercase, number, and symbol. Enforced at `/auth/register` and `/auth/password/reset`; violations return explicit validation errors (400) and QA tests cover both endpoints;\n- Verification tokens TTL = 15 minutes;\n- Reset tokens TTL = 15 minutes;\n- Verification email resend ≤ 3/hour;\n- unverified accounts auto-purged after 7 days;\n- **Logout invalidation:** logging out **revokes the active refresh session family** (all tokens bound to its `jti`).\n\n### 4.1.6 Error Codes (sample)\n\n- `E.AUTH.INVALID_CREDENTIALS` (401), `E.AUTH.LOCKED` (423), `E.AUTH.TOTP_REQUIRED` (401), `E.AUTH.TOKEN_EXPIRED` (401), `E.AUTH.IDEMPOTENT_REPLAY` (409).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 6, "token_count": 201, "hash_short": "3d1c0db9", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_007", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ts `jti`).\n\n### 4.1.6 Error Codes (sample)\n\n- `E.AUTH.INVALID_CREDENTIALS` (401), `E.AUTH.LOCKED` (423), `E.AUTH.TOTP_REQUIRED` (401), `E.AUTH.TOKEN_EXPIRED` (401), `E.AUTH.IDEMPOTENT_REPLAY` (409).\n\n### 4.1.7 Non-goals (MVP)\n\n- Social login (OAuth), WebAuthn, SSO;\n\n### 4.1.8 Test Hooks\n\n- Seeded test users; mail adapter in test mode; clock freeze for token TTL; brute-force simulation; TOTP deterministic secret in test env.\n\n---\n\n## 4.2 Users & Profile (FR-2)\n\n### 4.2.1 Responsibilities\n\n- Manage user profile:\n  - display name,\n  - alias,\n  - bio,\n  - locale,\n  - avatar,\n  - weight\n  - fitness level\n  - training frequency\n  - privacy toggles\n- **Alias** uniqueness (case-insensitive via `citext`), URL-safe.\n- Avatar upload with AV scan; automatic resizing on FE/CDN. generate a 128×128 avatar derivative (preview).\n- Privacy defaults and visibility toggles (e.g., hide age/weight).\n- Audit of profile changes (immutable historical log).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 7, "token_count": 236, "hash_short": "0caa01a8", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_008", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "utomatic resizing on FE/CDN. generate a 128×128 avatar derivative (preview).\n- Privacy defaults and visibility toggles (e.g., hide age/weight).\n- Audit of profile changes (immutable historical log).\n\n### 4.2.2 State Model\n\n- `ACTIVE` | `DEACTIVATED` | `DELETED(PENDING_PURGE)`.\n- Profile fields categorized: **public**, **followers**, **private**; default = **private**.\n\n### 4.2.3 Inputs/Outputs\n\n- **Update profile:** partial DTO; server validates lengths/formats; alias change rate-limited (e.g., 1/30d).\n- **Get profile:** own profile (full), others' profile (respecting visibility).\n\n### 4.2.4 Permissions\n\n- **User:** read/write own profile; delete account (DSR flow triggers).\n- **Admin:** read minimal metadata for moderation; cannot bypass DSR rules.\n\n### 4.2.5 Constraints\n\n- Unique `(LOWER(alias))`; max 32 chars; reserved names blocked.\n- Avatar: max size (e.g., 5MB), image-only MIME, AV scan required; **128×128 derivative** stored for previews.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 8, "token_count": 239, "hash_short": "e2504a49", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_009", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "### 4.2.5 Constraints\n\n- Unique `(LOWER(alias))`; max 32 chars; reserved names blocked.\n- Avatar: max size (e.g., 5MB), image-only MIME, AV scan required; **128×128 derivative** stored for previews.\n- Immutability: `date_of_birth` and `gender` are immutable after first set (enforced by trigger).\n- **Enumerations:**\n  - `gender ∈ {man, woman, diverse, prefer_not_to_say}`\n  - `fitnessLevel ∈ {beginner, intermediate, advanced, elite}`\n  - `trainingFrequency ∈ {rarely, 1_2_per_week, 3_4_per_week, 5_plus_per_week}`\n  - `weightUnit ∈ {kg, lb}`\n- **Validation & Storage:**\n  - `weight` accepted as user input with `weightUnit`; internally stored as **kg** (`weight_kg`), UI converts for display.\n  - Acceptable `weight` range (kg-equivalent): **20–400**.\n\n### 4.2.6 Error Codes\n\n- `E.USER.ALIAS_TAKEN` (409), `E.USER.AVATAR_INVALID` (422), `E.USER.VISIBILITY_FORBIDDEN` (403).\n\n### 4.2.7 Non-goals\n\n- Messaging (DMs).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 9, "token_count": 229, "hash_short": "6a98f79a", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_010", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "range (kg-equivalent): **20–400**.\n\n### 4.2.6 Error Codes\n\n- `E.USER.ALIAS_TAKEN` (409), `E.USER.AVATAR_INVALID` (422), `E.USER.VISIBILITY_FORBIDDEN` (403).\n\n### 4.2.7 Non-goals\n\n- Messaging (DMs).\n\n### 4.2.8 Test Hooks\n\n- Fixtures for alias collision; image EICAR string to test AV rejection; visibility matrix tests.\n\n---\n\n## 4.3 Exercise Library (FR-3)\n\n### 4.3.1 Responsibilities\n\n- CRUD for **exercises** (name, category, primary muscles, equipment, instructions).\n- Ownership model: **user-owned** and **admin-owned global** exercises.\n- Tagging & search (text + filters: category, equipment, muscles).\n- Versioning optional: semantic revs for instructions changes (keeps history).\n\n### 4.3.2 State Model\n\n- `DRAFT` → `PUBLISHED` → `ARCHIVED`. Admins may delete global exercises when required (policy/ToS breach);\n- Default action is archive. Deletion requires safety checks (no dangling FKs) and audit log.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 10, "token_count": 228, "hash_short": "3e412744", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_011", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "DRAFT` → `PUBLISHED` → `ARCHIVED`. Admins may delete global exercises when required (policy/ToS breach);\n- Default action is archive. Deletion requires safety checks (no dangling FKs) and audit log.\n\n### 4.3.3 Inputs/Outputs\n\n- **Create/Update:** name (i18n token or plain), category (FK), fields; server normalizes and dedupes by normalized key.\n- **Search:** `q`, `category`, `equipment`, `primary_muscle`, `tags`, pagination.\n\n### 4.3.4 Permissions\n\n- **User:** full CRUD on own exercises; read global; propose changes to global (admin review, Phase 2).\n- **Admin:** CRUD on global exercises; moderation queue.\n\n### 4.3.5 Constraints & Indexing\n\n- Unique `(owner_id, normalized_name)` for user-owned; unique `(normalized_name)` for global.\n- GIN index on tags; trigram/text index on `name_normalized`.\n\n### 4.3.6 Error Codes\n\n- `E.EXERCISE.DUPLICATE` (409), `E.EXERCISE.FORBIDDEN` (403), `E.EXERCISE.NOT_FOUND` (404).\n\n### 4.3.7 Non-goals\n\n- Community ratings/reviews (Phase 2+).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 11, "token_count": 245, "hash_short": "4bc0b76b", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_012", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "n `name_normalized`.\n\n### 4.3.6 Error Codes\n\n- `E.EXERCISE.DUPLICATE` (409), `E.EXERCISE.FORBIDDEN` (403), `E.EXERCISE.NOT_FOUND` (404).\n\n### 4.3.7 Non-goals\n\n- Community ratings/reviews (Phase 2+).\n\n### 4.3.8 Test Hooks\n\n- Seed minimal global categories; search relevance snapshots; archive visibility tests.\n\n---\n\n## 4.4 Planning & Sessions (FR-4)\n\n### 4.4.1 Responsibilities\n\n- Plan and log **training sessions** with structured **session_exercises** and **sets**.\n- Distinguish **planned** vs **actual**; allow editing with audit trail.\n- Recurrence templates (weekly/bi-weekly);\n- Track plan completion progress (sessions completed vs planned).\n- Allow cloning plans between users (with attribution).\n- Associate sessions with their source plan (optional relationship).\n- Quick-add from library.\n- Idempotent creation to avoid duplicates on flaky networks.\n- Deletion policy: user-initiated deletes are **soft-deletes (archive)** for historical traceability.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 12, "token_count": 240, "hash_short": "e0af5bfa", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_013", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ionship).\n- Quick-add from library.\n- Idempotent creation to avoid duplicates on flaky networks.\n- Deletion policy: user-initiated deletes are **soft-deletes (archive)** for historical traceability.\n\n### 4.4.2 Data & State\n\n- Session: `DRAFT` | `ACTIVE` | `COMPLETED` | `ARCHIVED`.\n- Set: repetitions/weight/time/distance/RPE; optional notes; order preserved.\n- Time fields: `starts_at`, `ends_at`, `duration_sec` (derived).\n- Plans contain metadata: title, description, duration (weeks), target frequency\n- Plans reference exercise templates but not specific dates (sessions materialize from plans)\n- **Privacy default:** sessions are **private** by default. Toggling to public is **non-retroactive** and never exposes previously private data.\n\n### 4.4.3 Inputs/Outputs\n\n- **Create/Update session:** DTO with metadata + nested exercises/sets.\n- **Complete session:** set status + fill actual metrics; partial completion allowed.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 13, "token_count": 232, "hash_short": "549ad066", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_014", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "private data.\n\n### 4.4.3 Inputs/Outputs\n\n- **Create/Update session:** DTO with metadata + nested exercises/sets.\n- **Complete session:** set status + fill actual metrics; partial completion allowed.\n- **Clone/Template:** source session id → new planned session (date offset).\n- **Create plan**: `{ title, description, duration_weeks, target_frequency, template_sessions: [...] }`\n- **Activate plan**: user subscribes; system generates scheduled sessions based on recurrence\n- **Track progress**: aggregate `sessions.status` where `session.plan_id = plan.id`\n\n### 4.4.4 Permissions\n\n- **User:** CRUD on own sessions; share-read if explicitly published.\n- **Admin:** no access to private content; only moderation metadata.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 14, "token_count": 180, "hash_short": "f3cf56dd", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_015", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "` where `session.plan_id = plan.id`\n\n### 4.4.4 Permissions\n\n- **User:** CRUD on own sessions; share-read if explicitly published.\n- **Admin:** no access to private content; only moderation metadata.\n\n### 4.4.5 Constraints & Integrity\n\n- `duration_weeks` ∈ [1..52]\n- `target_frequency` ∈ [1..7] sessions per week\n- Template sessions must have valid exercise references\n- Deleting a plan does NOT delete associated completed sessions (historical integrity)\n- All nested writes **transactional**; reject partial commits.\n- Idempotency via key persisted to `session_write_log` table.\n- Validation of set metrics (e.g., no negative reps/weights).\n\n### 4.4.6 Error Codes\n\n- `E.SESSION.CONFLICT` (409),\n- `E.SESSION.INVALID_SET` (422),\n- `E.SESSION.IDEMPOTENT_REPLAY` (409).\n- `E.PLAN.INVALID_DURATION` (422)\n- `E.PLAN.FREQUENCY_OUT_OF_RANGE` (422)\n- `E.PLAN.NOT_FOUND` (404)\n- `E.PLAN.FORBIDDEN` (403)\n\n### 4.4.7 Non-goals\n\n- Real-time collaborative editing (Phase 2+).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 15, "token_count": 240, "hash_short": "3209b3a6", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_016", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "9).\n- `E.PLAN.INVALID_DURATION` (422)\n- `E.PLAN.FREQUENCY_OUT_OF_RANGE` (422)\n- `E.PLAN.NOT_FOUND` (404)\n- `E.PLAN.FORBIDDEN` (403)\n\n### 4.4.7 Non-goals\n\n- Real-time collaborative editing (Phase 2+).\n- AI-generated plans (Phase 2)\n- Adaptive plan adjustments based on performance\n\n### 4.4.8 Test Hooks\n\n- Golden snapshot DTOs; property-based tests for set validators; idempotency replay suite.\n- Factory: `makePlan({ ownerId, title, duration_weeks })`\n- Activation flow: verify sessions generated correctly\n- Progress calculation: deterministic session count\n\n---\n\n## 4.5 Progress & Analytics (FR-5)\n\n### 4.5.1 Responsibilities\n\n- Compute and expose rollups: total volume, estimated 1RM per exercise, weekly mileage, time-in-zone, streaks.\n- Provide **materialized views** and cached aggregates; consistency guarantees (eventual within minutes).\n\n### 4.5.2 Data & State\n\n- Views: `session_summary`, `exercise_prs`, `weekly_aggregates`.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 16, "token_count": 233, "hash_short": "10144b55", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_017", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ks.\n- Provide **materialized views** and cached aggregates; consistency guarantees (eventual within minutes).\n\n### 4.5.2 Data & State\n\n- Views: `session_summary`, `exercise_prs`, `weekly_aggregates`.\n- Refresh policy: incremental refresh or scheduled job (e.g., every 5 min; immediate refresh on session completion for own views).\n\n### 4.5.3 Inputs/Outputs\n\n- **Get dashboards:** time range filters; aggregation grain (day/week/month).\n\n### 4.5.4 Permissions\n\n- **User:** read own analytics; share specific charts when session/feed is public.\n- **Admin:** no visibility into private user data beyond anonymized metrics.\n\n### 4.5.5 Constraints\n\n- Response size ≤ 1MB; pagination/slicing for long ranges.\n- Numerical stability for PRs; documented formulas (appendix).\n\n### 4.5.6 Error Codes\n\n- `E.ANALYTICS.RANGE_TOO_LARGE` (413), `E.ANALYTICS.UNSUPPORTED_GRAIN` (422).\n\n### 4.5.7 Non-goals\n\n- Advanced AI insights; forecasting models (Phase 2+).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 17, "token_count": 236, "hash_short": "1879a0af", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_018", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ormulas (appendix).\n\n### 4.5.6 Error Codes\n\n- `E.ANALYTICS.RANGE_TOO_LARGE` (413), `E.ANALYTICS.UNSUPPORTED_GRAIN` (422).\n\n### 4.5.7 Non-goals\n\n- Advanced AI insights; forecasting models (Phase 2+).\n\n### 4.5.8 Test Hooks\n\n- Fixtures with canonical PRs; regression tests for materialized view refresh; perf tests on wide ranges.\n\n---\n\n## 4.6 Points & Badges (FR-6)\n\n### 4.6.1 Responsibilities\n\n- Deterministic rules to award **points** per activity; cumulative **badges** for milestones.\n- Prevent abuse (rapid duplicates, backdated floods).\n- **Formula inputs (server-side only):** **calories** (if available), **age**, **gender**, **fitness level**, **training frequency**, **RPE**. Clients only see **awarded totals** (not coefficients or weights).\n\n### 4.6.2 State Model\n\n- Event-sourced ledger (`points_events`), derived `points_balance` view.\n- Badge acquisition recorded with criteria snapshot (recomputable).\n\n### 4.6.3 Inputs/Outputs\n\n- **Query points/badges:** filters by period and category", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 18, "token_count": 250, "hash_short": "abbaa830", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_019", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "points_events`), derived `points_balance` view.\n- Badge acquisition recorded with criteria snapshot (recomputable).\n\n### 4.6.3 Inputs/Outputs\n\n- **Query points/badges:** filters by period and category.\n- **Awarding:** occurs on session completion or specific triggers.\n\n### 4.6.4 Permissions\n\n- **User:** read-only; cannot directly modify points.\n- **Admin:** can correct with audit reason (rare; via support tooling).\n\n### 4.6.5 Constraints\n\n- Idempotent awarding keyed by `(user_id, source_event_id)`.\n- Anti-cheat: rate limit of backfills; anomaly alerts on unusual spikes.\n\n### 4.6.6 Error Codes\n\n- `E.POINTS.DUPLICATE_EVENT` (409), `E.BADGE.ALREADY_GRANTED` (409).\n\n### 4.6.7 Non-goals\n\n- Marketplace or redemption store (Phase 2+).\n\n### 4.6.8 Test Hooks\n\n- Golden rules table; property checks; idempotent replay suite for ledger.\n\n---\n\n## 4.7 Feed, Sharing and social interactions (FR-7)\n\n### 4.7.1 Responsibilities\n\n- Optional **public** or **link-only** sharing of sessions/achievements.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 19, "token_count": 248, "hash_short": "0b1694d7", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_020", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ks; idempotent replay suite for ledger.\n\n---\n\n## 4.7 Feed, Sharing and social interactions (FR-7)\n\n### 4.7.1 Responsibilities\n\n- Optional **public** or **link-only** sharing of sessions/achievements.\n- **Social interactions**: like/unlike; bookmark/unbookmark; **comments CRUD** (non-real-time).\n- **Follow/unfollow** users; follower/following counts.\n- **Leaderboards**: server-side aggregates (e.g., weekly/monthly points).\n- Feed timeline for the user (own items + explicitly followed/public sources in Phase 2).\n\n### 4.7.2 Privacy Model\n\n- Default **private**; user must opt-in per item to publish.\n- Share link tokens are unguessable; revokeable; expireable.\n- visibility `ENUM('private','link','public')` on `sessions`.\n- public items may appear in feed subject to policy.\n- No IDOR: every read checks `subject→viewer` relation + visibility.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 20, "token_count": 211, "hash_short": "814c2690", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_021", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "le; expireable.\n- visibility `ENUM('private','link','public')` on `sessions`.\n- public items may appear in feed subject to policy.\n- No IDOR: every read checks `subject→viewer` relation + visibility. (Extends ADR-010.)\n- `DELETED(TOMBSTONE)` for moderation traceability\n- **Contract guardrails**:\n  - Link access: `GET /sessions/:id?token=...` requires a live token; revoke → `404`.\n  - Privacy switch is not retroactive; past unauthorized viewers never gain access. Events:\n    - `session.visibility_changed` → invalidates feed/materialized views.\n  - Negative tests live in QA (AC-7.1, AC-7.4).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 21, "token_count": 149, "hash_short": "b61a78a6", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_022", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "tch is not retroactive; past unauthorized viewers never gain access. Events:\n    - `session.visibility_changed` → invalidates feed/materialized views.\n  - Negative tests live in QA (AC-7.1, AC-7.4).\n\n### 4.7.3 Inputs/Outputs\n\n- Feed & Publishing\\*\\*\n  - Publish/unpublish: toggle with visibility scope\n  - List feed: paginated; minimal safe fields; no PII by default\n- Likes\n  - Like: `POST /feed/item/:id/like` (idempotent)\n  - Unlike: `DELETE /feed/item/:id/like`\n  - Get likes count: included in feed item metadata\n- Bookmarks\n  - Bookmark session: `POST /sessions/:id/bookmark` (idempotent)\n  - Unbookmark: `DELETE /sessions/:id/bookmark`\n  - List bookmarks: `GET /users/me/bookmarks`\n- Comments\n  - List comments: `GET /feed/item/:id/comments` (paginated, public if item is public)\n  - Add comment: `POST /feed/item/:id/comments` with `{ body: string }` (idempotent via key)\n  - Delete comment: `DELETE /comments/:commentId` (owner or item owner only)\n- Comments support: plain text only (MVP), 500 char max, no nested replies\n- Follow/Unfollow\n  - Follow user: `POST /users/:alias/follow`\n  - Unfollow user: `DELETE /users/:alias/follow`\n  - Get followers: `GET /users/:alias/followers` (counts + list if permitted)\n  - Get following: `GET /users/:alias/following`\n- Leaderboards\n  - Global/Friends leaderboard: `GET /leaderboards?type={global|friends}&period={week|month}`\n  - Returns: `{ rank, user_alias, avatar_url, points, badges_count }`\n  - Cached via materialized view; refresh hourly", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 22, "token_count": 374, "hash_short": "918883d1", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_023", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "iends leaderboard: `GET /leaderboards?type={global|friends}&period={week|month}`\n  - Returns: `{ rank, user_alias, avatar_url, points, badges_count }`\n  - Cached via materialized view; refresh hourly\n\n\n### 4.7.4 Permissions\n\n- **Anonymous:** view items only if public or link-token provided.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 23, "token_count": 72, "hash_short": "8cdc0ad0", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_024", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": ": `{ rank, user_alias, avatar_url, points, badges_count }`\n  - Cached via materialized view; refresh hourly\n\n\n### 4.7.4 Permissions\n\n- **Anonymous:** view items only if public or link-token provided.\n- **User:**\n  - view own + subscribed/public\n  - can like/bookmark/comment on public items\n  - delete own comments\n  - Follow/unfollow any public profile\n  - Block users (hides their content from feed)\n- **Admin**: moderation metadata only; content access via explicit audit\n\n### 4.7.5 Constraints & Safety\n\n- Like/bookmark actions are **idempotent** (repeated calls = 200 OK)\n- Comment body: max 500 chars, plain text, no HTML\n- Rate limits:\n  - Likes/bookmarks: 100 per 5 min per user\n  - Comments: 20 per hour per user\n  - Follow: 50 per day per user\n- Abuse prevention: auto-hide comments with flagged keywords (configurable)\n- Takedown workflow: report → review → unpublish/delete\n\n### 4.7.6 Error Codes\n\n- `E.FEED.NOT_PUBLIC` (403),\n- `E.FEED.TOKEN_INVALID` (401/404),\n- `E.FEED.RATE_LIMITED` (429),\n- `E.SOCIAL.ALREADY_LIKED` (409)\n- `E.SOCIAL.NOT_LIKED` (404)\n- `E.SOCIAL.ALREADY_FOLLOWING` (409)\n- `E.SOCIAL.CANNOT_FOLLOW_SELF` (422)\n- `E.SOCIAL.COMMENT_TOO_LONG` (422)\n- `E.SOCIAL.COMMENT_FORBIDDEN` (403)", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 24, "token_count": 303, "hash_short": "cc018f40", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_025", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "L.ALREADY_LIKED` (409)\n- `E.SOCIAL.NOT_LIKED` (404)\n- `E.SOCIAL.ALREADY_FOLLOWING` (409)\n- `E.SOCIAL.CANNOT_FOLLOW_SELF` (422)\n- `E.SOCIAL.COMMENT_TOO_LONG` (422)\n- `E.SOCIAL.COMMENT_FORBIDDEN` (403)\n\n\n### 4.7.7 Non-goals\n\n- Real-time notifications (polling acceptable)\n- Hashtags/discovery search\n- Nested comment threads\n- Emoji reactions (only like)\n\n### 4.7.8 Test Hooks\n\n- Visibility matrix: test all (viewer_role, item_visibility) combinations\n- Token lifecycle: create → access → revoke → verify 404\n- Idempotency: duplicate like/bookmark calls\n- Follow reflexivity: cannot follow self\n\n---\n\n## 4.8 Internationalization (FR-8)\n\n### 4.8.1 Responsibilities\n\n- Provide **static token dictionaries** for EN/DE with CI coverage checks.\n- Locale negotiation via `Accept-Language` + user profile; fallback to EN.\n- **Out of scope:** Dynamic AI translation of user-generated content.\n- Provide **locale hints** in backend responses for dates/number formatting when useful for FE.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 25, "token_count": 244, "hash_short": "955dcf33", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_026", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "+ user profile; fallback to EN.\n- **Out of scope:** Dynamic AI translation of user-generated content.\n- Provide **locale hints** in backend responses for dates/number formatting when useful for FE.\n\n### 4.8.2 Data & Caching\n\n- Token catalogs versioned; coverage threshold enforced in CI.\n\n### 4.8.3 Inputs/Outputs\n\n- **Locale negotiation:** `Accept-Language` + user profile setting; fallback to EN.\n- **Token delivery:** FE bundles; API returns plain strings + optional i18n keys where relevant to FE rendering.\n\n### 4.8.4 Permissions\n\n- Public data unaffected; user can set preferred locale in profile.\n\n### 4.8.5 Constraints\n\n- All user-facing strings must exist in token catalogs; missing-key detector in CI.\n\n### 4.8.6 Error Codes\n\n- `E.I18N.MISSING_TOKEN` (500 in dev; logged and masked in prod).\n\n### 4.8.7 Non-goals\n\n- Dynamic AI translation of user content.\n\n### 4.8.8 Test Hooks\n\n- Snapshot tests for token coverage; negotiation tests with varied `Accept-Language` headers.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 26, "token_count": 245, "hash_short": "c42373be", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_027", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "masked in prod).\n\n### 4.8.7 Non-goals\n\n- Dynamic AI translation of user content.\n\n### 4.8.8 Test Hooks\n\n- Snapshot tests for token coverage; negotiation tests with varied `Accept-Language` headers.\n\n---\n\n## 4.9 Cross-Module Considerations\n\n- **Audit logging:** user-id, session-id, action, target, success/failure, no PII content.\n- **Search:** consistent pagination and sorting semantics.\n- **Consistency:** eventual for analytics; strong for transactional writes.\n- **Feature flags:** 2FA, global exercise moderation queue, feed public discovery.\n\n---\n\n# 5. Cross-Cutting Concerns\n\nThis section defines system-wide contracts and guardrails that apply to **every module and endpoint**.\n\n---\n\n## 5.1 Security Architecture\n\n### 5.1.1 Authentication & Tokens\n\n- **Access token**: JWT RS256, short-lived (e.g., 15 min), audience=`fitvibe-api`, issuer=`fitvibe`.\n- **Refresh token**: JWT RS256, longer-lived (e.g., 14 d), bound to a **session id** and **client fingerprint** (device hints).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 27, "token_count": 246, "hash_short": "11ec0dbc", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_028", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": ", short-lived (e.g., 15 min), audience=`fitvibe-api`, issuer=`fitvibe`.\n- **Refresh token**: JWT RS256, longer-lived (e.g., 14 d), bound to a **session id** and **client fingerprint** (device hints). Rotated on every refresh.\n- **Rotation & Revocation**: reuse-detected refresh invalidates the session family; access tokens are not revoked individuallyâ€”server consults session store for refresh validity.\n- **2FA (TOTP)**: optional via feature flag; backup codes stored hashed; rate-limited verification.\n- **Key management**: JWKS endpoint (internal); private keys stored via secrets manager; **key rotation** documented in §12 (Runbooks).\n\n### 5.1.2 Authorization & RBAC\n\n- Roles: `anonymous`, `user`, `admin`.\n- Resources secured with explicit role checks; `admin` required for global exercise library CRUD and moderation routes.\n- Claims: `sub`, `role`, `sid` (session id), `iat`, `exp`.\n\n### 5.1.3 Transport, Sessions & Cookies\n\n- All API traffic via **HTTPS** only;\n- HSTS enforced at edge.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 28, "token_count": 249, "hash_short": "2be54b61", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_029", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "library CRUD and moderation routes.\n- Claims: `sub`, `role`, `sid` (session id), `iat`, `exp`.\n\n### 5.1.3 Transport, Sessions & Cookies\n\n- All API traffic via **HTTPS** only;\n- HSTS enforced at edge.\n- TLS 1.3 with OCSP stapling\n- Default is **Authorization: Bearer <JWT>**; if cookies used for web, mark **HttpOnly, Secure, SameSite=Lax/Strict** and use double-submit CSRF token on state-changing requests.\n\n### 5.1.4 CSRF, CORS & Headers\n\n- **CSRF**: not applicable for pure Bearer; cookie mode uses synchronizer token + SameSite.\n- **CORS**: explicit allow-list of origins; block wildcard; allow credentials only when necessary.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 29, "token_count": 157, "hash_short": "89e5a4b4", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_030", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "Headers\n\n- **CSRF**: not applicable for pure Bearer; cookie mode uses synchronizer token + SameSite.\n- **CORS**: explicit allow-list of origins; block wildcard; allow credentials only when necessary.\n- **Security Headers** (example NGINX/SaaS edge):\n  ```nginx\n  add_header Content-Security-Policy \"default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; frame-ancestors 'none'; base-uri 'self'\" always;\n  add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n  add_header Referrer-Policy \"no-referrer\" always;\n  add_header Permissions-Policy \"geolocation=(), microphone=(), camera=()\" always;\n  add_header X-Content-Type-Options \"nosniff\" always;\n  add_header X-Frame-Options \"DENY\" always;\n  ```\n\n### 5.1.5 Rate Limiting & Abuse Controls\n\n- **Global**: per-IP sliding window, e.g., 300 req/5 min.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 30, "token_count": 224, "hash_short": "a507c14e", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_031", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "_header X-Content-Type-Options \"nosniff\" always;\n  add_header X-Frame-Options \"DENY\" always;\n  ```\n\n### 5.1.5 Rate Limiting & Abuse Controls\n\n- **Global**: per-IP sliding window, e.g., 300 req/5 min.\n- **Auth**: stricter, e.g., 10 login attempts/15 min per account + IP; lockout backoff and alert on spikes.\n- **Write endpoints**: separate lower thresholds; include `Retry-After` header on 429.\n- **Anomaly detection**: flag unusual points or session creation bursts (Points FR-6).\n\n### 5.1.6 Upload Safety\n\n- Allow-list MIME types; max sizes (e.g., 5 MB images).\n- **AV scan** (clamd or service) pre-persistence; quarantine on suspicion; hard fail on malware with `E.MEDIA.MALWARE`.\n- Strip EXIF where applicable; generate safe filenames; store outside web root or in S3-compatible bucket with private ACL.\n\n### 5.1.7 Audit & Admin\n\n- **Audit log** event model: `ts`, `user_id`, `sid`, `action`, `target_type/id`, `outcome`, `request_id`; never store raw secrets or payloads.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 31, "token_count": 244, "hash_short": "dd5f9458", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_032", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "tible bucket with private ACL.\n\n### 5.1.7 Audit & Admin\n\n- **Audit log** event model: `ts`, `user_id`, `sid`, `action`, `target_type/id`, `outcome`, `request_id`; never store raw secrets or payloads.\n- **Admin UI** (internal): moderation actions leave signed audit trail.\n- **No user enumeration**: identical responses for existing/non-existing emails in auth flows.\n\n---\n\n## 5.2 Privacy & GDPR\n\n### 5.2.1 Principles\n\n- **Data minimization** and **purpose limitation**; private-by-default for user content.\n- **Lawful basis** documented per category (contract, consent, legitimate interest).", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 32, "token_count": 147, "hash_short": "a737d3bf", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_033", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "R\n\n### 5.2.1 Principles\n\n- **Data minimization** and **purpose limitation**; private-by-default for user content.\n- **Lawful basis** documented per category (contract, consent, legitimate interest).\n\n### 5.2.2 Classification\n\n| Class                 | Examples                             | Handling                                                              |\n| --------------------- | ------------------------------------ | --------------------------------------------------------------------- |\n| **PII-S** (Sensitive) | email, IPs, auth events, 2FA secrets | encrypt at rest where applicable, access controlled, redact from logs |\n| **PII-B** (Basic)     | alias, locale, avatar metadata       | no logs, limited exposure, cached minimally                           |\n| **Usage**             | session metrics, aggregates          | anonymize for telemetry; no per-user labels in metrics                |\n| **Public**            | intentionally published feed items   | removable; still respect takedown and cache purge                     |", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 33, "token_count": 261, "hash_short": "6df3c8cd", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_034", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "for telemetry; no per-user labels in metrics                |\n| **Public**            | intentionally published feed items   | removable; still respect takedown and cache purge                     |\n\n\n### 5.2.3 Retention & Deletion\n\n- Retention matrix per table/field in §6; defaults minimal.\n- **DSR: Export/Delete** flows:\n  - Export: JSON bundle (user, profile, sessions, exercises, points, badges).\n  - Delete: mark as `DELETED` → async purge; propagate to backups within **≤ 14 days**; tombstone for referential integrity.\n- Media: delete object + metadata; purge CDN caches.\n\n### 5.2.4 Consent & Transparency\n\n- Consent required for public publishing and marketing emails.\n- Privacy Policy and data map link surfaced in app.\n\n### 5.2.5 Logging & Telemetry Privacy\n\n- No PII in logs or metric labels. Use opaque IDs.\n- Traces sample rate configured; spans must not include request bodies.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 34, "token_count": 223, "hash_short": "c1eaeac9", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_035", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "and data map link surfaced in app.\n\n### 5.2.5 Logging & Telemetry Privacy\n\n- No PII in logs or metric labels. Use opaque IDs.\n- Traces sample rate configured; spans must not include request bodies.\n\n---\n\n## 5.3 Performance Engineering\n\n### 5.3.1 Budgets & Targets\n\n- **API latency**: p95 < **300 ms**, p99 < 800 ms per route group.\n- **FE**: LCP < **2.5 s** (P75), TBT < 200 ms on representative devices.\n- **Size limits**: JSON responses ≤ 1 MB; request bodies ≤ 2 MB (except media).\n\n### 5.3.2 Timeouts, Retries, Circuit Breakers\n\n- Upstream calls (SMTP, object store) timeout ≤ 3 s; max 2 retries with jittered backoff; no retries for non-idempotent ops.\n- DB statement timeout e.g., 2 s for API paths; longer for maintenance jobs.\n- Circuit breaker around flaky adapters; fallback queues for transient errors.\n\n### 5.3.3 Caching & Compression\n\n- HTTP caching: `ETag`/`Last-Modified` for reads, `Cache-Control: no-store` for private resources.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 35, "token_count": 236, "hash_short": "1d690a32", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_036", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "eaker around flaky adapters; fallback queues for transient errors.\n\n### 5.3.3 Caching & Compression\n\n- HTTP caching: `ETag`/`Last-Modified` for reads, `Cache-Control: no-store` for private resources.\n- Server-side memoization/LRU where hot; Redis optional (Phase 2).\n- Gzip/Brotli at edge; avoid double-compression on proxied assets.\n\n### 5.3.4 Database Performance\n\n- Index policy: each hot query documented in §6 with supporting index.\n- Partition large time-series tables (e.g., sessions) by month; automatic pruning.\n- Materialized views for analytics with incremental refresh jobs.\n\n### 5.3.5 Regression Guards\n\n- CI perf tests (k6) must not regress > **10%** vs baseline per route group.\n- Lighthouse budgets enforced in CI; failing budgets block merge.\n\n---\n\n## 5.4 Observability\n\n### 5.4.1 Logging\n\n- Structured JSON lines: `ts`, `level`, `request_id`, `user_id?`, `sid?`, `route`, `status`, `lat_ms`, `error_code?`.\n- Levels: `debug` (dev only), `info`, `warn`, `error`.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 36, "token_count": 244, "hash_short": "beb288fe", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_037", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "bility\n\n### 5.4.1 Logging\n\n- Structured JSON lines: `ts`, `level`, `request_id`, `user_id?`, `sid?`, `route`, `status`, `lat_ms`, `error_code?`.\n- Levels: `debug` (dev only), `info`, `warn`, `error`.\n- **No PII** or secrets in messages/fields.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 37, "token_count": 60, "hash_short": "e230fd27", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_038", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "lines: `ts`, `level`, `request_id`, `user_id?`, `sid?`, `route`, `status`, `lat_ms`, `error_code?`.\n- Levels: `debug` (dev only), `info`, `warn`, `error`.\n- **No PII** or secrets in messages/fields.\n\n### 5.4.2 Metrics (Prometheus)\n\n| Metric                            | Type      | Labels                      | Notes                |\n| --------------------------------- | --------- | --------------------------- | -------------------- |\n| `http_request_duration_seconds`   | histogram | `method`, `route`, `status` | route templates only |\n| `http_requests_total`             | counter   | `method`, `route`, `status` |                      |\n| `db_query_duration_seconds`       | histogram | `op`, `table`               |                      |\n| `background_job_duration_seconds` | histogram | `job`                       |                      |\n| `rate_limit_events_total`         | counter   | `bucket`                    |                      |\n| `points_awarded_total`            | counter   | `rule`                      | abuse detection      |\n| `av_scan_failures_total`          | counter   | `reason`                    | upload safety        |\n\n**Cardinality policy**: routes are normalized (e.g., `/sessions/:id`), labels are bounded; drop high-cardinality user identifiers", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 38, "token_count": 322, "hash_short": "dbd826b2", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_039", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "| counter   | `reason`                    | upload safety        |\n\n**Cardinality policy**: routes are normalized (e.g., `/sessions/:id`), labels are bounded; drop high-cardinality user identifiers. Bound label sets only; drop labels that exceed 100 unique values in a 10-minute window; never include PII in labels or messages.\n\n### 5.4.3 Tracing\n\n- OpenTelemetry SDK; propagate `traceparent` from edge.\n- Sample rate configurable (e.g., 10% prod, 100% staging).\n- Spans include timing only; mask request/response bodies.\n\n### 5.4.4 Dashboards & Alerts\n\n- **Dashboards**: API latency & error rate, DB health, job queues, uploads AV, perf budgets.\n- **Alerts**: 5xx rate spikes, p95 budget breach, DB saturation, queue backlog, auth lockout anomalies.\n\n---\n\n## 5.5 Accessibility & i18n Responsibilities (Backend Hints)\n\n- Locale negotiation: `Accept-Language` + user setting; FE confirms final rendering locale.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 39, "token_count": 227, "hash_short": "740497b3", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_040", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "queue backlog, auth lockout anomalies.\n\n---\n\n## 5.5 Accessibility & i18n Responsibilities (Backend Hints)\n\n- Locale negotiation: `Accept-Language` + user setting; FE confirms final rendering locale.\n- Server returns **ISO timestamps** and may include **formatting hints** (e.g., `suggestedDateFormat: \"YYYY-MM-DD\"`).\n- Provide **semantic labels** in API only where BE generates strings (emails, system messages) and ensure those strings exist in token catalogs.\n- Bidirectional text safety: store strings as UTF-8; FE renders with `dir` heuristics for RTL locales in future phases.\n\n---\n\n## 5.6 Configuration & Secrets Management\n\n### 5.6.1 Environment Schema\n\n- Validate on boot (zod): required keys fail fast with clear messages.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 40, "token_count": 182, "hash_short": "802d0d8d", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_041", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "dir` heuristics for RTL locales in future phases.\n\n---\n\n## 5.6 Configuration & Secrets Management\n\n### 5.6.1 Environment Schema\n\n- Validate on boot (zod): required keys fail fast with clear messages.\n- Example categories:\n  - **Core**: `NODE_ENV`, `PORT`, `BASE_URL`\n  - **DB**: `DATABASE_URL`\n  - **JWT**: `JWT_PRIVATE_KEY`, `JWT_PUBLIC_KEY`, `JWKS_URL?`\n  - **Mail**: `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS`\n  - **Uploads**: `OBJECT_STORE_URL`, `OBJECT_STORE_BUCKET`\n  - **Security**: `RATE_LIMIT_*`, `CSP_EXTRA_*`\n\n### 5.6.2 Storage & Rotation\n\n- Secrets stored in env/secrets manager; never in VCS or images.\n- JWT keys rotated via JWKS; rollover period documented in §12; old keys kept to validate extant tokens till expiry.\n- Database credentials rotated quarterly or on incident.\n\n### 5.6.3 Feature Flags\n\n- Boolean flags for **2FA**, admin global-exercise moderation, feed public discovery; stored in config table or env; read at startup with hot-reload support where safe.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 41, "token_count": 244, "hash_short": "1cf4b6e4", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_042", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "nt.\n\n### 5.6.3 Feature Flags\n\n- Boolean flags for **2FA**, admin global-exercise moderation, feed public discovery; stored in config table or env; read at startup with hot-reload support where safe.\n\n---\n\n## 5.7 Error Model & Idempotency\n\n### 5.7.1 Error Envelope\n\n```json\n{\n  \"error\": {\n    \"code\": \"E.SCOPE.SPECIFIC_CODE\",\n    \"message\": \"Human-readable short message\",\n    \"details\": { \"field\": \"reason\" },\n    \"requestId\": \"uuid\"\n  }\n}\n```\n\n- Codes are stable; HTTP status aligns with code family; registry in Appendix B.\n\n### 5.7.2 Idempotency Policy\n\n- **Applies to**: POST/PATCH **session creation/updates**, password reset complete, feed publish/unpublish, points correction.\n- Clients send **`Idempotency-Key`** (UUID). Server records hash of request + key; repeats within **24 h** return the original result with `Idempotent-Replay: true`.\n- Storage: `idempotency_keys` table with `key`, `fingerprint`, `status`, `response_hash`, `expires_at`.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 42, "token_count": 238, "hash_short": "56c0f902", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_043", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "quest + key; repeats within **24 h** return the original result with `Idempotent-Replay: true`.\n- Storage: `idempotency_keys` table with `key`, `fingerprint`, `status`, `response_hash`, `expires_at`.\n- Collisions or mismatched payload for same key → 409 `E.IDEMPOTENCY.PAYLOAD_MISMATCH`.\n\n---\n\n## 5.8 Validation (DTO & Environment)\n\n### 5.8.1 DTO Validation\n\n- All inbound requests validated with **zod**: types, min/max, enums, patterns; reject unknown properties.\n- Use shared schemas across FE/BE where feasible; export TypeScript types from schemas.\n\n### 5.8.2 Environment Validation\n\n- On boot, validate env; show masked error summary and exit non-zero if required variables are missing.\n- Provide `.env.example` covering all keys with safe defaults where possible.\n\n---\n\n**Conformance**: This section's controls are **mandatory**. Any deviation requires an ADR and updates to PRD/QA gates.", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 43, "token_count": 223, "hash_short": "a81d913c", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules_chunk_044", "doc_id": ".._.._docs_2.Technical_Design_Document_2b.Technical_Design_Document_Modules", "text": "ovide `.env.example` covering all keys with safe defaults where possible.\n\n---\n\n**Conformance**: This section's controls are **mandatory**. Any deviation requires an ADR and updates to PRD/QA gates.\n\n---\n\n- See also [Tech Stack](./2a.Technical_Design_Document_TechStack.md)\n- See also [Data](./2c.Technical_Design_Document_Data.md)\n- See also [Design & Architecture](./2d.Technical_Design_Document_APIDesign.md)\n- See also [Other](./2e.Technical_Design_Document_misc.md)", "source_file": "../../docs/2.Technical_Design_Document/2b.Technical_Design_Document_Modules.md", "category": "technical", "chunk_index": 44, "token_count": 117, "hash_short": "3e1ee5e5", "version": 1.0, "title": "0. Introduction", "mtime": "2025-10-24T18:57:43.021384", "ingested_at": "2025-11-30T04:00:42.028599", "tags": ["technical", "md"]}
