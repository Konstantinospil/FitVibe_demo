{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log_chunk_000", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log", "text": "# ADR-005 — Partitioning Strategy for `sessions` and `audit_log`\n\n> **File:** docs/adr/ADR-005-partitioning-sessions-and-audit-log.md  \n> **Purpose:** Ensure scalable storage and performant queries for write‑heavy time‑series tables.\n\n---\n\nid: ADR-005\ntitle: \"Partitioning Strategy for sessions & audit_log\"\nstatus: \"Accepted\"\ndate: \"2025-10-14\"\nowners: [\"Dr. Konstantinos Pilpilidis\"]\nversion: \"1.0\"\nlinks:\n\n- PRD: \"docs/1. Product Requirements Document.md#non-functional-requirements-performance\"\n- TDD: \"docs/2. Technical Design Document v2.md#database-schema--modules\"\n- QA: \"docs/3. Testing and Quality Assurance Plan.md#performance-tests\"\n\n---\n\n\n## Context\n\n`core.sessions` (workout logs) and `system.audit_trails` grow linearly with time and are primarily queried by **date ranges** and **user filters**. We need predictable maintenance (vacuum, index bloat control) and fast drop of expired data per retention windows.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-005-partitioning-sessions-and-audit-log.md", "category": "technical", "chunk_index": 0, "token_count": 231, "hash_short": "27f69e5d", "version": 1.0, "title": "ADR-005 — Partitioning Strategy for `sessions` and `audit_log`", "mtime": "2025-10-18T10:54:49.831413", "ingested_at": "2025-11-30T04:00:44.084222", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log_chunk_001", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log", "text": "nearly with time and are primarily queried by **date ranges** and **user filters**. We need predictable maintenance (vacuum, index bloat control) and fast drop of expired data per retention windows.\n\n## Decision\n\nUse **PostgreSQL declarative partitioning** by **month** on `created_at` for both tables. Co‑locate secondary indexes per partition; automate **attach/detach** and retention drops.\n\n### Layout\n\n- Parent tables: `core.sessions`, `system.audit_trails`.\n- Partitions: **monthly**, named `..._pYYYYMM`.\n- Indexes: per partition for `(user_id, created_at)` and GIN/partial where needed.\n- Constraints: CHECK constraints on time bounds for pruning.\n\n### Maintenance\n\n- **Autocreate** next 3 months of partitions.\n- **Detach & drop** partitions older than retention (see ADR‑003).\n- Use `CREATE INDEX CONCURRENTLY` during backfills/reindex.\n- Run `ANALYZE` after heavy loads; monitor `dead_tuples` and bloat.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-005-partitioning-sessions-and-audit-log.md", "category": "technical", "chunk_index": 1, "token_count": 228, "hash_short": "6ca13e6a", "version": 1.0, "title": "ADR-005 — Partitioning Strategy for `sessions` and `audit_log`", "mtime": "2025-10-18T10:54:49.831413", "ingested_at": "2025-11-30T04:00:44.084222", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log_chunk_002", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log", "text": "ons.\n- **Detach & drop** partitions older than retention (see ADR‑003).\n- Use `CREATE INDEX CONCURRENTLY` during backfills/reindex.\n- Run `ANALYZE` after heavy loads; monitor `dead_tuples` and bloat.\n- Avoid cross‑partition FKs; keep FK to `auth.users` at parent or enforce via app logic.\n\n### Query Patterns\n\n- Always filter by time (`created_at BETWEEN ...`) and optionally `user_id`.\n- Ensure the ORM/query layer injects time predicates to trigger pruning.\n- Provide views `v_sessions_recent` and `v_audit_recent` spanning last N months for convenience.\n\n## Consequences\n\n- Large, old data can be dropped quickly (partition drop).\n- Better cache locality and planner performance via pruning.\n- Slight complexity in migrations and index management.\n\n## Alternatives Considered\n\n- **No partitioning**: Degradation over time; slow deletes.\n- **Hash partitioning by user**: Hot‑spot risk and poor date pruning.\n\n## QA & Acceptance\n\n- Tests verify automatic creation and timely drop of partitions.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-005-partitioning-sessions-and-audit-log.md", "category": "technical", "chunk_index": 2, "token_count": 248, "hash_short": "33b034e6", "version": 1.0, "title": "ADR-005 — Partitioning Strategy for `sessions` and `audit_log`", "mtime": "2025-10-18T10:54:49.831413", "ingested_at": "2025-11-30T04:00:44.084222", "tags": ["technical", "md"]}
{"chunk_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log_chunk_003", "doc_id": ".._.._docs_2.Technical_Design_Document_2.f.Architectural_Decision_Documentation_ADR-005-partitioning-sessions-and-audit-log", "text": "ing**: Degradation over time; slow deletes.\n- **Hash partitioning by user**: Hot‑spot risk and poor date pruning.\n\n## QA & Acceptance\n\n- Tests verify automatic creation and timely drop of partitions.\n- Benchmark: range queries (90 days) remain p95 < 200 ms under nominal load.\n- Migration scripts verified on CI with a seeded dataset.\n\n## Backout Plan\n\nIf monthly partitions prove too granular or too coarse, migrate to **quarterly** by creating new parents/partitions and swapping views with minimal downtime.\n\n## Change Log\n\n- **1.0 (2025-10-14)** Initial acceptance.", "source_file": "../../docs/2.Technical_Design_Document/2.f.Architectural_Decision_Documentation/ADR-005-partitioning-sessions-and-audit-log.md", "category": "technical", "chunk_index": 3, "token_count": 142, "hash_short": "25644824", "version": 1.0, "title": "ADR-005 — Partitioning Strategy for `sessions` and `audit_log`", "mtime": "2025-10-18T10:54:49.831413", "ingested_at": "2025-11-30T04:00:44.084222", "tags": ["technical", "md"]}
