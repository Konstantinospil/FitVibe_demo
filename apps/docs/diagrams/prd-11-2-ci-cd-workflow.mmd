flowchart TD
  Dev[Developer] -->|push/PR| Repo[GitHub Repository]

  subgraph CI[Continuous Integration]
    direction TB
    Repo --> Checkout[Checkout Code]
    Checkout --> Install[Install Dependencies + Restore Cache]
    Install --> Lint[Run Lint]
    Lint --> TypeCheck[Run Type Check]
    TypeCheck --> Test[Jest: Run Unit & Integration Tests]
    Test --> Build[Build FE & BE Artifacts]
    Build --> DockerBuild[Build Docker Images]
    DockerBuild --> SecScans[Snyk + Trivy/Grype + Secret Scan]
    SecScans --> SignSBOM[Cosign Sign + SBOM]
    SignSBOM --> PushImages[Push to GHCR: SHA + SemVer + Digest]
    Lint -.->|fail| CI_Fail[âŒ CI Failed]
    TypeCheck -.->|fail| CI_Fail
    Test -.->|fail| CI_Fail
    SecScans -.->|high severity| CI_Fail
  end

  PushImages --> Approval[ðŸ”’ Manual Approval Required]

  subgraph CD[Continuous Deployment]
    direction TB
    Approval --> Deploy[Deploy Job]
    Deploy --> Runner[GitHub Runner / SSH to Host]
    Runner --> Pull[Pull Signed Digests from GHCR]
    Pull --> BlueGreen[Blueâ€‘Green / Rolling Strategy]
    BlueGreen --> Compose[Run docker compose prod]
    Compose --> DBMigrate[Apply Knex Migrations]
    DBMigrate --> DBTasks[Refresh Materialized Views + Rotate Partitions]
    DBTasks --> HealthCheck[Run Health Checks]
    HealthCheck -->|ok| Services[âœ… Services Updated]
    HealthCheck -.->|fail| Rollback[Rollback to Previous Image]
    Services --> PostOps[Vault Rotation + Metrics + Alerts]
  end
